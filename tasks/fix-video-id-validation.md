# 動画ID接頭辞バリデーションの修正

## 概要

Niconico Mylist Assistant の一括インポート機能において、動画IDのバリデーションが `sm` 接頭辞のみを受け付けている問題を修正する。

ニコニコ動画には `sm` 以外にも、`so`（投稿動画）、`nm`（旧動画）など複数の接頭辞が存在するため、接頭辞のバリデーションを削除し、より柔軟な形式で動画IDを受け付けるようにする。

## 関連情報

-   Issue: 不明（problem_statement から推測）
-   タスクタイプ: サービスタスク（niconico-mylist-assistant）
-   影響範囲: 一括インポート機能（API、UI）

## 現状の問題

### 1. 不正なバリデーションロジック

現在、以下のファイルで `sm` 接頭辞のみを受け付けるバリデーションが実装されている：

-   `services/niconico-mylist-assistant/web/src/app/api/videos/bulk-import/route.ts`
    -   39-50行目: `/^sm\d+$/` の正規表現でバリデーション
-   `services/niconico-mylist-assistant/web/src/app/import/page.tsx`
    -   97行目: UIの説明文が「sm[数字]」のみを案内

### 2. ニコニコ動画の実際の接頭辞

ニコニコ動画には以下のような複数の接頭辞が存在する：

-   `sm` - 通常の投稿動画（Smile Video）
-   `so` - 公式動画（Source Original）
-   `nm` - ニコニコムービーメーカー動画
-   その他にも複数の接頭辞が存在する可能性

## 要件

### 機能要件

-   FR1: 動画IDのバリデーションから接頭辞チェック（`sm` のみ）を削除する
-   FR2: 数字のみの動画ID、または任意の英字接頭辞 + 数字の組み合わせを許可する
-   FR3: 既存の他のバリデーション（配列チェック、空チェック、100件制限）は維持する
-   FR4: UIの説明文を更新し、より正確な入力例を提示する

### 非機能要件

-   NFR1: 既存のE2Eテストが引き続き動作すること
-   NFR2: エラーメッセージは日本語で、既存の `ERROR_MESSAGES` 定数を使用すること
-   NFR3: バリデーションロジックの変更はサーバーサイド（API）とクライアントサイド（UI）の両方に適用すること
-   NFR4: TypeScript strict mode に準拠すること

## 実装方針

### 1. バリデーションロジックの変更

現在の正規表現：

```
/^sm\d+$/
```

修正後の正規表現案（柔軟な形式）：

```
/^[a-z]{2}\d+$/
```

または、さらに柔軟に：

```
/^[a-z]+\d+$/
```

**推奨**: `/^[a-z]{2}\d+$/` （2文字の英字接頭辞 + 数字）を採用。理由は以下の通り：

-   ニコニコ動画の実際の接頭辞が2文字である傾向
-   完全にオープンにするとタイポや無効なIDを見逃す可能性
-   適度な柔軟性と安全性のバランス

### 2. エラーメッセージの更新

既存の `ERROR_MESSAGES.INVALID_VIDEO_ID_FORMAT` はそのまま使用可能。
必要に応じて、メッセージ内容を更新することも検討。

### 3. UIガイダンスの更新

-   `page.tsx` の説明文を「sm[数字]」から「sm, so, nm など + 数字」に変更
-   プレースホルダーも複数の接頭辞を含む例に更新

## タスク

### Phase 1: コード修正

-   [ ] T001: バリデーション正規表現の修正
    -   ファイル: `services/niconico-mylist-assistant/web/src/app/api/videos/bulk-import/route.ts`
    -   変更箇所: 40行目の正規表現を `/^sm\d+$/` から `/^[a-z]{2}\d+$/` に変更
-   [ ] T002: UI説明文の更新
    -   ファイル: `services/niconico-mylist-assistant/web/src/app/import/page.tsx`
    -   変更箇所: 97行目の説明文を更新
    -   例: 「ニコニコ動画の動画 ID（sm9, so12345, nm98765 など）を入力してください」

### Phase 2: テストの更新

-   [ ] T003: E2Eテストの確認と必要に応じた修正
    -   ファイル: `services/niconico-mylist-assistant/web/e2e/bulk-import.spec.ts`
    -   既存テストが引き続き動作することを確認
    -   必要に応じて、`so` や `nm` 接頭辞のテストケースを追加
-   [ ] T004: バリデーションテストの拡充
    -   新しい接頭辞（`so`, `nm`）が正常に受け入れられることを検証
    -   無効な形式（数字のみ、接頭辞なし、特殊文字等）が拒否されることを検証

### Phase 3: 動作確認

-   [ ] T005: ローカル環境での手動テスト
    -   複数の接頭辞（`sm`, `so`, `nm`）で動画IDをインポートできることを確認
    -   UIの説明文が正しく表示されることを確認
-   [ ] T006: エラーケースの確認
    -   無効な形式のIDでエラーメッセージが適切に表示されることを確認

### Phase 4: ドキュメント更新（必要に応じて）

-   [ ] T007: 関連ドキュメントの確認
    -   `docs/services/niconico-mylist-assistant/` 配下に機能説明があれば更新

## テスト方針

### テストカバレッジ

-   変更箇所はAPIルート（`route.ts`）のみのため、既存のE2Eテストで十分カバー可能
-   新しい接頭辞のテストケースを追加することで、カバレッジを維持・向上

### テストレベル

-   **E2Eテスト**: 既存のテストスイート（`bulk-import.spec.ts`）で検証
-   **手動テスト**: 開発環境で実際の動作を確認

### 受け入れ基準

-   `sm`, `so`, `nm` 接頭辞の動画IDが正常にインポートできる
-   既存の `sm` 接頭辞のテストが引き続き合格する
-   無効な形式（英字のみ、数字のみ、特殊文字等）は適切にエラーとなる
-   UIの説明文が正確に更新されている

## 参考ドキュメント

-   [コーディング規約](../../docs/development/rules.md) - TypeScript strict mode、エラーメッセージの日本語化
-   [テスト戦略](../../docs/development/testing.md) - E2Eテストの実行方法
-   [niconico-mylist-assistant アーキテクチャ](../../docs/services/niconico-mylist-assistant/architecture.md)

## 備考・未決定事項

### 正規表現の選択肢

以下の選択肢を検討：

1.  `/^[a-z]{2}\d+$/` - 2文字の英字接頭辞 + 数字（推奨）
2.  `/^[a-z]+\d+$/` - 1文字以上の英字接頭辞 + 数字（より柔軟）
3.  `/^\w+$/` - 完全にオープン（英数字とアンダースコア）

**推奨**: オプション1（`/^[a-z]{2}\d+$/`）を採用。
理由: 適度な柔軟性とバリデーションのバランスが良い。

### エラーメッセージの更新要否

現在のエラーメッセージ「不正な動画 ID 形式が含まれています」はそのまま使用可能。
より具体的にする場合は、`ERROR_MESSAGES.INVALID_VIDEO_ID_FORMAT` の値を更新することも検討。

例: 「不正な動画 ID 形式が含まれています（英字2文字 + 数字の形式で入力してください）」

### 将来的な拡張

-   ニコニコ動画APIが動画IDを検証する段階で不正なIDは弾かれるため、クライアント側のバリデーションは緩めでも問題ない可能性
-   将来的に、接頭辞のホワイトリストを持つことも検討可能（ただし、メンテナンスコストが増える）
