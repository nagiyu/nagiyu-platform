# Stock Tracker アラート機能のリファクタリング - パーセンテージ選択機能の追加

## 概要

Stock Tracker のアラート機能に、所持している株価から自動的にアラート閾値を計算する機能を追加する。現在は手入力のみだが、保有株価に対する相対的な増減率（-20% ～ +20%、5%刻み）で選択できるようにし、ユーザビリティを向上させる。

## 関連情報

- **Issue**: [Refactor] Stock Tracker のアラートを所持金額から計算できるようにする
- **タスクタイプ**: サービスタスク（stock-tracker）
- **対象コンポーネント**: `services/stock-tracker/web/components/AlertSettingsModal.tsx`
- **関連ページ**: `services/stock-tracker/web/app/holdings/page.tsx`

## 要件

### 機能要件（FR）

#### FR1: パーセンテージ選択モードの追加

- 単一条件モードと範囲指定モードの両方において、「手動入力」と「パーセンテージ選択」の2つの入力方式を選択可能にする
- パーセンテージ選択時は、基準価格（保有株の平均取得価格）から自動的に目標価格を計算する
- Buy/Sell 両方のモードでパーセンテージ選択を利用可能にする
- ウォッチリストからの利用時など、基準価格が取得できない場合はパーセンテージ選択を無効化する

#### FR2: パーセンテージ選択肢の実装

- 選択可能なパーセンテージ範囲: -20% ～ +20%
- 選択刻み: 5%
- 具体的な選択肢: -20%, -15%, -10%, -5%, 0%, +5%, +10%, +15%, +20%

#### FR3: 目標価格の自動計算

- パーセンテージ選択時、以下の計算式で目標価格を算出:
    - `目標価格 = 基準価格 × (1 + 選択パーセンテージ / 100)`
- 例: 基準価格が100円、+20%選択時 → 目標価格は120円

#### FR4: リアルタイム表示

- パーセンテージ選択時、計算された目標価格をリアルタイムでユーザーに表示する
- 表示例: 「基準価格: 100.00円 → 目標価格: 120.00円 (+20%)」

#### FR5: 既存機能の保持

- 手動入力モードは引き続き利用可能
- 範囲指定モード（range）は既存のまま維持
- 既存のバリデーションルール（0.01 ～ 1,000,000）を継承

### 非機能要件（NFR）

#### NFR1: 型安全性

- TypeScript strict mode で実装
- 新しいフォームフィールドに適切な型定義を追加

#### NFR2: テストカバレッジ

- テストカバレッジ 80% 以上を維持
- パーセンテージ計算ロジックのユニットテスト必須
- E2Eテストで実際のUI操作をテスト（chromium-mobile）

#### NFR3: エラーハンドリング

- エラーメッセージは日本語で `ERROR_MESSAGES` オブジェクトに定数化
- 基準価格が未設定の場合の適切なエラー処理

#### NFR4: UI/UX

- 既存のMaterial-UIデザインシステムに準拠
- レスポンシブデザイン（モバイルファーストの原則）
- アクセシビリティを考慮したフォーム設計

#### NFR5: 後方互換性

- 既存のアラート設定データに影響を与えない
- APIリクエストの構造は変更しない（内部計算のみ）

## 実装のヒント

### UI設計の方針

1. **入力方式選択**: 単一条件モードと範囲指定モードの両方に「入力方式」ドロップダウンを追加
    - 選択肢: 「手動入力」「パーセンテージ」
    - デフォルトは「手動入力」（既存の動作を保持）
    - 注意: Buy/Sell モードに関わらず、両方のモードでパーセンテージ選択を利用可能にする
    - 範囲指定モードでは、最小価格（下限）と最大価格（上限）の両方にパーセンテージ選択を適用

2. **パーセンテージ選択**: Material-UI の `Select` コンポーネントを使用
    - 9つの選択肢を `MenuItem` で実装
    - 選択肢のラベルには `%` を含める（例: 「+20%」「-10%」）

3. **目標価格表示**: `TextField` の `helperText` または独立した `Typography` で表示
    - 計算結果と計算式を分かりやすく提示
    - 例: 「100.00円 × 1.20 = 120.00円」

### フォームデータの拡張

現在の `FormData` インターフェースに以下を追加:

```typescript
interface FormData {
    // 既存のフィールド
    conditionMode: 'single' | 'range';
    operator: 'gte' | 'lte';
    targetPrice: string;
    minPrice: string;
    maxPrice: string;
    // ...

    // 追加するフィールド
    inputMode?: 'manual' | 'percentage'; // 入力方式（単一条件用）
    percentage?: string; // 選択されたパーセンテージ（単一条件用、-20 ～ +20）
    
    // 範囲指定モード用の追加フィールド
    rangeInputMode?: 'manual' | 'percentage'; // 範囲指定の入力方式
    minPercentage?: string; // 最小価格のパーセンテージ（-20 ～ +20）
    maxPercentage?: string; // 最大価格のパーセンテージ（-20 ～ +20）
}
```

### 計算ロジックの実装

パーセンテージから目標価格を計算するユーティリティ関数を作成:

```typescript
// 概念例（実際のコードではない）
function calculateTargetPriceFromPercentage(
    basePrice: number,
    percentage: number
): number {
    // basePrice × (1 + percentage / 100)
    // 結果は小数点第2位まで
}
```

### バリデーション追加

- `inputMode` が `'percentage'` の場合、`percentage` フィールドが必須
- `basePrice`（基準価格）が未設定（`undefined`）または 0 以下の場合:
    - パーセンテージ選択モードを無効化または非表示にする
    - 適切なエラーメッセージまたは説明を表示する
- 計算結果が有効な価格範囲（0.01 ～ 1,000,000）内であることを確認

### テスト方針

#### ユニットテスト

- パーセンテージ計算関数のテスト
    - 正常系: 各パーセンテージでの正確な計算結果
    - 異常系: 不正な基準価格、範囲外のパーセンテージ
- バリデーション関数のテスト
- フォーム状態管理のテスト

#### E2Eテスト

- 保有株一覧ページからアラート設定を開く
- 入力方式で「パーセンテージ」を選択
- 各パーセンテージを選択し、目標価格が正しく計算されることを確認
- アラート作成が成功することを確認

## タスク

### Phase 1: 準備と調査

- [x] 既存のアラート設定機能の仕様を確認
- [ ] `AlertSettingsModal.tsx` のコード構造を理解
- [ ] `holdings/page.tsx` から渡される `defaultTargetPrice` の仕組みを確認
- [ ] テスト環境のセットアップ確認

### Phase 2: フォームデータとインターフェースの拡張

- [ ] `FormData` インターフェースに `inputMode` と `percentage` を追加
- [ ] パーセンテージ選択肢の定数配列を定義（-20 ～ +20、5%刻み）
- [ ] `getInitialFormData` 関数を更新して新しいフィールドのデフォルト値を設定
- [ ] 型定義の追加に伴うコンパイルエラーを解消

### Phase 3: 計算ロジックの実装

- [ ] パーセンテージから目標価格を計算するヘルパー関数を作成
- [ ] 計算結果のフォーマット処理を実装（小数点第2位まで）
- [ ] ビジネスロジックの単体テストを作成（80%以上のカバレッジ）

### Phase 4: UI実装

- [ ] 単一条件モード内に「入力方式」選択ドロップダウンを追加
- [ ] 「手動入力」モード時は既存の `TextField` を表示
- [ ] 「パーセンテージ」モード時はパーセンテージ選択ドロップダウンを表示
- [ ] 選択されたパーセンテージから目標価格を計算し、リアルタイムで表示
- [ ] 表示形式を分かりやすく整える（基準価格、計算式、目標価格）
- [ ] 範囲指定モード内にも「入力方式」選択ドロップダウンを追加
- [ ] 範囲指定モードの「パーセンテージ」モード時は、最小価格と最大価格の両方にパーセンテージ選択を表示
- [ ] 範囲指定モードでパーセンテージ選択時、計算された価格範囲をリアルタイムで表示

### Phase 5: バリデーションとエラーハンドリング

- [ ] `validateForm` 関数を拡張してパーセンテージモードに対応（単一条件・範囲指定両方）
- [ ] 基準価格が未設定または不正な場合のエラーメッセージを追加
- [ ] 計算結果が価格範囲外の場合のバリデーション追加
- [ ] 範囲指定モードでパーセンテージ選択時、最小価格 < 最大価格であることを確認
- [ ] `ERROR_MESSAGES` にエラーメッセージを日本語で追加

### Phase 6: テスト実装

- [ ] ユニットテスト作成:
    - [ ] パーセンテージ計算関数のテスト
    - [ ] バリデーション関数のテスト（単一条件・範囲指定両方）
    - [ ] フォーム状態管理のテスト
- [ ] E2Eテスト作成:
    - [ ] 単一条件モードでのパーセンテージ選択フローのテスト
    - [ ] 範囲指定モードでのパーセンテージ選択フローのテスト
    - [ ] 目標価格計算の正確性テスト
    - [ ] アラート作成の成功テスト
- [ ] テストカバレッジが80%以上であることを確認

### Phase 7: 検証とデプロイ準備

- [ ] ローカル環境でのマニュアルテスト
- [ ] 既存のアラート設定機能が正常動作することを確認
- [ ] Lint/Prettierを実行してコードスタイルを統一
- [ ] ドキュメント更新（該当する場合）
- [ ] PR作成とレビュー依頼

## 受け入れ基準

以下の全てを満たすこと:

1. [ ] パーセンテージ選択モードが実装され、-20% ～ +20% の範囲を5%刻みで選択可能
2. [ ] 選択したパーセンテージから目標価格が正確に計算される
3. [ ] 計算結果がUI上にリアルタイムで分かりやすく表示される
4. [ ] Buy/Sell 両方のモードでパーセンテージ選択が正常に動作する
5. [ ] 単一条件モードでパーセンテージ選択が正常に動作する
6. [ ] 範囲指定モードでパーセンテージ選択が正常に動作する（最小価格・最大価格の両方）
7. [ ] 既存の手動入力モードが引き続き正常に動作する（単一条件・範囲指定両方）
8. [ ] ウォッチリストからアラート設定を開いた場合、基準価格がないためパーセンテージ選択が適切に無効化される
9. [ ] テストカバレッジが80%以上
10. [ ] E2Eテストが全てのデバイス（chromium-mobile含む）でパス
11. [ ] TypeScript strict mode でコンパイルエラーなし
12. [ ] ESLintとPrettierのチェックがパス
13. [ ] エラーメッセージが日本語で `ERROR_MESSAGES` に定数化されている

## 参考ドキュメント

- [コーディング規約](../../docs/development/rules.md) - TypeScript strict mode、エラーメッセージの日本語化等
- [アーキテクチャ方針](../../docs/development/architecture.md) - UI層とビジネスロジックの分離
- [テスト戦略](../../docs/development/testing.md) - テストカバレッジ要件、E2Eテスト方針
- [Stock Tracker アーキテクチャ](../../docs/services/stock-tracker/architecture.md) - サービス固有の設計方針
- [Stock Tracker 要件定義](../../docs/services/stock-tracker/requirements.md) - サービスの全体要件

## 備考・未決定事項

### 考慮事項

- **基準価格の扱い**: 現在 `defaultTargetPrice` は平均取得価格の1.2倍で渡されているが、パーセンテージ計算の基準として使用する際は元の平均取得価格（`averagePrice`）を直接渡す必要がある
    - `holdings/page.tsx` から `AlertSettingsModal` への props 追加を検討: `basePrice?: number`

- **ウォッチリストからの利用**: `AlertSettingsModal` は保有株ページ（`holdings/page.tsx`）だけでなく、ウォッチリストページ（`watchlist/page.tsx`）からも呼び出される
    - ウォッチリストからは所持ティッカー情報が取得できないため、基準価格（`basePrice`）が存在しない
    - 基準価格が未設定の場合は、パーセンテージ選択モードを無効化または非表示にする
    - UIでは「パーセンテージ選択は保有株からのみ利用可能です」などの説明を表示する

- **デフォルト動作**: 既存ユーザーへの影響を最小化するため、デフォルトは「手動入力」モードとする

- **範囲指定モードでのパーセンテージ選択**: 範囲指定モード（range）においても、最小価格と最大価格の両方にパーセンテージ選択を適用可能にする
    - 例: 基準価格100円、最小価格-10%、最大価格+10% → 範囲 90円～110円
    - 範囲内（inside）/範囲外（outside）の両方のタイプで利用可能

### 今後の拡張候補

- カスタムパーセンテージの入力（-20% ～ +20%外の値）
- パーセンテージのプリセット保存機能
- 複数のパーセンテージアラートの一括設定
- 範囲指定モードでの非対称なパーセンテージ設定（例: 最小価格は手動入力、最大価格はパーセンテージ）

### 技術的な注意点

- `defaultTargetPrice` は現在 `averagePrice * 1.2` で計算されているため、パーセンテージ計算の基準として直接使用できない
- 正確な計算のため、`averagePrice` を直接 props で受け取るか、`defaultTargetPrice` から逆算する必要がある
- 小数点の丸め処理に注意（一貫性のある丸め方法を使用）
- **ウォッチリストからの利用時**: `basePrice` が `undefined` または未設定の場合の条件分岐を実装し、パーセンテージ選択UIを適切に制御する必要がある
