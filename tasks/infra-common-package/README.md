# インフラ共通パッケージ化プロジェクト

## 概要

インフラストラクチャコードの共通化を推進し、`@nagiyu/infra-common` パッケージを新設するプロジェクトです。モノレポの利点を活かし、CDKスタック実装の重複を排除し、メンテナンス性と一貫性を向上させます。

## 現状の問題

- 各サービス（tools, auth, admin, codec-converter）でECR/Lambda/CloudFrontスタックの実装が重複
- リソース命名規則が統一されていない（`tools-app-{env}`, `nagiyu-auth-{env}` 等）
- セキュリティヘッダーの適用がサービスによって異なる（Auth/Adminのみ適用）
- デフォルト設定が各所に散在し、変更時の影響範囲が広い
- `infra/shared/` の役割が曖昧（共有リソース + ユーティリティが混在）

## 目標

1. `@nagiyu/infra-common` パッケージの新設
2. 共通スタック実装（ECR, Lambda, CloudFront等）の提供
3. リソース命名規則の統一
4. セキュリティ設定（ヘッダー等）の標準化
5. 型安全な設定管理の実現
6. コード削減（推定50-60%削減）

## プロジェクト構成

このプロジェクトは以下のフェーズで構成されています：

### Phase 1: 基盤構築
- パッケージ作成と型定義
- 命名規則・デフォルト値の定義
- ユーティリティ実装

### Phase 2: 共通スタック実装
- ECRStackBase の実装
- LambdaStackBase の実装
- CloudFrontStackBase の実装

### Phase 3: 既存サービス移行
- tools サービスの移行
- auth サービスの移行
- admin サービスの移行
- codec-converter サービスの移行

### Phase 4: 高度な機能
- ServiceStackBuilder（ビルダーパターン）
- L3 Constructs（再利用可能な部品）
- 包括的なテスト

### Phase 5: ドキュメント整備
- 使用ガイド作成
- サンプルコード追加
- 移行ガイド作成

## 関連ドキュメント

### プロジェクト全体
- [プロジェクト概要](./overview.md) - プロジェクト全体の詳細説明、背景、フェーズ詳細、技術的考慮事項

### 既存インフラドキュメント
- `docs/infra/` - インフラストラクチャ全般のドキュメント
- `docs/infra/architecture.md` - インフラアーキテクチャ
- `infra/shared/libs/utils/exports.ts` - 既存のExport名定義

### 参考実装
- `infra/codec-converter/` - カスタムロール実装の参考例
- `libs/common/`, `libs/browser/`, `libs/ui/` - アプリケーション側の共通ライブラリ構造

## 進め方

1. Phase 1 から順番に実施することを推奨
2. Phase 2 完了後、Phase 3 で段階的に各サービスを移行
3. 最小構成（MVP）として Phase 1-2 + tools移行のみ実施も可能
4. 既存サービスへの影響を最小化するため、新規リソース名は統一し、既存は維持

## 推定工数

- Phase 1（基盤構築）: 1-2週間
- Phase 2（共通スタック実装）: 2-3週間
- Phase 3（既存サービス移行）: 2-3週間
- Phase 4（高度な機能）: 2-3週間
- Phase 5（ドキュメント整備）: 1週間
- **全フェーズ合計**: 8-12週間

詳細は [overview.md](./overview.md) を参照してください。

## 期待される効果

### コード削減
- **現状**: 各サービス 100-150行/スタック × 4サービス = 400-600行
- **削減後**: 共通実装 200行 + 各サービス設定 15-20行 × 4 = 約280行
- **削減率**: 50-60%

### メンテナンス性向上
- 設定変更が1箇所で完結
- セキュリティ標準の統一適用
- 新規サービス追加が容易（設定ファイルのみ）

### 品質向上
- セキュリティヘッダーの全サービス適用
- 命名規則の統一化
- 型安全な設定管理

## 成功基準

### 必須基準
- [ ] `@nagiyu/infra-common` パッケージが正常に動作する
- [ ] 全サービスが共通スタックを利用できる
- [ ] リソース命名規則が統一されている
- [ ] セキュリティヘッダーが全サービスに適用されている
- [ ] 既存インフラが正常に動作する（破壊的変更なし）
- [ ] CI/CDパイプラインが正常に動作する

### 推奨基準
- [ ] ServiceStackBuilder で簡潔な設定が可能
- [ ] 包括的なテストカバレッジ
- [ ] 充実したドキュメント
- [ ] サンプルコードの提供

## リスクと対策

### リスク1: 既存インフラへの影響
**影響度**: 高
**発生確率**: 中

**対策**:
- 段階的な移行（Phase 3 で1サービスずつ）
- 新規リソース名は統一、既存リソースは維持
- 各ステップでのテスト実施

### リスク2: 設計の柔軟性不足
**影響度**: 中
**発生確率**: 中

**対策**:
- オプショナルなパラメータを多用
- サービス固有の設定を追加可能な仕組み
- codec-converter のような複雑なケースも考慮

### リスク3: 学習コスト
**影響度**: 低
**発生確率**: 高

**対策**:
- 詳細なドキュメント作成
- サンプルコード提供
- 段階的な導入

## 次のステップ

1. このドキュメントをレビュー
2. [プロジェクト概要](./overview.md) で詳細を確認
3. Phase 1 から実装開始
