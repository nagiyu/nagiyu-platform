# niconico-mylist-assistant リスク分析書

本ドキュメントは、[roadmap.md](./roadmap.md) の実装計画に対するリスク分析結果をまとめたものです。

---

## 🔴 高リスク (High Priority)

### 1. ニコニコ動画のHTML構造変更への依存 (Milestone 6)

**リスク内容:**
- Playwright を使用したブラウザ自動化がニコニコ動画のHTML構造に依存
- SPA構造のため予告なく変更される可能性が高い
- セレクタが動作しなくなると Issue 6-1, 6-6 が全て失敗

**影響範囲:**
- [roadmap.md:387-399](./roadmap.md#issue-6-1-batch-playwright-自動化スクリプト実装) - Issue 6-1: Playwright 自動化スクリプト実装
- Milestone 6 全体が影響を受ける

**既存の対策:**
- [architecture.md:843-875](./architecture.md#ニコニコ動画の-html-構造依存) に制約事項として記載済み
- [testing.md:346-376](./testing.md#61-テスト戦略) で統合テストによる定期的な動作確認を計画

**追加推奨対策:**
- 複数の抽出戦略を並行実装 (CSS セレクタ、JSON データ、正規表現)
- UI変更検知時の迅速な対応体制を整備（アラート設定、修正フローの確立）
- セレクタを定数化し、修正時の影響範囲を局所化

**発生確率:** 高
**影響度:** 高
**優先度:** 最優先

---

### 2. AWS Batch の初回構築と動作確認 (Milestone 5)

**リスク内容:**
- 既存実装（Python版）では稼働実績があるが、新プラットフォームでの Batch 構築は初めて
- Fargate + Playwright の環境構築が複雑
- ECR、ジョブ定義、コンピューティング環境の連携に問題が発生する可能性

**影響範囲:**
- [roadmap.md:312-381](./roadmap.md#milestone-5-バッチ基盤構築) - Milestone 5 全体
- Milestone 6 の前提条件（Batch が動作しないとマイリスト登録機能が実装できない）

**既存の対策:**
- Issue 5-5（バッチ実行確認）で動作検証を計画
- 既存の codec-converter の Batch 実装を参考にする方針

**追加推奨対策:**
- Issue 5-5 でダミー処理（簡単なログ出力など）を先に動作確認してから本実装に移行
- Fargate のリソース設定（vCPU, メモリ）を段階的に調整
- ローカル環境での Docker コンテナテストを徹底

**発生確率:** 中
**影響度:** 高
**優先度:** 最優先

---

### 3. 認証情報の暗号化/復号化処理 (Milestone 5 & 6)

**リスク内容:**
- ニコニコアカウントのパスワード暗号化が正しく実装されないとセキュリティ問題
- 暗号化キーの管理ミスでパスワードが復号化できない可能性
- メモリ上での一時保持後の確実な削除が必要

**影響範囲:**
- [roadmap.md:329-340](./roadmap.md#issue-5-2-core-暗号化ユーティリティ実装) - Issue 5-2: 暗号化ユーティリティ実装
- [roadmap.md:431-442](./roadmap.md#issue-6-4-web-マイリスト登録画面-ui-実装) - Issue 6-4: マイリスト登録画面 UI実装
- セキュリティインシデントに直結

**既存の対策:**
- [architecture.md:666-705](./architecture.md#62-データ暗号化) でAES-256-GCMによる暗号化方式を規定
- AWS Secrets Manager でキー管理を計画
- [requirements.md:218-242](./requirements.md#32-セキュリティ要件) でセキュリティ要件を明確化

**追加推奨対策:**
- Issue 5-2 完了後にセキュリティレビューを実施
- ユニットテストで暗号化/復号化の動作を検証 (core パッケージ、カバレッジ必須)
- パスワードのメモリ削除が確実に行われているか確認（メモリダンプテスト）

**発生確率:** 低
**影響度:** 高
**優先度:** 最優先

---

## 🟡 中リスク (Medium Priority)

### 4. DynamoDB Single Table Design の複雑性 (Milestone 2)

**リスク内容:**
- 単一テーブル設計でエンティティを分離 (VIDEO と USER_SETTING)
- パーティションキー/ソートキーの設計ミスでアクセスパターンが非効率になる
- GSI なしでフィルタリングを実装するため、データ量増加時のパフォーマンス劣化

**影響範囲:**
- [roadmap.md:98-158](./roadmap.md#milestone-2-データ基盤構築) - Milestone 2 全体
- [architecture.md:300-423](./architecture.md#41-データベーススキーマ) - データモデル設計

**既存の対策:**
- 既存の stock-tracker の Single Table Design パターンを参考にする方針
- 想定データ量 (1ユーザー1,000件) では全件取得が現実的
- 将来的にGSI追加を視野に入れた設計

**追加推奨対策:**
- Issue 2-4（テストAPI）で実際のデータでパフォーマンステストを実施
- 1,000 件のデータで全件取得の応答時間を測定
- 10,000 件規模でのパフォーマンス劣化を想定し、GSI 追加のしきい値を決定

**発生確率:** 中
**影響度:** 中
**優先度:** 中

---

### 5. ニコニコ動画 API の Rate Limiting (Milestone 2 & 3)

**リスク内容:**
- getthumbinfo API へのリクエスト頻度が高いとブロックされる可能性
- 一括インポート時に並列処理を実装すると過負荷のリスク
- エラーハンドリングが不十分だとインポート失敗が多発

**影響範囲:**
- [roadmap.md:117-129](./roadmap.md#issue-2-2-core-ニコニコ動画-api-クライアント実装) - Issue 2-2: ニコニコ動画 API クライアント実装
- [roadmap.md:165-180](./roadmap.md#issue-3-1-web-動画一括インポート-api-実装) - Issue 3-1: 動画一括インポート API実装

**既存の対策:**
- [requirements.md:199-216](./requirements.md#31-パフォーマンス要件) で動画登録間の待機時間（最低2秒）を規定
- 既存実装のバッチ処理パターン (concurrency: 3) を採用予定
- エラー時もスキップして処理を継続する設計

**追加推奨対策:**
- リトライロジック（最大3回、指数バックオフ）を実装
- API エラー時のログを詳細に記録し、ブロック検知を早期化
- テスト環境で大量リクエストの動作確認を実施

**発生確率:** 中
**影響度:** 中
**優先度:** 中

---

### 6. Next.js Standalone Build の Docker 化 (Milestone 1)

**リスク内容:**
- Next.js 16 + React 19 の組み合わせで Docker ビルドが失敗する可能性
- 既存サービス (tools) を参考にするが、依存関係の違いで問題が発生する可能性
- Lambda のコールドスタート時間が長くなるリスク

**影響範囲:**
- [roadmap.md:54-64](./roadmap.md#issue-1-1-web-dockerfile-作成) - Issue 1-1: Web Dockerfile 作成

**既存の対策:**
- 既存の tools サービスの Dockerfile を基にする方針
- multi-stage build でイメージサイズを最適化

**追加推奨対策:**
- ローカルで Docker ビルド/起動を十分にテスト
- Lambda の環境変数とローカル環境の差異を事前に洗い出し
- コールドスタート時間を測定し、許容範囲内か確認

**発生確率:** 低
**影響度:** 中
**優先度:** 中

---

### 7. Web Push 通知の動作確認 (Milestone 7)

**リスク内容:**
- VAPID キー生成・設定が正しく行われないと通知が送信できない
- ブラウザごとの互換性問題 (Safari, Chrome, Firefox)
- ユーザーが通知許可を拒否した場合のフォールバック処理

**影響範囲:**
- [roadmap.md:517-528](./roadmap.md#issue-7-4-web-push-通知実装) - Issue 7-4: Web Push 通知実装

**既存の対策:**
- 既存の stock-tracker の Web Push 実装を参考にする方針
- 通知失敗時もジョブステータス確認で結果を確認可能に設計

**追加推奨対策:**
- ブラウザごとのテストを E2E で実施
- 通知許可拒否時のユーザー体験を設計（UI でのステータス表示強化）
- VAPID キーの生成手順をドキュメント化

**発生確率:** 低
**影響度:** 中
**優先度:** 中

---

## 🟢 低リスク (Low Priority)

### 8. CI/CD パイプライン構築 (Milestone 1)

**リスク内容:**
- GitHub Actions ワークフローの設定ミスでデプロイが失敗
- ブランチ戦略 (integration/* → develop) の理解不足
- 自動デプロイのトリガー条件が不適切

**影響範囲:**
- [roadmap.md:67-81](./roadmap.md#issue-1-2-github-actions-ワークフロー作成) - Issue 1-2: GitHub Actions ワークフロー作成

**既存の対策:**
- 既存の .github/workflows/ を参考にする方針
- デプロイ検証 (Issue 1-3) で確実に動作確認

**追加推奨対策:**
- 手動デプロイで先に動作確認してから自動化
- デプロイワークフローのドライラン実行

**発生確率:** 低
**影響度:** 低
**優先度:** 低

---

### 9. Material-UI 7 との互換性 (Milestone 3 & 4)

**リスク内容:**
- Material-UI 7 の API が変更されている可能性
- 既存の @nagiyu/ui ライブラリとの統合に問題が発生
- レスポンシブ対応が期待通りに動作しない

**影響範囲:**
- [roadmap.md:183-208](./roadmap.md#issue-3-2-web-インポート画面-ui-実装) - Issue 3-2, 3-3: インポート画面 UI実装
- [roadmap.md:241-283](./roadmap.md#issue-4-2-web-動画一覧画面-ui-実装) - Issue 4-2, 4-4: 動画一覧・詳細 UI実装

**既存の対策:**
- プラットフォーム共通UIライブラリ (@nagiyu/ui) を活用
- E2E テストで UI の動作を検証

**追加推奨対策:**
- Material-UI の公式ドキュメントを参照
- スマホファーストの要件を満たすか、実機テストを実施

**発生確率:** 低
**影響度:** 低
**優先度:** 低

---

### 10. テストカバレッジ 80% 達成 (Milestone 7)

**リスク内容:**
- core パッケージのカバレッジが 80% に満たない
- React 19 + Jest の互換性問題で page コンポーネントのテストができない
- テスト作成に時間がかかりスケジュールに影響

**影響範囲:**
- [roadmap.md:478-514](./roadmap.md#issue-7-1-テスト整備core) - Issue 7-1, 7-2, 7-3: テスト整備

**既存の対策:**
- [testing.md:26-32](./testing.md#13-パッケージ別テスト戦略) で core パッケージに集中してユニットテストを実装する方針
- web / batch は E2E / 統合テストでカバー

**追加推奨対策:**
- カバレッジレポートで未カバー箇所を特定して段階的に追加
- テスト困難なコードは設計を見直す

**発生確率:** 中
**影響度:** 低
**優先度:** 低

---

## 📋 その他の懸念事項

### 11. ロードマップの粒度と見積もり

**懸念内容:**
- 各 Issue が「1〜3日で完了できる粒度」とあるが、初回実装では見積もりが不正確になる可能性
- 並列実装可能なタスクが明記されているが、リソースが不足すると遅延

**推奨対策:**
- 各 Milestone 完了時にレトロスペクティブを実施し、見積もり精度を向上
- 並列実装は可能な範囲で行い、無理に並列化しない
- Issue 完了時に実際の所要時間を記録し、次回の見積もり精度向上に活用

---

### 12. デプロイ駆動開発のリスク

**懸念内容:**
- Milestone 1 完了後、全ての変更が dev 環境に自動デプロイされるため、不完全な実装が本番に近い環境に反映される
- dev 環境での動作確認が不十分だと、本番デプロイ時に問題が発覚

**推奨対策:**
- 各 Issue 完了時に必ず dev 環境で動作確認を実施
- E2E テストで主要フローをカバー
- 本番デプロイ前に Milestone 7 で十分に検証

---

### 13. ドキュメントの整合性維持

**懸念内容:**
- requirements.md, architecture.md, api-spec.md, testing.md, deployment.md が大量に存在
- 実装中に仕様変更が発生した場合、ドキュメントの更新漏れが発生する可能性

**推奨対策:**
- 実装完了後、必要に応じてドキュメントを更新 (ロードマップに明記済み)
- PR レビュー時にドキュメント更新の確認を含める
- 仕様変更が発生した場合は、該当するドキュメントを即座に更新

---

## 🎯 推奨する追加対策

### 1. Milestone 5 完了後のチェックポイント設定

- AWS Batch の動作が確認できてから Milestone 6 に進む
- Issue 5-5 で徹底的にテストを実施（ダミー処理 → 本実装の順）

### 2. HTML構造変更の定期監視

- 統合テスト (batch) を定期的に実行 (週次または CI で自動実行)
- セレクタの動作確認を自動化し、失敗時はアラート

### 3. セキュリティレビューの実施

- Issue 5-2 (暗号化ユーティリティ) 完了後にセキュリティレビューを実施
- パスワードのメモリ削除が確実に行われているか確認（メモリダンプテスト）

### 4. パフォーマンステストの実施

- Issue 2-4 (テストAPI) で DynamoDB のパフォーマンスを確認
- 1,000 件のデータで全件取得の応答時間を測定
- 想定以上にデータ量が増加した場合の対策を検討（GSI追加）

---

## 📊 リスクマトリクス

| リスク                          | 影響度 | 発生確率 | 優先度 | 対策状況 |
|---------------------------------|--------|----------|--------|----------|
| HTML構造変更                    | 高     | 高       | 🔴     | 一部     |
| Batch 構築                      | 高     | 中       | 🔴     | 一部     |
| 暗号化/復号化                   | 高     | 低       | 🔴     | ✅       |
| Single Table Design             | 中     | 中       | 🟡     | ✅       |
| Rate Limiting                   | 中     | 中       | 🟡     | ✅       |
| Docker化                        | 中     | 低       | 🟡     | ✅       |
| Web Push 通知                   | 中     | 低       | 🟡     | ✅       |
| CI/CD パイプライン              | 低     | 低       | 🟢     | ✅       |
| Material-UI 互換性              | 低     | 低       | 🟢     | ✅       |
| テストカバレッジ                | 低     | 中       | 🟢     | ✅       |

---

## まとめ

### ✅ ロードマップの優れている点

1. **デプロイ駆動開発:** 早期から dev 環境で動作確認できる仕組み
2. **段階的な実装:** Milestone 構成により依存関係が明確
3. **既存パターンの活用:** stock-tracker, codec-converter などの実績あるパターンを参考
4. **テスト戦略が明確:** core 80%, E2E, 統合テストの役割分担が適切
5. **セキュリティ対策:** 暗号化、認証、アクセス制御が考慮されている
6. **ドキュメント駆動:** 要件、設計、テスト仕様が事前に整備されている

### ⚠️ 重点的に注意すべきリスク

**最優先対応 (🔴 高リスク):**

1. **ニコニコ動画のHTML構造変更**
   - 定期的な動作確認体制の確立
   - 複数の抽出戦略の実装
   - 迅速な対応フローの整備

2. **AWS Batch の初回構築**
   - Issue 5-5 でダミー処理から段階的に検証
   - ローカル Docker テストの徹底

3. **暗号化処理のセキュリティ**
   - セキュリティレビューの実施
   - ユニットテスト・メモリダンプテストの実施

**継続的な監視が必要 (🟡 中リスク):**

- DynamoDB のパフォーマンス
- ニコニコ動画 API の Rate Limiting
- Web Push 通知のブラウザ互換性

### 📝 総合評価

ロードマップは全体的によく設計されており、リスクに対する基本的な対策も盛り込まれています。本ドキュメントで指摘した追加対策を実施することで、より安全かつ確実に実装を進めることができます。

特に **Milestone 5 (バッチ基盤構築)** と **Milestone 6 (マイリスト自動登録機能)** が最も重要なマイルストーンであり、ここでのリスク管理が成功の鍵となります。

---

**最終更新日:** 2026-01-26
