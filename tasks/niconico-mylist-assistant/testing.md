# niconico-mylist-assistant テスト仕様書

---

## 1. テスト戦略概要

本サービスは、ニコニコ動画のマイリスト登録を自動化する Web アプリケーションであり、以下の特性を持ちます：

- **3パッケージ構成**: core（純粋なビジネスロジック）、web（Next.js UI + API）、batch（AWS Batch + Playwright）
- **長時間実行**: AWS Batch による無制限実行時間のバッチ処理
- **外部API依存**: ニコニコ動画 API および Web サイトとの連携
- **非公式ツール**: ニコニコ動画の HTML 構造変更により動作しなくなるリスクがある

これらの特性を踏まえ、**安全性と安定性を最優先**としたテスト戦略を採用します。

### 1.1 テストの目的

本サービスのテストは、以下の目的を達成するために実施します：

#### 1. 主要機能の動作保証

- **マイリスト一括登録**: 条件指定により動画を選択し、ニコニコ動画のマイリストに自動登録できることを保証
- **動画一括インポート**: 動画 ID から動画基本情報を取得し、DynamoDB に保存できることを保証
- **ユーザー設定管理**: お気に入りフラグ、スキップフラグ、メモの編集機能が正常に動作することを保証

#### 2. ビジネスロジックの正確性

- **core パッケージの純粋関数**: フレームワーク非依存のビジネスロジックを重点的にテスト
- **条件フィルタリング**: 「スキップを除く」「お気に入りのみ」などの条件が正しく適用されることを検証
- **ランダム選択**: 最大 100 個の動画がランダムに選択されるロジックの正確性を検証

#### 3. 外部連携の安定性

- **ニコニコ動画 API 連携**: API 呼び出しのエラーハンドリングが適切であることを検証
- **Playwright 自動化**: Playwright による自動操作が安定して動作することを検証（モック化とE2Eの両面）
- **AWS Batch 連携**: バッチジョブの投入・ステータス確認が正常に動作することを検証

#### 4. セキュリティの確保

- **パスワード暗号化**: ニコニコアカウント情報が適切に暗号化されることを検証
- **データアクセス制御**: ユーザーが自分のデータのみアクセスできることを検証
- **入力検証**: API エンドポイントでの入力バリデーションが機能することを検証

#### 5. リグレッション防止

- **既存機能の保護**: 新機能追加時に既存機能が破壊されないことを保証
- **CI/CD による継続的テスト**: 全 PR で自動テストを実行し、品質を維持

### 1.2 テスト方針

本サービスでは、以下のテスト方針に従ってテストを実施します：

#### スマホファースト

- **モバイル優先のテスト**: Fast CI では chromium-mobile のみを使用し、開発中の素早いフィードバックを実現
- **タッチ操作の検証**: E2E テストでモバイルデバイスのタッチ操作を優先的に検証
- **レスポンシブ対応**: モバイル、タブレット、デスクトップの各画面サイズで UI が適切に表示されることを確認

#### ビジネスロジック重視

- **core パッケージを重点的にテスト**: フレームワーク非依存の純粋関数を優先的にユニットテスト
- **80%以上のカバレッジ**: ビジネスロジック（lib/ ディレクトリ）で 80%以上のテストカバレッジを必須とする
- **モック最小化**: 純粋関数はモック化せず、実際のロジックをテスト。副作用がある処理（ブラウザAPI、外部API）のみモック化

#### E2Eでクリティカルパスをカバー

- **主要フローの検証**: マイリスト登録、動画一括インポート、ユーザー設定管理の一連の流れを E2E でテスト
- **UI層とAPI Routesはユニットテスト任意**: E2E テストでカバーされるため、個別のユニットテストは必須としない
- **安定性優先**: 不安定なテストは修正するか削除し、メンテナンスコストを抑える

#### 自動化の徹底

- **CI/CD 統合**: 全 PR で自動テストを実行し、品質を継続的に検証
- **2段階CI戦略**: Fast CI（chromium-mobile のみ）で開発速度を維持し、Full CI（全デバイス）でマージ前の完全検証を実施
- **テスト失敗時の即座対応**: テスト失敗時はスクリーンショット・動画・トレースを自動保存し、デバッグを効率化

#### 安全性と安定性の優先

- **速度よりも安全性**: ニコニコ動画サーバーへの配慮として、各動画登録間に最低 2 秒の待機時間を設ける仕様をテストで検証
- **エラーハンドリングの徹底**: 外部 API 失敗、ネットワークエラー、認証エラーなどの異常系テストを重視
- **リトライロジックの検証**: 最大 3 回のリトライが正しく機能することを検証

---

## 2. テストデバイス/ブラウザ構成

<!-- 記入ガイド: テスト対象のデバイスとブラウザを記述してください -->
<!-- 記入ガイド: プラットフォーム標準は chromium-desktop, chromium-mobile, webkit-mobile です -->

### 2.1 Playwright デバイス構成

<!-- 記入ガイド: Playwright で使用するデバイス構成を表形式で記述してください -->

| デバイス名       | 用途               | 画面サイズ  | User Agent              |
| ---------------- | ------------------ | ----------- | ----------------------- |
| chromium-desktop | デスクトップChrome | 1920x1080   | Chrome (最新安定版)     |
| chromium-mobile  | モバイルChrome     | Pixel 5相当 | Chrome Mobile (Android) |
| webkit-mobile    | モバイルSafari     | iPhone相当  | Safari Mobile (iOS)     |

### 2.2 テスト優先順位

<!-- 記入ガイド: テスト実行の優先順位を記述してください -->
<!-- 記入例: Fast CI では chromium-mobile のみ、Full CI では全デバイスなど -->

#### Fast CI (高速フィードバック)

- **対象**: chromium-mobile のみ
- **目的**: 開発中の素早いフィードバック
- **トリガー**: `integration/**` ブランチへのPR

#### Full CI (完全テスト)

- **対象**: chromium-desktop, chromium-mobile, webkit-mobile
- **目的**: マージ前の完全な品質検証
- **トリガー**: `develop` ブランチへのPR

---

## 3. カバレッジ目標

<!-- 記入ガイド: テストカバレッジの目標を記述してください -->
<!-- 記入ガイド: プラットフォーム標準は 80%以上 です -->

### 3.1 カバレッジ目標値

<!-- 記入ガイド: カバレッジ目標を表形式で記述してください -->

| カテゴリ                | カバレッジ目標     | 測定方法      |
| ----------------------- | ------------------ | ------------- |
| ビジネスロジック (lib/) | 80%以上            | Jest coverage |
| ユーティリティ関数      | 80%以上            | Jest coverage |
| UI コンポーネント       | 任意 (E2Eでカバー) | E2E テスト    |
| API Routes              | 任意 (E2Eでカバー) | E2E テスト    |

### 3.2 カバレッジ対象外

<!-- 記入ガイド: 意図的にカバレッジ対象外とするファイルを記述してください -->
<!-- 記入例: Next.js App Router の page コンポーネント、設定ファイルなど -->

以下は Jest のカバレッジ対象外とします（E2E テストでカバー）:

- `app/**/page.tsx` - Next.js App Router の page コンポーネント
- `app/**/layout.tsx` - レイアウトコンポーネント
- {その他対象外のファイルパターン}

### 3.3 カバレッジ計測方法

<!-- 記入ガイド: カバレッジの計測方法を記述してください -->

```bash
# カバレッジレポート生成
npm run test:coverage

# カバレッジ結果の確認
# - コンソール出力: サマリー
# - coverage/lcov-report/index.html: 詳細レポート
```

---

## 4. E2Eテストシナリオ

<!-- 記入ガイド: E2E テストで実施する主要なテストシナリオを記述してください -->
<!-- 記入例: ユーザーが実行する典型的な操作フローを網羅 -->

### 4.1 テストシナリオ一覧

<!-- 記入ガイド: テストシナリオを表形式で記述してください -->

| シナリオID | シナリオ名   | 概要   | 優先度 | 対象デバイス          |
| ---------- | ------------ | ------ | ------ | --------------------- |
| E2E-001    | {シナリオ名} | {概要} | 高     | 全デバイス            |
| E2E-002    | {シナリオ名} | {概要} | 中     | chromium-mobile のみ  |
| E2E-003    | {シナリオ名} | {概要} | 低     | chromium-desktop のみ |

### 4.2 シナリオ詳細

<!-- 記入ガイド: 各シナリオの詳細を記述してください -->

#### E2E-001: {シナリオ名}

<!-- 記入ガイド: シナリオごとに記述してください -->

**目的**: {シナリオの目的}

**前提条件**:

- {前提条件1}
- {前提条件2}

**テスト手順**:

1. {ステップ1}
2. {ステップ2}
3. {ステップ3}

**期待結果**:

- {期待結果1}
- {期待結果2}

**テストファイル**: `tests/e2e/{test-file}.spec.ts`

**実行環境要件**:

- {要件1（例: AWS環境が必要、認証情報が必要など）}

---

## 5. ユニットテスト対象

<!-- 記入ガイド: ユニットテストで実施するテスト対象を記述してください -->

### 5.1 テスト対象の分類

<!-- 記入ガイド: テスト対象をカテゴリごとに記述してください -->

#### ビジネスロジック (lib/)

<!-- 記入ガイド: ビジネスロジックのテスト対象を記述してください -->
<!-- 記入例: パーサー、フォーマッター、バリデーター、データ変換処理など -->

- **{カテゴリ名}** (`lib/{path}/`)
    - {テスト対象1}
    - {テスト対象2}

#### ユーティリティ関数

<!-- 記入ガイド: ユーティリティ関数のテスト対象を記述してください -->

- **{カテゴリ名}** (`lib/{path}/`)
    - {テスト対象1}
    - {テスト対象2}

#### API Routes

<!-- [任意] API を提供するサービスのみ -->
<!-- 記入ガイド: API Routes のテスト対象を記述してください -->

- **{エンドポイント名}** (`app/api/{path}/route.ts`)
    - {テスト内容}

#### UI コンポーネント

<!-- [任意] -->
<!-- 記入ガイド: UI コンポーネントでユニットテストを実施する場合に記述してください -->
<!-- 記入ガイド: 基本的には E2E でカバーしますが、複雑なロジックを持つコンポーネントはユニットテストを追加 -->

- **{コンポーネント名}** (`components/{path}.tsx`)
    - {テスト内容}

### 5.2 テスト対象外

<!-- 記入ガイド: 意図的にユニットテスト対象外とするものを記述してください -->
<!-- 記入例: シンプルなコンポーネント、設定ファイル、型定義のみのファイルなど -->

以下はユニットテストの対象外とします:

- ❌ {対象外のファイル/カテゴリ1} - {理由}
- ❌ {対象外のファイル/カテゴリ2} - {理由}

---

## 6. テスト実行方法

<!-- 記入ガイド: テストの実行方法を記述してください -->

### 6.1 ローカル環境での実行

<!-- 記入ガイド: ローカルでのテスト実行方法を記述してください -->

#### ユニットテスト

```bash
# すべてのユニットテストを実行
npm run test

# ウォッチモード（ファイル変更時に自動実行）
npm run test:watch

# カバレッジレポート生成
npm run test:coverage

# 特定のテストファイルのみ実行
npm run test -- tests/unit/{test-file}.test.ts
```

#### E2Eテスト

```bash
# すべての E2E テストを実行
npm run test:e2e

# 特定のデバイスのみ実行
npm run test:e2e -- --project=chromium-mobile
npm run test:e2e -- --project=chromium-desktop
npm run test:e2e -- --project=webkit-mobile

# 特定のテストファイルのみ実行
npm run test:e2e tests/e2e/{test-file}.spec.ts

# UI モードで実行（デバッグ用）
npm run test:e2e:ui

# ブラウザ表示モード（headed モード）
npm run test:e2e:headed
```

### 6.2 CI環境での実行

<!-- 記入ガイド: CI 環境でのテスト実行を記述してください -->

#### GitHub Actions

GitHub Actions で自動実行されます:

**Fast CI** (`.github/workflows/{service-name}-verify-fast.yml`):

- トリガー: `integration/**` ブランチへのPR
- テスト: ユニットテスト + E2E (chromium-mobile のみ)

**Full CI** (`.github/workflows/{service-name}-verify-full.yml`):

- トリガー: `develop` ブランチへのPR
- テスト: ユニットテスト + カバレッジチェック + E2E (全デバイス)
- カバレッジ: 80%未満で失敗

#### 環境変数

<!-- 記入ガイド: CI で必要な環境変数を記述してください -->

CI 環境で必要な環境変数:

```bash
{ENV_VAR_NAME}={説明}
{ENV_VAR_NAME}={説明}
```

---

## 7. CI/CD統合

<!-- 記入ガイド: CI/CD パイプラインとの統合方法を記述してください -->

### 7.1 ワークフロー構成

<!-- 記入ガイド: GitHub Actions ワークフローの構成を記述してください -->

| ワークフロー               | トリガー                      | 実行内容                                       |
| -------------------------- | ----------------------------- | ---------------------------------------------- |
| {service-name}-verify-fast | PR to `integration/**`        | ビルド、ユニット、E2E (chromium-mobile)        |
| {service-name}-verify-full | PR to `develop`               | ビルド、ユニット、カバレッジ、E2E (全デバイス) |
| {service-name}-deploy      | Push to `develop` or `master` | デプロイ（テストは verify で完了済み）         |

### 7.2 ブランチ保護ルール

<!-- 記入ガイド: GitHub のブランチ保護ルールを記述してください -->

#### `integration/**` ブランチ

- ✅ PR 必須（直接プッシュ禁止）
- ✅ `{service-name}-verify-fast` ワークフローの成功が必須
- {その他のルール}

#### `develop` ブランチ

- ✅ PR 必須（直接プッシュ禁止）
- ✅ `{service-name}-verify-full` ワークフローの成功が必須
- ✅ カバレッジ 80%以上の確保（Jest の `coverageThreshold` により自動チェック）
- {その他のルール}

#### `master` ブランチ

- ✅ PR 必須（直接プッシュ禁止）
- ✅ 全ての CI/CD チェックの成功が必須
- ✅ レビュー承認が必須（推奨）
- {その他のルール}

### 7.3 テスト失敗時の対応

<!-- 記入ガイド: テスト失敗時の対応手順を記述してください -->

#### ユニットテスト失敗

1. ローカルで再現確認
2. 該当テストを修正
3. カバレッジを再確認

#### E2Eテスト失敗

1. GitHub Actions のアーティファクトを確認（スクリーンショット、動画、トレース）
2. ローカルで再現確認（`npm run test:e2e:ui`）
3. 不安定なテストの場合はリトライ設定を追加

#### カバレッジ不足

1. カバレッジレポートを確認（`coverage/lcov-report/index.html`）
2. カバーされていないコードを特定
3. 必要なテストを追加

---

## 8. 既知の問題・制約

<!-- 記入ガイド: テストに関する既知の問題や制約を記述してください -->
<!-- 記入例: React 19 + Jest の互換性問題、AWS環境が必要なテストなど -->

### 8.1 技術的制約

<!-- 記入ガイド: 技術的な制約を記述してください -->

#### {制約項目}

**問題内容**: {問題の説明}

**影響範囲**: {影響を受ける範囲}

**回避策**: {回避策の説明}

**将来の対応**: {将来的な対応方針}

### 8.2 環境依存のテスト

<!-- 記入ガイド: 特定の環境が必要なテストを記述してください -->

以下のテストは特定の環境が必要です:

- **{テストシナリオ}**: {必要な環境（例: AWS環境、外部API、認証情報など）}

---

## 9. テスト作成ガイドライン

<!-- 記入ガイド: このサービスでテストを作成する際のガイドラインを記述してください -->

### 9.1 ユニットテスト作成ガイドライン

<!-- 記入ガイド: ユニットテスト作成時のベストプラクティスを記述してください -->

#### 原則

- **純粋関数を優先**: 副作用のないテストしやすいコード
- **一つのテストで一つの検証**: テストケースを小さく保つ
- **AAA パターン**: Arrange（準備）、Act（実行）、Assert（検証）

#### 命名規則

```typescript
describe('{機能名}', () => {
    describe('{関数名}', () => {
        it('正常系: {説明}', () => {
            // テストコード
        });

        it('異常系: {説明}', () => {
            // テストコード
        });

        it('エッジケース: {説明}', () => {
            // テストコード
        });
    });
});
```

#### モック対象

以下のような副作用がある処理のみモック化:

- ブラウザAPI（navigator.clipboard、localStorage等）
- 外部API呼び出し
- Next.js ルーティング（useRouter 等）
- {サービス固有のモック対象}

### 9.2 E2Eテスト作成ガイドライン

<!-- 記入ガイド: E2E テスト作成時のベストプラクティスを記述してください -->

#### 原則

- **ユーザー視点**: 実際の利用シナリオに沿って記述
- **安定性優先**: 不安定なテストは修正するか削除
- **独立性**: テスト間で状態を共有しない

#### テスト粒度

- 主要フローは細かくテスト
- 枝葉の機能は重要度に応じて判断
- 過度に細かいテストは避ける（メンテナンスコスト増）

---

## 10. トラブルシューティング

<!-- 記入ガイド: テスト実行時によくある問題と解決方法を記述してください -->

### 10.1 よくある問題

<!-- 記入ガイド: よくある問題と解決方法を記述してください -->

#### {問題}

**症状**: {症状の説明}

**原因**: {原因の説明}

**解決方法**: {解決方法の説明}

### 10.2 デバッグ方法

<!-- 記入ガイド: テストのデバッグ方法を記述してください -->

#### ユニットテストのデバッグ

```bash
# 特定のテストのみ実行
npm run test -- tests/unit/{test-file}.test.ts

# デバッグ情報を出力
npm run test -- --verbose
```

#### E2Eテストのデバッグ

```bash
# UI モードで実行（ステップバイステップで確認）
npm run test:e2e:ui

# ブラウザ表示モードで実行
npm run test:e2e:headed

# トレースビューアーで結果を確認
npx playwright show-trace {trace-file}
```

---

## 11. 参考資料

<!-- 記入ガイド: 関連する参考資料へのリンクを記述してください -->

### プラットフォームドキュメント

- [テスト戦略 (全体方針)](../../development/testing.md)
- [コーディング規約](../../development/rules.md)
- [共通設定ファイル](../../development/configs.md)

### サービス固有ドキュメント

- [要件定義](./requirements.md)
- [アーキテクチャ設計](./architecture.md)
- [デプロイ・運用](./deployment.md)
