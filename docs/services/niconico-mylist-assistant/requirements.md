# niconico-mylist-assistant 要件定義

## 1. サービスの目的

### 1.1 背景

ニコニコ動画で大量の動画をマイリストに登録する際の手作業負担を軽減し、作業効率化と登録精度の向上を実現する。

### 1.2 技術移行の方針

既存実装（Python + Selenium）からTypeScript + Playwrightへの移行理由:

1.  **プラットフォーム統一**: TypeScriptへの統一により保守性を確保
2.  **型安全性**: strict modeによる品質向上
3.  **既存ノウハウの活用**: Playwrightの実績とノウハウを活用

## 2. 重要な設計方針

### 2.1 安全性優先の原則

**速度よりも安全性を重視する**

- 各動画登録間に**最低2秒**の待機時間を設ける
- ニコニコ動画のサーバーに過度な負荷をかけない
- リトライは最大3回までに制限

この方針は、非公式ツールとしてサーバーに配慮する姿勢を示すものであり、実装において絶対に遵守すること。

### 2.2 データ構造の分離

**動画基本情報（全ユーザー共通）とユーザー設定（ユーザー固有）を明確に分離する**

- **動画基本情報**: ニコニコ動画から取得する全ユーザー共通のメタデータ（タイトル、サムネイルなど）
- **ユーザー設定**: 各ユーザーが個別に設定するメタデータ（お気に入りフラグ、スキップフラグ、メモなど）

この分離により、データの重複を避け、効率的なストレージ利用を実現する。

### 2.3 セキュリティ方針

**ニコニコアカウント情報は絶対にデータベースに保存しない**

- パスワードはバッチ処理実行時のみメモリ上で保持
- 暗号化して送信（AES-256-GCM、環境変数 `SHARED_SECRET_KEY` を使用）
- 処理終了後は即座にメモリから削除

### 2.4 マイリスト登録の制約

**既存マイリストの動画を全削除してから新規登録を行う**

ニコニコ動画のマイリスト上限は100件であり、追加登録すると上限を超える可能性がある。そのため、既存の動画を全て削除してから新しい動画を登録する設計とする。

## 3. 主要ユースケース

### 3.1 マイリスト一括登録

条件指定（お気に入りのみ、スキップを除く等）により動画を選択し、最大100個をランダムに選んでマイリストに自動登録する。

### 3.2 動画一括インポート

動画IDを改行区切りで入力し、ニコニコ動画APIから動画基本情報を取得してDynamoDBに保存する。

### 3.3 ユーザー設定管理

登録済み動画のお気に入りフラグ、スキップフラグ、メモを編集する。

## 4. 技術的制約と対策方針

### 4.1 ニコニコ動画のHTML構造依存

**課題**: ニコニコ動画はSPAであり、HTML構造が予告なく変更される可能性がある。

**対策方針**: 複数の抽出戦略を並行実行し、いずれかが成功すればOKとする。

- 安定したID/属性ベース（優先度1）
- Playwright推奨のRoleセレクタ（優先度2）
- JSON-LD/APIデータの利用（優先度3）
- 部分一致セレクタ（フォールバック）

セレクタは定数化し、戦略のフォールバック実装を用意する。

### 4.2 ニコニコ動画APIのRate Limiting

**対策方針**:

- リトライロジック（最大3回、指数バックオフ）を実装
- API エラー時のログを詳細に記録
- 待機時間の遵守（マイリスト登録: 最低2秒）

## 5. スコープ外

以下は将来的な対応として現時点では実装しない:

- 動画IDリストを直接入力して即座に登録する機能
- 他の動画サイトへの対応（YouTube、bilibili等）
- マイリストの複数管理
- スケジュール実行（定期的な自動登録）
- 動画のプレビュー・再生機能
- 既存データの移行機能（Python版からの移行）
- 動画のダウンロード機能
