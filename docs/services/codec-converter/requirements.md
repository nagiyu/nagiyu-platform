# 要件定義

## サービス概要

### 目的

動画ファイルのコーデック変換を**ブラウザのみで**簡単に行えるWebサービスを提供する。

### ターゲットユーザー

- 個人利用の一般ユーザー
- 動画のコーデック変換が必要だが、専門知識がない
- 専門ツール（FFmpegなど）のインストールが面倒

### 提供価値

- ✅ ブラウザだけで完結（ソフトウェアインストール不要）
- ✅ 匿名で利用可能（アカウント登録不要）
- ✅ 無料（Phase 1では課金機能なし）

---

## MVP範囲の定義

### MVPで実装する機能

**最小限の動作フロー**:
```
ユーザーがMP4をアップロード
    → コーデック選択（H.264/VP9/AV1）
    → 変換処理（AWS Batch）
    → 変換完了後にダウンロード
```

**含まれる機能**:
1. ✅ 動画アップロード（MP4のみ、500MB上限）
2. ✅ コーデック変換（H.264/VP9/AV1への変換）
3. ✅ ジョブステータス確認（PENDING/PROCESSING/COMPLETED/FAILED）
4. ✅ 変換済みファイルのダウンロード
5. ✅ CloudFront配信（カスタムドメイン、CDN）

**含まれない機能** (後述のスコープ外を参照):
- ❌ ジョブ一覧表示（ローカルストレージ管理）
- ❌ 複数ファイルの同時アップロード
- ❌ 進捗表示（パーセンテージ）
- ❌ ユーザー認証

### MVP判定基準

以下のシナリオが完全に動作すれば、MVPとして成功:

```
シナリオ: 基本的な変換フロー
1. ユーザーがブラウザでサービスにアクセス
2. 100MB以下のMP4ファイルをアップロード
3. 出力コーデックとして「H.264」を選択
4. 「変換開始」ボタンをクリック
5. ジョブIDが表示され、ステータスが「PENDING」→「PROCESSING」に遷移
6. 数分後、ステータスが「COMPLETED」に変わる
7. 「ダウンロード」ボタンをクリックして変換済みファイルを取得
8. ダウンロードしたファイルが正常に再生できる
```

---

## 機能要件

### FR-1: 動画アップロード機能

**説明**: ユーザーがブラウザから動画ファイルをアップロードできる

**詳細仕様**:
- **入力形式**: MP4のみ（MIMEタイプ: `video/mp4`）
- **ファイルサイズ上限**: 500MB
- **アップロード方法**:
    - ブラウザ側でファイル検証（拡張子、MIMEタイプ、サイズ）
    - Next.js API Routes (Lambda上で実行) でS3 Presigned URLを生成
    - ブラウザからS3へ直接アップロード（Next.js/Lambdaを経由しない）
- **UI**: ドラッグ&ドロップ対応
- **検証エラー時の挙動**:
    - エラーメッセージを表示（例: "ファイルサイズは500MB以下である必要があります"）
    - アップロードを中止

**制約**:
- ウイルススキャンは実施しない（Phase 1）
- アップロード中断時の再開機能なし（ユーザーが再度アップロード）

---

### FR-2: コーデック変換機能

**説明**: アップロードされた動画を指定したコーデックに変換する

**詳細仕様**:
- **入力**: MP4コンテナ（内部コーデックは問わない）
- **出力コーデック**:
    - H.264（MP4コンテナ、音声: AAC）
    - VP9（WebMコンテナ、音声: Opus）
    - AV1（WebMコンテナ、音声: Opus）
- **変換パラメータ**:
    - 解像度・ビットレート・フレームレート: 元動画を維持
    - 音声ビットレート: 元動画を維持（再エンコードせずコピー）
    - エンコードパス: 1-pass（処理時間を優先）
    - エンコード品質:
    - H.264: CRF 23（標準品質）
    - VP9: CRF 30
    - AV1: CRF 30, cpu-used 4
- **処理基盤**: AWS Batch（Fargate）
- **処理ツール**: FFmpeg
- **タイムアウト**: 2時間（7200秒）
- **同時実行数**: 最大3ジョブ（それ以上はキューで待機）

**エラーハンドリング**:
- **FFmpegエラー**:
    - システム管理者向け: FFmpegのexit codeとstderrを`errorMessage`に記録（DynamoDB）
    - ユーザー向け: 「変換処理に失敗しました」と表示（技術的詳細は非表示）
    - ステータスを `FAILED` に設定
- **リトライ戦略**:
    - 一時的なエラー（ネットワーク障害、S3アクセスエラーなど）は最大2回リトライ
    - リトライ間隔: 指数バックオフ（1回目: 5秒、2回目: 10秒）
    - 2回リトライ後も失敗した場合は `FAILED` に設定
- **中間ファイルの扱い**:
    - FFmpegが途中でクラッシュした場合、中間ファイルは廃棄（S3から削除）
    - 最終的に保持するのは元動画と変換後動画のみ
- **タイムアウト**: 2時間を超えた場合、ステータスを `FAILED` に設定

---

### FR-3: ジョブ管理機能

**説明**: 変換ジョブの状態を管理・追跡する

**詳細仕様**:
- **ジョブID**: UUID v4（推測困難）
- **ジョブステータス**:
    | ステータス | 説明 | 遷移条件 |
    |-----------|------|---------|
    | `PENDING` | アップロード完了、変換待ち | ジョブ作成時 |
    | `PROCESSING` | 変換処理中 | Batchジョブ開始時 |
    | `COMPLETED` | 変換完了 | 変換成功時 |
    | `FAILED` | 変換失敗 | エラー発生時 |

- **データ保持**: DynamoDBにジョブ情報を保存
    - ジョブID（主キー）
    - ステータス
    - 入力ファイルS3パス
    - 出力ファイルS3パス（変換完了時）
    - 出力コーデック
    - ファイル名
    - ファイルサイズ
    - 作成日時（Unix timestamp）
    - 更新日時（Unix timestamp）
    - 有効期限（Unix timestamp、作成日時 + 24時間）
    - エラーメッセージ（FAILED時のみ）

- **TTL設定**: ジョブ作成から24時間後に自動削除

**API**:
- `GET /api/jobs/{jobId}`: ジョブステータスを取得
    - `status === "COMPLETED"` の場合、レスポンスに `downloadUrl` を含める

**UI**:
- 「ステータス確認」ボタンを表示
- ユーザーが手動でクリックしてステータスを確認（自動ポーリングはしない）
- ステータス表示: PENDING（待機中）、PROCESSING（処理中）、COMPLETED（完了）、FAILED（失敗）
- FAILED時はエラーメッセージを表示

---

### FR-4: ダウンロード機能

**説明**: 変換済みファイルをダウンロードする

**詳細仕様**:
- **ダウンロード方法**: S3 Presigned URL経由
- **有効期限**: Presigned URLは24時間有効
- **ファイル保持期間**: 変換完了後24時間（S3 Lifecycle Policyで自動削除）
- **ダウンロード回数制限**: なし（有効期限内であれば何度でも可能）

**API**:
- `GET /api/jobs/{jobId}`: ジョブステータス取得時、`status === "COMPLETED"` の場合は `downloadUrl` を含める
    - レスポンス例: `{ jobId, status: "COMPLETED", fileName, downloadUrl, ... }`

**UI**:
- ジョブステータスが `COMPLETED` の場合のみ「ダウンロード」ボタンを表示
- ボタンクリックで `downloadUrl` にアクセスしてダウンロード開始

---

### FR-5: 認証機能

**説明**: 認証機能は提供しない（匿名利用）

**詳細仕様**:
- アカウント登録不要
- ログイン不要
- アクセス制御: ジョブIDを知っている人のみアクセス可能
    - ジョブIDはUUID v4（128ビット）なので推測困難

**セキュリティ考慮**:
- ジョブIDの漏洩リスクはユーザー責任
- Phase 1では認証なしで実装（Phase 2以降で検討）

---

## 非機能要件

### NFR-1: パフォーマンス

- **同時実行ジョブ数**: 3ジョブ（AWS Batch Compute Environmentで制御）
- **変換処理時間の目安**:
    - H.264: 実時間の 0.3-0.5倍（30分動画 → 9-15分）
    - VP9: 実時間の 0.5-1.0倍（30分動画 → 15-30分）
    - AV1: 実時間の 1.0-2.0倍（30分動画 → 30-60分）
    - ※インスタンスタイプや動画の複雑さにより変動
- **アップロード/ダウンロード速度**: ユーザーのネットワーク環境に依存

### NFR-2: スケーラビリティ

- **想定同時ユーザー数**: Phase 1では小規模想定（具体的な数値は設定しない）
- **フロントエンド**: Lambda（自動スケール）
- **処理キュー**: AWS Batch（FIFO、最大3ジョブ並列実行）

### NFR-3: セキュリティ

- **データ暗号化**:
    - 転送時: HTTPS（すべての通信）
    - 保存時: S3 SSE-S3（サーバー側暗号化）、DynamoDB暗号化（デフォルト有効）
- **アクセス制御**:
    - S3バケット: 非公開（Presigned URLのみでアクセス）
    - DynamoDB: IAMロールベースのアクセス制御
- **ウイルススキャン**: Phase 1では実施しない

### NFR-4: 可用性

- **稼働率目標**: 設定しない（ベストエフォート）
- **バックアップ**: 実施しない（一時的なデータのため）

### NFR-5: コスト

- **想定月間処理量**: Phase 1では制限なし（実験的運用）
- **コスト最適化策**:
    - ファイル24時間自動削除
    - Lambdaは実行時のみ課金
    - Batchは処理時のみ課金（Fargate Spot未使用時）

---

## 制約事項

### 技術的制約

1. **ファイルサイズ**: 500MB上限
2. **ファイル形式**: MP4のみ（入力）
3. **変換タイムアウト**: 2時間
4. **同時処理数**: 3ジョブまで
5. **対応コーデック**: FFmpegで処理可能なもののみ
6. **Lambda実行時間**: 15分（APIのみ、変換処理はBatch）

### ビジネス制約

1. **匿名利用のみ**: ユーザー認証なし
2. **無料提供**: 課金機能なし（Phase 1）
3. **ファイル保持期間**: 24時間のみ

---

## スコープ外

以下の機能はPhase 1では実装しない:

### Phase 1でスコープ外の機能

1. **ジョブ一覧表示**（ローカルストレージでの管理）
    - 理由: MVP範囲を最小化するため
    - Phase 2で実装予定

2. **進捗表示**（パーセンテージ）
    - 理由: FFmpegからのプログレス取得が複雑
    - Phase 2で実装予定

3. **複数ファイル対応**
    - AVI, MOV, MKVなどの入力形式
    - H.265/HEVCなどの出力コーデック

4. **変換オプション**
    - 解像度変更
    - ビットレート指定
    - フレームレート変更

5. **ユーザー認証・アカウント管理**

6. **ウイルススキャン**

7. **PWA対応**
    - 理由: サービスの特性上、オフライン機能のメリットが薄い（アップロード/変換/ダウンロードは全てオンライン必須）
    - 頻繁に使うツールではない（ブックマークで十分）
    - Service Workerのキャッシュ管理が複雑化する
    - Phase 2以降で必要性を再検討

---

## 成功基準

### MVP成功基準

以下をすべて満たせば、MVPとして成功:

1. **SC-1: 基本フロー成功率**
    - 100MB以下のMP4ファイルをアップロード → H.264変換 → ダウンロード
    - 成功率: 95%以上（典型的なテストセット）

2. **SC-2: 同時処理**
    - 3ジョブまで並列実行可能
    - 4ジョブ目以降はキューで待機（処理が滞留しない）

3. **SC-3: タイムアウト**
    - 2時間を超えるジョブは `FAILED` ステータスになる

4. **SC-4: ダウンロード**
    - 変換完了後、Presigned URLからファイルをダウンロード可能
    - ダウンロードしたファイルが正常に再生できる

5. **SC-5: データ削除**
    - ジョブ作成から24時間後にS3オブジェクトとDynamoDBレコードが削除される

### 受け入れテスト

以下のシナリオをすべてパスすること:

#### シナリオ1: 正常系（H.264変換）
1. 50MBのMP4ファイルをアップロード
2. 出力コーデック「H.264」を選択
3. ジョブIDが発行される
4. ステータスが `PENDING` → `PROCESSING` → `COMPLETED` と遷移
5. ダウンロードリンクが表示される
6. ファイルをダウンロードして再生できる

#### シナリオ2: エラーハンドリング（ファイルサイズ超過）
1. 600MBのMP4ファイルを選択
2. エラーメッセージ「ファイルサイズは500MB以下である必要があります」が表示される
3. アップロードが実行されない

#### シナリオ3: エラーハンドリング（FFmpeg失敗）
1. FFmpegで処理できないコーデックのMP4をアップロード
2. ジョブステータスが `FAILED` になる
3. エラーメッセージが記録される
