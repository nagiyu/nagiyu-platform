# ロール・権限定義

## 概要

本ドキュメントは、nagiyu プラットフォームにおけるロールベースアクセス制御 (RBAC) の設計思想と仕様を定義します。

## 設計方針

### 1. コードベースでの管理

ロール・権限定義は**コードで管理**し、データベースには保存しません：

**利点:**
- バージョン管理が容易（Git で履歴を追跡）
- デプロイ時に自動的に反映
- 権限変更時のマイグレーション不要
- コードレビューで変更を審査可能

**制約:**
- 新しいロールを追加するにはコードデプロイが必要
- 実行時の動的なロール作成は不可

### 2. 最小権限の原則

ユーザーには業務遂行に必要な**最小限の権限**のみを付与します：

- デフォルトでは権限なし（明示的な付与が必要）
- 複数ロールの組み合わせで柔軟に権限を調整
- 管理者ロール (`admin`) は全権限を持つが、慎重に付与

### 3. 権限の粒度

権限は**リソース単位**と**アクション単位**で定義します：

```
{resource}:{action}
```

**Phase 1 で定義される権限例:**
- `users:read` - ユーザー情報の読み取り
- `users:write` - ユーザー情報の作成・更新・削除
- `roles:assign` - ユーザーへのロール割り当て

**Phase 2 以降で追加予定の権限例:**
- `logs:read` - ログの閲覧
- `logs:write` - ログ設定の変更

### 4. 拡張性

Phase 2 以降で追加されるサービス（Logs, Tools 等）の権限も同じ体系で管理します：

```typescript
// Phase 2 で追加予定
'tools:admin'     // Tools サービスの管理権限
'settings:write'  // プラットフォーム設定の変更権限
```

## 権限一覧

### Phase 1 で定義される権限

| 権限 | リソース | アクション | 説明 |
|------|---------|-----------|------|
| `users:read` | ユーザー | 読み取り | ユーザー一覧・詳細の閲覧 |
| `users:write` | ユーザー | 書き込み | ユーザー作成・更新・削除 |
| `roles:assign` | ロール | 割り当て | ユーザーへのロール付与・剥奪 |

### Phase 2 以降で追加予定の権限

| 権限 | リソース | アクション | 説明 |
|------|---------|-----------|------|
| `logs:read` | ログ | 読み取り | CloudWatch Logs の閲覧 |
| `logs:write` | ログ | 書き込み | ログ設定の変更 |
| `tools:admin` | Tools | 管理 | Tools サービスの管理機能へのアクセス |
| `settings:write` | 設定 | 書き込み | プラットフォーム設定の変更 |
| `analytics:read` | 分析 | 読み取り | 利用統計・分析データの閲覧 |

## ロール定義

### Phase 1 で定義されるロール

#### 1. admin（管理者）

**ID:** `admin`

**権限:**
- `users:read`
- `users:write`
- `roles:assign`

**説明:**

プラットフォーム全体の管理者。Phase 1 ではユーザー管理およびロール割り当ての全権限を持ちます。

**用途:**
- プラットフォーム運営チーム
- システム管理者

**注意:**
- 強力な権限を持つため、付与は慎重に行う
- 初期セットアップ時にのみ手動で付与
- Phase 2 以降でログ閲覧権限などが追加予定

#### 2. user-manager（ユーザー管理者）

**ID:** `user-manager`

**権限:**
- `users:read`
- `users:write`

**説明:**

ユーザー情報の管理のみを行えるロール。ロール割り当ては不可（権限昇格の防止）。

**用途:**
- ユーザーサポートチーム
- 人事担当者（社内利用の場合）

**制約:**
- 自分自身を含め、ロールの変更はできない
- ロール割り当てには `admin` が必要

## 実装ガイドライン

### 1. ロール・権限定義の実装場所

- **実装ファイル**: `libs/common/src/auth/roles.ts`
- **管理方法**: TypeScript の const assertion を使用して型安全に定義
- **命名規則**: ロール ID は kebab-case、権限は `{resource}:{action}` 形式

### 2. 権限チェック関数の実装場所

- **実装ファイル**: `libs/common/src/auth/permissions.ts`
- **必要な関数**:
  - `hasPermission()`: 単一権限チェック
  - `requirePermission()`: 権限なしの場合にエラーをスロー
  - `hasAnyPermission()`: OR 条件チェック
  - `hasAllPermissions()`: AND 条件チェック

### 3. 権限チェックの実装箇所

**必須実装:**
- すべての API Route（サーバーサイド）
- Middleware（ルート保護）

**任意実装:**
- クライアントサイド（UI の表示制御のみ、セキュリティ目的では使用しない）

### 4. 実装時の注意点

- サーバーサイドでの権限チェックは必須（クライアント側のチェックのみでは不十分）
- ロールが複数ある場合は flatMap で全権限を取得してチェック
- 権限チェックに失敗した場合は 403 Forbidden を返す

## ユーザーへのロール割り当て

### 初回セットアップ（手動）

プラットフォーム初期セットアップ時、最初の管理者ユーザーを手動で DynamoDB に登録します：

**実装方法:**
- AWS CLI または AWS Console を使用
- googleId は Google OAuth 認証後に取得される値
- roles 属性に `["admin"]` を設定

### 管理画面からの割り当て（Phase 1）

Admin サービスのユーザー管理画面でロールを割り当てます：

**API エンドポイント:** `PUT /api/users/{userId}`

**必要な権限:** `roles:assign`

**Phase 1 で割り当て可能なロール:**
- `admin`
- `user-manager`

### ロール変更の監査

**Phase 2 で実装予定:**
- ロール変更は CloudWatch Logs に記録
- 変更者、変更対象、変更前後のロール情報を記録

## セキュリティ考慮事項

### 1. 権限昇格の防止

- ユーザーは自分自身のロールを変更できない仕組みを実装
- API Route でリクエスト元ユーザー ID と変更対象ユーザー ID を比較

### 2. ロール検証

- DynamoDB から取得したロールが有効なロール ID であることを検証
- 不正なロール ID は無視し、警告ログを出力

### 3. JWT へのロール埋め込み

**メリット:**
- 毎回 DynamoDB を参照せずに権限チェックが可能
- ステートレスで高速

**デメリット:**
- ロール変更が即座に反映されない（JWT 有効期限まで）

**対策:**
- JWT 有効期限を短く設定（30日）
- 緊急時の JWT 無効化機能は Phase 3 で検討

### 4. 監査ログ（Phase 2）

すべての権限チェック結果を CloudWatch Logs に記録：
- ユーザー ID
- 要求された権限
- チェック結果（granted / denied）

## Phase 2 以降の拡張

### Phase 2 で追加されるロール

#### log-viewer（ログ閲覧者）

**ID:** `log-viewer`

**権限:**
- `logs:read`

**説明:**

CloudWatch Logs を閲覧できるロール。ログの検索・フィルタリング・エクスポートが可能ですが、ログ設定の変更やユーザー管理はできません。

**用途:**
- サポートチーム
- デバッグを担当する開発者

**追加タイミング:**
- Phase 2 で Logs サービスが実装された際に追加
- admin ロールにも `logs:read` と `logs:write` 権限が追加される

### Phase 3 以降で検討される追加ロール

- `tools-admin`: Tools サービスの管理権限
- `analytics-viewer`: プラットフォーム利用統計の閲覧権限

### リソースレベルの権限（将来検討）

現在はリソース種別単位の権限ですが、将来的に特定リソースへのアクセス制御が必要な場合は以下を検討します：

```typescript
// 例: 特定ユーザーのみ編集可能
{
    "userId": "123",
    "permissions": [
        {
            "resource": "users:456",  // ユーザー ID 456
            "actions": ["read", "write"]
        }
    ]
}
```

## 関連ドキュメント

- [Auth サービス アーキテクチャ](./architecture.md)
- [Auth サービス API 仕様](./api-spec.md)
- [Admin サービス アーキテクチャ](../admin/architecture.md)
