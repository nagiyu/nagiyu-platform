# Tools テスト仕様書

---

## 1. テスト戦略概要

### 1.1 テストの目的

Toolsアプリのテスト戦略は、主要ユーザーフローの動作保証、リグレッション防止、品質保証を目的としています。

### 1.2 テスト方針

- **スマホファースト**: モバイルデバイス（chromium-mobile）を優先してテスト
- **カバレッジ重視**: ビジネスロジック（`lib/`）のテストカバレッジ 80%以上を必須
- **自動化**: CI/CDパイプラインで自動テストを実行し、品質を担保
- **2段階テスト戦略**: Fast CI（高速フィードバック）と Full CI（完全検証）の2段階でテスト実行
- **E2Eでクリティカルパスをカバー**: 主要ユーザーフローを E2E テストで網羅

---

## 2. テストデバイス/ブラウザ構成

### 2.1 Playwright デバイス構成

| デバイス名       | 用途               | 画面サイズ  | User Agent              |
| ---------------- | ------------------ | ----------- | ----------------------- |
| chromium-desktop | デスクトップChrome | 1920x1080   | Chrome (最新安定版)     |
| chromium-mobile  | モバイルChrome     | Pixel 5相当 | Chrome Mobile (Android) |
| webkit-mobile    | モバイルSafari     | iPhone相当  | Safari Mobile (iOS)     |

### 2.2 テスト優先順位

プラットフォーム共通のCI戦略については、[ブランチ戦略 - CI/CD戦略](../../branching.md#cicd-戦略) を参照してください。

**概要**:
- **Fast CI**: `integration/**` へのPR時に chromium-mobile のみでテスト
- **Full CI**: `develop` へのPR時に全デバイスでテストし、カバレッジ80%以上を必須とする

---

## 3. カバレッジ目標

### 3.1 カバレッジ目標値

| カテゴリ                | カバレッジ目標     | 測定方法      |
| ----------------------- | ------------------ | ------------- |
| ビジネスロジック (lib/) | 80%以上（必須）    | Jest coverage |
| ユーティリティ関数      | 80%以上（必須）    | Jest coverage |
| UI コンポーネント       | 任意 (E2Eでカバー) | E2E テスト    |
| API Routes              | 任意 (E2Eでカバー) | E2E テスト    |

**重要**: Jest の `coverageThreshold` により、カバレッジ 80%未満の場合は自動的にテストが失敗します（Full CI）。

### 3.2 カバレッジ対象外

以下は Jest のカバレッジ対象外とします（E2E テストでカバー）:

- `app/**/page.tsx` - Next.js App Router の page コンポーネント
- `app/**/layout.tsx` - レイアウトコンポーネント
- `app/**/loading.tsx` - ローディングコンポーネント
- `app/**/error.tsx` - エラーコンポーネント
- `*.config.js` - 設定ファイル

### 3.3 カバレッジ計測方法

```bash
# カバレッジレポート生成
npm run test:coverage

# カバレッジ結果の確認
# - コンソール出力: サマリー
# - coverage/lcov-report/index.html: 詳細レポート
```

---

## 4. E2Eテストシナリオ

### 4.1 テストシナリオ一覧

| シナリオID | シナリオ名                     | 概要                                           | 優先度 | 対象デバイス |
| ---------- | ------------------------------ | ---------------------------------------------- | ------ | ------------ |
| E2E-001    | 乗り換え変換 - 基本操作        | 入力 → 変換 → コピーの基本操作                 | 高     | 全デバイス   |
| E2E-002    | クリップボード読み取り         | Clipboard API による読み取り機能               | 高     | 全デバイス   |
| E2E-003    | クリップボード書き込み         | Clipboard API による書き込み機能               | 高     | 全デバイス   |
| E2E-004    | Web Share Target               | URLパラメータ経由でのデータ受信                | 中     | 全デバイス   |
| E2E-005    | 表示設定の永続化               | LocalStorage への設定保存と復元                | 中     | 全デバイス   |
| E2E-006    | 初回訪問ダイアログ             | 初回訪問時のダイアログ表示と設定保存           | 中     | 全デバイス   |
| E2E-007    | エラーハンドリング - 無効入力  | 無効な入力形式、空入力、パース失敗時の処理     | 中     | 全デバイス   |
| E2E-008    | PWA機能                        | オフライン動作（Service Worker）、マニフェスト | 低     | 全デバイス   |
| E2E-009    | レスポンシブ表示               | モバイル/デスクトップ表示の確認                | 低     | 全デバイス   |
| E2E-010    | アクセシビリティ               | WCAG 2.1 Level AA 準拠確認                     | 低     | 全デバイス   |

### 4.2 シナリオ詳細

#### E2E-001: 乗り換え変換 - 基本操作

**目的**: 乗り換え変換ツールの主要ユーザーフローが正常に動作することを確認

**前提条件**:
- Toolsアプリが起動していること

**テスト手順**:
1. トップページにアクセス
2. 「乗り換え変換ツール」をクリック
3. 入力フィールドに乗り換え案内のテキストを貼り付け
4. 「変換」ボタンをクリック
5. 整形された結果が表示されることを確認
6. 「コピー」ボタンをクリック
7. 「コピーしました」のフィードバックが表示されることを確認

**期待結果**:
- パース結果が見やすい形式で表示される
- クリップボードにテキストがコピーされる
- フィードバックが適切に表示される

**テストファイル**: `tests/e2e/transit-converter.spec.ts`

---

#### E2E-002: クリップボード読み取り

**目的**: Clipboard API によるクリップボード読み取り機能が正常に動作することを確認

**前提条件**:
- クリップボードにテキストが保存されていること
- ブラウザが Clipboard API をサポートしていること

**テスト手順**:
1. 乗り換え変換ツールページにアクセス
2. 「クリップボード読み取り」ボタンをクリック
3. 入力フィールドにクリップボードの内容が挿入されることを確認

**期待結果**:
- クリップボードの内容が正しく入力フィールドに挿入される

**テストファイル**: `tests/e2e/clipboard.spec.ts`

---

#### E2E-004: Web Share Target

**目的**: URLパラメータ経由でのデータ受信が正常に動作することを確認

**前提条件**:
- PWA としてインストールされていること

**テスト手順**:
1. 他のアプリから「共有」でToolsアプリを選択
2. URLパラメータ `?text=...` または `?url=...` でデータを受信
3. 入力欄にデータが自動挿入されることを確認
4. URLパラメータがクリーンアップされることを確認

**期待結果**:
- 共有されたデータが正しく入力欄に挿入される
- URLパラメータが適切にクリーンアップされる

**テストファイル**: `tests/e2e/share-target.spec.ts`

---

#### E2E-005: 表示設定の永続化

**目的**: 表示設定がLocalStorageに保存され、次回訪問時に復元されることを確認

**前提条件**:
- 乗り換え変換ツールページにアクセス

**テスト手順**:
1. 詳細表示トグルの設定を変更
2. ページをリロード
3. 設定が復元されていることを確認

**期待結果**:
- LocalStorageに設定が保存される
- ページリロード後も設定が復元される

**テストファイル**: `tests/e2e/settings-persistence.spec.ts`

---

#### E2E-006: 初回訪問ダイアログ

**目的**: 初回訪問時にダイアログが表示され、設定が正しく保存されることを確認

**前提条件**:
- LocalStorageに初回訪問フラグが存在しないこと

**テスト手順**:
1. Toolsアプリに初回アクセス
2. ダイアログが自動表示されることを確認
3. 「今後表示しない」チェックボックスの動作を確認（ON/OFF）
4. 「閉じる」ボタンをクリック
5. LocalStorageにフラグが保存されることを確認
6. ページをリロード
7. ダイアログが表示されないことを確認

**期待結果**:
- 初回訪問時にダイアログが表示される
- 「今後表示しない」がONの場合、次回以降表示されない
- 「今後表示しない」がOFFの場合、次回も表示される

**テストファイル**: `tests/e2e/migration-dialog.spec.ts`

---

#### E2E-007: エラーハンドリング - 無効入力

**目的**: 無効な入力、空入力、パース失敗時のエラーハンドリングが正常に動作することを確認

**前提条件**:
- 乗り換え変換ツールページにアクセス

**テスト手順**:
1. 空の入力で「変換」ボタンをクリック
2. エラーメッセージが表示されることを確認
3. 対応していない形式のテキストを入力して「変換」ボタンをクリック
4. エラーメッセージが表示されることを確認

**期待結果**:
- 適切なエラーメッセージが表示される
- ユーザーが入力を修正できる状態が保たれる

**テストファイル**: `tests/e2e/error-handling.spec.ts`

---

## 5. ユニットテスト対象

### 5.1 テスト対象の分類

#### ビジネスロジック (lib/)

- **パーサー** (`lib/parsers/`)
    - 乗り換え案内テキストのパース処理
    - 日付、時刻、駅名、路線名の抽出
    - エラーケースのハンドリング

- **フォーマッター** (`lib/formatters/`)
    - パース結果の整形処理
    - 表示項目のフィルタリング
    - テキスト出力生成

- **クリップボードユーティリティ** (`lib/clipboard.ts`)
    - Clipboard API のラッパー
    - 読み取り・書き込み処理
    - エラーハンドリング

#### API Routes

- **Health API** (`app/api/health/route.ts`)
    - レスポンス形式の検証
    - バージョン情報の取得

### 5.2 テスト対象外

以下はユニットテストの対象外とします:

- ❌ Next.js App Router の page コンポーネント - E2Eテストでカバー
- ❌ レイアウトコンポーネント - E2Eテストでカバー
- ❌ UI コンポーネント（シンプルなもの）- E2Eテストでカバー
- ❌ 設定ファイル - テスト不要

---

## 6. テスト実行方法

### 6.1 ローカル環境での実行

#### ユニットテスト

```bash
# すべてのユニットテストを実行
npm run test

# ウォッチモード（ファイル変更時に自動実行）
npm run test:watch

# カバレッジレポート生成
npm run test:coverage

# 特定のテストファイルのみ実行
npm run test -- tests/unit/parsers.test.ts
```

#### E2Eテスト

```bash
# すべての E2E テストを実行
npm run test:e2e

# 特定のデバイスのみ実行
npm run test:e2e -- --project=chromium-mobile
npm run test:e2e -- --project=chromium-desktop
npm run test:e2e -- --project=webkit-mobile

# 特定のテストファイルのみ実行
npm run test:e2e tests/e2e/transit-converter.spec.ts

# UI モードで実行（デバッグ用）
npm run test:e2e:ui

# ブラウザ表示モード（headed モード）
npm run test:e2e:headed
```

### 6.2 CI環境での実行

#### GitHub Actions

GitHub Actions で自動実行されます:

**Fast CI** (`.github/workflows/tools-verify-fast.yml`):

- トリガー: `integration/**` ブランチへのPR
- テスト: ユニットテスト + E2E (chromium-mobile のみ)

**Full CI** (`.github/workflows/tools-verify-full.yml`):

- トリガー: `develop` ブランチへのPR
- テスト: ユニットテスト + カバレッジチェック + E2E (全デバイス)
- カバレッジ: 80%未満で失敗

---

## 7. CI/CD統合

### 7.1 ワークフロー構成

| ワークフロー           | トリガー               | 実行内容                                       |
| ---------------------- | ---------------------- | ---------------------------------------------- |
| tools-verify-fast      | PR to `integration/**` | ビルド、ユニット、E2E (chromium-mobile)        |
| tools-verify-full      | PR to `develop`        | ビルド、ユニット、カバレッジ、E2E (全デバイス) |
| tools-deploy           | Push to `develop` or `master` | デプロイ（テストは verify で完了済み）         |

### 7.2 ブランチ保護ルール

#### `integration/**` ブランチ

- ✅ PR 必須（直接プッシュ禁止）
- ✅ `tools-verify-fast` ワークフローの成功が必須

#### `develop` ブランチ

- ✅ PR 必須（直接プッシュ禁止）
- ✅ `tools-verify-full` ワークフローの成功が必須
- ✅ カバレッジ 80%以上の確保（Jest の `coverageThreshold` により自動チェック）

#### `master` ブランチ

- ✅ PR 必須（直接プッシュ禁止）
- ✅ 全ての CI/CD チェックの成功が必須
- ✅ レビュー承認が必須（推奨）

### 7.3 テスト失敗時の対応

#### ユニットテスト失敗

1. ローカルで再現確認: `npm run test`
2. 該当テストを修正
3. カバレッジを再確認: `npm run test:coverage`

#### E2Eテスト失敗

1. GitHub Actions のアーティファクトを確認（スクリーンショット、動画、トレース）
2. ローカルで再現確認: `npm run test:e2e:ui`
3. 不安定なテストの場合はリトライ設定を追加

#### カバレッジ不足

1. カバレッジレポートを確認: `coverage/lcov-report/index.html`
2. カバーされていないコードを特定
3. 必要なテストを追加

---

## 8. 既知の問題・制約

### 8.1 技術的制約

#### Clipboard API の制限

**問題内容**: Clipboard API はユーザーの明示的な操作（クリック等）が必要

**影響範囲**: クリップボード読み取り・書き込み機能

**回避策**: ユーザーがボタンをクリックした時のみ Clipboard API を実行

**将来の対応**: 現在の仕様で問題なし

---

## 9. テスト作成ガイドライン

### 9.1 ユニットテスト作成ガイドライン

#### 原則

- **純粋関数を優先**: 副作用のないテストしやすいコード
- **一つのテストで一つの検証**: テストケースを小さく保つ
- **AAA パターン**: Arrange（準備）、Act（実行）、Assert（検証）

#### 命名規則

```typescript
describe('{機能名}', () => {
    describe('{関数名}', () => {
        it('正常系: {説明}', () => {
            // テストコード
        });

        it('異常系: {説明}', () => {
            // テストコード
        });

        it('エッジケース: {説明}', () => {
            // テストコード
        });
    });
});
```

#### モック対象

以下のような副作用がある処理のみモック化:

- ブラウザAPI（navigator.clipboard、localStorage等）
- 外部API呼び出し
- Next.js ルーティング（useRouter 等）
- Date.now() などの時刻依存処理

### 9.2 E2Eテスト作成ガイドライン

#### 原則

- **ユーザー視点**: 実際の利用シナリオに沿って記述
- **安定性優先**: 不安定なテストは修正するか削除
- **独立性**: テスト間で状態を共有しない

#### テスト粒度

- 主要フローは細かくテスト
- 枝葉の機能は重要度に応じて判断
- 過度に細かいテストは避ける（メンテナンスコスト増）

---

## 10. トラブルシューティング

### 10.1 よくある問題

#### Playwright のブラウザがインストールされていない

**症状**: E2Eテスト実行時にブラウザが見つからないエラー

**原因**: Playwright のブラウザがインストールされていない

**解決方法**: `npx playwright install`

---

#### E2Eテストがタイムアウトする

**症状**: テストがタイムアウトエラーで失敗する

**原因**: ページの読み込みが遅い、または要素が見つからない

**解決方法**:
- タイムアウト時間を延長: `test.setTimeout(60000)`
- 要素の待機方法を見直し: `waitForSelector` の使用

---

### 10.2 デバッグ方法

#### ユニットテストのデバッグ

```bash
# 特定のテストのみ実行
npm run test -- tests/unit/parsers.test.ts

# デバッグ情報を出力
npm run test -- --verbose
```

#### E2Eテストのデバッグ

```bash
# UI モードで実行（ステップバイステップで確認）
npm run test:e2e:ui

# ブラウザ表示モードで実行
npm run test:e2e:headed

# トレースビューアーで結果を確認
npx playwright show-trace test-results/{trace-file}.zip
```

---

## 11. 参考資料

### プラットフォームドキュメント

- [テスト戦略 (全体方針)](../../development/testing.md)
- [コーディング規約](../../development/rules.md)
- [共通設定ファイル](../../development/configs.md)

### サービス固有ドキュメント

- [要件定義](./requirements.md)
- [アーキテクチャ設計](./architecture.md)
- [デプロイ・運用](./deployment.md)

### 外部ドキュメント

- [Playwright Documentation](https://playwright.dev/)
- [Jest Documentation](https://jestjs.io/)
- [@axe-core/playwright](https://github.com/dequelabs/axe-core-npm/tree/develop/packages/playwright)
