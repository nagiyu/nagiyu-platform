# Toolsアプリ 要件定義書

---

## 1. ビジネス要件

### 1.1 プロジェクト概要

Toolsアプリは、日常的な作業やデータ処理で使用する小さなツールを集約したWebアプリケーションです。
ブラウザ上で手軽に利用できるツール群を提供し、誰でも簡単に便利なツールを使えるプラットフォームを目指します。

**プロジェクト名**: Tools
**リポジトリ**: nagiyu-platform (monorepo)
**公開範囲**: 一般公開 (インターネット経由でアクセス可能)

### 1.2 目的と背景

#### 目的
- 日常的に便利なツール群を一般公開し、誰でも無料で利用できるサービスとして提供
- 頻繁に使用する小さなツールを、統合されたプラットフォームとして提供
- モダンな技術スタック (Next.js, Material UI, AWS) を活用した実用的なWebアプリケーション

#### 背景
- 日常的に使用する小さなツール (JSON整形、エンコード/デコード、乗り換え案内変換等) は多数存在するが、統合されたプラットフォームとして提供
- 自分自身が最も使うツールから優先的に実装
- シンプルで使いやすいUIを重視

### 1.3 ビジネス目標

1. **一般公開**: 誰でも無料でアクセスできるツール集として提供
2. **実用性**: 日常的に使いたいと思えるツール群の提供
3. **継続的な拡張**: 必要に応じて新しいツールを追加できる拡張可能な設計
4. **使いやすさ**: シンプルで直感的なUIによる高い利便性

**収益化**: 現時点では考慮しない (無料で全機能を提供)

### 1.4 対象ユーザー

#### プライマリーユーザー
- **本人 (自分自身)**: 最も重要なユーザー
    - 日常的な作業で使用
    - 新しいツールの要件定義者

#### セカンダリーユーザー
- **不特定多数の一般ユーザー**: インターネット経由でアクセスする全てのユーザー
    - 認証不要で誰でも利用可能
    - 開発者・非開発者を問わず利用可能
    - フィードバックは受け付けるが、個別要望には必ずしも対応しない

#### ユーザー属性
- **技術レベル**: 特に制約なし (直感的に使えるUIを提供)
- **デバイス**: PC、タブレット、スマートフォン (PWA対応)
- **ブラウザ**: モダンブラウザ (Chrome、Firefox、Safari、Edge の最新版)

---

## 2. 機能要件

### 2.1 機能一覧

#### フェーズ1: 初期実装

| ID | 機能名 | 説明 | 優先度 |
|----|--------|------|--------|
| F-001 | 乗り換え変換ツール | 乗り換え情報をパースし、必要項目のみ抽出してクリップボードにコピー | 最高 |
| F-002 | ツール一覧ページ | 利用可能なツールの一覧を表示 | 高 |
| F-003 | 共通ヘッダー/フッター | 全ツール共通のナビゲーション | 高 |
| F-004 | レスポンシブデザイン | PC/タブレット/スマートフォンに対応 | 高 |
| F-005 | PWA対応 | オフライン利用、ホーム画面追加 | 中 |
| F-006 | 初回訪問ダイアログ | 旧バージョンからの移行案内ダイアログを初回訪問時に表示 | 中 |

#### フェーズ2: 拡張機能 (将来実装)

| ID | 機能名 | 説明 | 優先度 |
|----|--------|------|--------|
| F-101 | JSON Formatter | JSONを整形して表示、検証 | 中 |
| F-102 | Base64 Encoder/Decoder | Base64エンコード/デコード | 中 |
| F-103 | Hash Generator | MD5、SHA-256等のハッシュ生成 | 中 |
| F-104 | URL Encoder/Decoder | URLエンコード/デコード | 低 |
| F-105 | Timestamp Converter | Unix timestamp ⇔ 日時変換 | 低 |

### 2.2 各機能の詳細要件

#### F-001: 乗り換え変換ツール

**概要**
乗り換え案内のテキストを入力として受け取り、必要な情報 (出発地、到着地、時刻、乗り換え経路等) を抽出し、整形された形式でクリップボードにコピーする。

**入力**
- 乗り換え案内のテキスト
- クリップボードから直接読み取り (ブラウザのClipboard API使用)
- 共有シート経由でのデータ受け取り（URLパラメータ `?url=...` / `?text=...`）

**処理**
- テキストエリアに手動で貼り付け、またはクリップボード読み取りボタンで自動取得
- テキストをパース
- 必要な情報を抽出:
    - 日付
    - 出発地
    - 到着地
    - 出発時刻 / 到着時刻
    - 所要時間
    - 乗り換え回数
    - 運賃
    - 距離
    - 経路詳細 (駅名、時刻範囲、路線名、番線情報)

**出力**
- 整形されたテキスト形式 (Plain Text)
- ユーザーが選択した項目のみを出力（詳細表示トグル機能）
- クリップボードへの自動コピー
- 画面上でのプレビュー表示

**詳細表示トグル機能**
ユーザーがチェックボックスで出力項目を選択可能:
- ✅ 日付を表示
- ✅ 出発地・到着地を表示
- ✅ 出発時刻・到着時刻を表示
- ✅ 所要時間を表示
- ✅ 運賃を表示
- ✅ 乗換回数を表示
- ☐ 距離を表示
- ✅ ルート詳細を表示
  - ✅ 駅名を表示
  - ✅ 時刻範囲を表示
  - ✅ 路線名を表示
  - ☐ 番線情報を表示

設定はLocalStorageに保存し、次回訪問時も保持する。

**制約**
- 乗り換え案内サービスのフォーマット変更に依存する
- スクレイピングではなく、コピーされたテキスト情報のパース

**実装方針**
- フロントエンドのみで処理 (JavaScript)

---

#### F-002: ツール一覧ページ

**概要**
利用可能なツールをカード形式で一覧表示し、各ツールへのナビゲーションを提供。

**表示内容**
- ツール名
- 説明 (1〜2行)
- アイコン
- カテゴリタグ

**機能**
- カテゴリによるフィルタリング (将来実装)
- 検索機能 (将来実装)

---

#### F-003: 共通ヘッダー/フッター

**ヘッダー**
- アプリ名「Tools」を表示
- 現時点ではナビゲーションメニューなし (シンプルな構成)

**フッター**
- アプリケーションバージョン表示
- 将来実装予定のリンク (プライバシーポリシー、利用規約)

---

#### F-004: レスポンシブデザイン

**対応デバイス**
- デスクトップ (1920x1080以上)
- タブレット (768x1024程度)
- スマートフォン (375x667以上)

**実装方針**
- Material UIのBreakpointsを活用
- モバイルファーストデザイン

---

#### F-005: PWA対応

**機能**
- マニフェストファイルの提供
- Service Workerによるオフラインキャッシュ
- ホーム画面への追加
- Web Share Target API対応（共有シート対応）

**範囲**
- 静的アセット (HTML, CSS, JS) のキャッシュ
- オフラインでも基本的なツールは動作

**Web Share Target API（共有シート対応）**
- スマートフォンの共有メニューからToolsアプリを起動可能
- 受け取れるデータ:
    - テキスト（乗り換え案内のテキスト）
    - URL（乗り換え案内のURL）
- マニフェストファイルに `share_target` 設定を追加
- URLパラメータで受け取る:
    - `?text=...` - 共有されたテキスト
    - `?url=...` - 共有されたURL
- 各ツールページで `useSearchParams()` を使用してパラメータを読み取り

**実装順序**
1. PWA基本機能（マニフェスト、Service Worker）
2. Web Share Target API対応

---

#### F-006: 初回訪問ダイアログ

**概要**
ユーザーが初めてToolsアプリにアクセスした際に、旧バージョンからの移行案内を表示するダイアログを実装する。

**背景**
- 約1年前から同じドメインで旧バージョンのToolsアプリ (同名) を運用
- 新バージョンではPWAマニフェストや仕様が変更されている
- 旧バージョンをインストール済みのユーザーに、再インストールを促す必要がある

**表示条件**
- LocalStorageに初回訪問フラグ (`tools-migration-dialog-shown`) が存在しない場合
- すべてのページで表示される (RootLayout配下に実装)

**ダイアログ内容**
- **タイトル**: 「Toolsアプリが新しくなりました」
- **本文**:
    ```
    このアプリは以前のバージョンから大幅にアップデートされました。
    以前のバージョンをインストールされている方は、お手数ですが以下の手順で再インストールをお願いします。

    1. 旧バージョンのアプリをアンインストール
    2. このページから新バージョンを再インストール

    ※ データはすべて端末内に保存されており、外部に送信されることはありません。
    ```
- **UI要素**:
    - ✅ 「今後表示しない」チェックボックス (デフォルトでチェック済み)
    - 「閉じる」ボタン

**動作仕様**
1. 初回訪問時にダイアログを自動表示
2. 「閉じる」ボタンクリック時の挙動:
    - チェックボックスがON: LocalStorageにフラグを保存し、次回以降表示しない
    - チェックボックスがOFF: フラグを保存せず、次回訪問時も表示する
3. 背景クリックではダイアログを閉じない (明示的な「閉じる」操作を要求)

**LocalStorage仕様**
- **キー**: `tools-migration-dialog-shown`
- **値**: `true` (文字列または真偽値)
- **保存タイミング**: 「今後表示しない」がONの状態で「閉じる」をクリックしたとき

**実装方針**
- Material UIの`Dialog`コンポーネントを使用
- Client Componentとして実装 (`src/components/dialogs/MigrationDialog.tsx`)
- `ThemeRegistry`コンポーネント内に配置し、全ページで表示可能にする
- LocalStorageアクセスは`useEffect`で初回レンダリング時に実行
- プライベートモードなどLocalStorageが使用できない環境でもエラーを起こさない

**制約事項**
- LocalStorageが無効化されている環境では、毎回ダイアログが表示される
- ブラウザのキャッシュクリア時にフラグもクリアされる

---

### 2.3 テスト要件

#### E2Eテスト対象
- **乗り換え変換ツールの主要ユーザーフロー**
    - 入力 → 変換 → コピーの基本操作
    - クリップボード読み取り機能
    - クリップボード書き込み機能
- **Web Share Target機能**
    - URLパラメータ経由でのデータ受信（`?url=...`, `?text=...`）
    - 入力欄への自動挿入
    - URLパラメータのクリーンアップ
- **表示設定の永続化**
    - LocalStorageへの設定保存
    - ページリロード後の設定復元
- **初回訪問ダイアログ機能**
    - 初回訪問時のダイアログ自動表示
    - 「今後表示しない」チェックボックスの動作 (ON/OFF)
    - 「閉じる」ボタンによるダイアログクローズ
    - LocalStorageへのフラグ保存と読み込み
    - 2回目以降の訪問時の表示制御
- **エラーハンドリング**
    - 無効な入力形式
    - 空入力
    - パース失敗時のエラー表示
- **PWA機能**
    - オフライン動作（Service Worker）
    - マニフェスト読み込み
- **レスポンシブ表示**
    - モバイル表示
    - デスクトップ表示

#### テスト環境
- **ブラウザ**: Chromium（デスクトップ/モバイル）、Safari（モバイル）
- **フレームワーク**: Playwright
- **アクセシビリティ**: @axe-core/playwright による WCAG 2.1 Level AA 準拠確認

#### テストカバレッジ目標
- 主要ユーザーフローの100%カバー
- 単体テスト: lib/parsers, lib/formatters, lib/clipboard
- E2Eテスト: ページ遷移、ユーザー操作、エラーシナリオ

---

### 2.4 優先順位

#### フェーズ1の実装順序

1. **F-002: ツール一覧ページ** - まず全体の枠組みを作成
2. **F-003: 共通ヘッダー/フッター** - 基本レイアウトの確立
3. **F-001: 乗り換え変換ツール** - 最優先の機能実装
4. **F-004: レスポンシブデザイン** - 全ページに適用
5. **F-005: PWA対応** - 最後に追加機能として実装

#### フェーズ2以降

- ユーザーフィードバックや自身のニーズに応じて、追加ツールを優先順位付け
- 各ツールは独立して実装可能な設計

---

## 3. 非機能要件

### 3.1 性能要件

#### レスポンスタイム
- ページ初回ロード: 3秒以内 (目標)
- ツール処理: 1秒以内 (一般的なサイズのデータ)
- ページ遷移: 0.5秒以内

#### スケーラビリティ
- 同時接続ユーザー数: 初期は100ユーザー程度を想定
- 将来的にCloudFrontのキャッシュやLambdaのスケーリングで対応

#### データサイズ制限
- 入力データサイズ: 10MB以内 (ブラウザのメモリ制限を考慮)
- 大きなファイル処理が必要な場合は別途検討

**備考**: 現時点では性能面の厳密な要求はなし。実運用で問題が発生した場合に最適化を検討。

---

### 3.2 可用性要件

#### 稼働率
- 目標稼働率: 99%以上 (ベストエフォート)
- メンテナンス時間: 事前通知なしでメンテナンス可能 (個人プロジェクトのため)

#### 障害対応
- 障害検知: CloudWatch Alarmsで監視
- 復旧時間: 24時間以内 (ベストエフォート)

**備考**: 一般公開サービスだが、SLAは保証しない。

---

### 3.3 セキュリティ要件

#### 基本方針
- ユーザー認証: 不要 (全機能を認証なしで提供)
- ユーザーデータ: サーバーに保存しない (処理はクライアント側またはステートレス)
- 個人情報: 取り扱わない

#### セキュリティ対策
- HTTPS通信 (CloudFront + ACM)
- CSP (Content Security Policy) ヘッダーの設定
- XSS対策 (Reactのデフォルトのエスケープ処理に依存)
- CORS設定 (必要に応じて)

#### データの取り扱い
- 入力データはブラウザ内で処理 (サーバーに送信しない方針)
- バックエンドAPIを使用する場合も、ログには機密情報を含めない

**備考**: 機密データを扱うツールは現時点で想定していない。

---

### 3.4 スケーラビリティ

#### 水平スケーリング
- CloudFrontによるコンテンツ配信
- Next.jsのStatic Generation (SSG) を活用
- APIはLambdaでステートレスに実装

#### 垂直スケーリング
- 現時点では不要
- 将来的にデータベースが必要になった場合はDynamoDBを検討

---

### 3.5 保守性

#### コード品質
- TypeScriptによる型安全性
- ESLint, Prettierによるコード規約の統一
- ユニットテスト (重要な処理のみ)

#### ドキュメント
- 本ドキュメント (要件定義、設計書) の維持
- コード内のコメント (複雑なロジックのみ)

#### 拡張性
- 新しいツールを追加しやすい設計
- コンポーネントの再利用性

---

## 4. ユースケース

### 4.1 ユーザーストーリー

#### US-001: 乗り換え情報を整形してコピーする

**As a** ユーザー
**I want to** 乗り換え案内の情報を簡単に整形してコピーしたい
**So that** 報告書やメール、チャットに貼り付ける際の手間を省ける

**受入基準**
- [ ] 乗り換え案内のテキストを入力できる
- [ ] パース結果が見やすい形式で表示される
- [ ] ワンクリックでクリップボードにコピーできる
- [ ] モバイル端末でも使いやすい

---

#### US-002: 利用可能なツールを一覧で確認する

**As a** 初めてのユーザー
**I want to** どんなツールが利用できるか一目で確認したい
**So that** 自分の目的に合ったツールをすぐに見つけられる

**受入基準**
- [ ] ツール一覧がカード形式で表示される
- [ ] 各ツールの説明が簡潔に記載されている
- [ ] クリックでツールページに遷移できる

---

#### US-003: オフラインでもツールを使いたい

**As a** モバイルユーザー
**I want to** インターネット接続がない環境でもツールを使いたい
**So that** 移動中や通信環境が悪い場所でも作業できる

**受入基準**
- [ ] PWAとしてホーム画面に追加できる
- [ ] オフラインでも基本的なツール (クライアント処理のみ) が動作する
- [ ] オンライン/オフライン状態が明確に表示される

---

### 4.2 主要なユースケースシナリオ

#### シナリオ1: 乗り換え情報をコピーする (正常系)

1. ユーザーがToolsアプリのトップページにアクセス
2. ツール一覧から「乗り換え変換ツール」を選択
3. 乗り換え変換ツールのページが表示される
4. ユーザーが乗り換え案内のテキストを入力フィールドに貼り付け
5. 「変換」ボタンをクリック
6. システムがテキストをパースし、必要な情報を抽出
7. 整形された結果が画面に表示される
8. ユーザーが「コピー」ボタンをクリック
9. クリップボードにテキストがコピーされる
10. 「コピーしました」のフィードバックが表示される

#### シナリオ2: 乗り換え情報のパースに失敗する (異常系)

1. ユーザーが乗り換え変換ツールのページを開く
2. 対応していない形式のテキストを入力
3. 「変換」ボタンをクリック
4. システムがパースを試みるが失敗
5. エラーメッセージが表示される：「テキストを解析できませんでした。乗り換え案内のテキストを確認してください。」
6. ユーザーは再度正しいテキストを入力できる

#### シナリオ3: PWAとしてインストールする

1. ユーザーがスマートフォンのブラウザでToolsアプリにアクセス
2. ブラウザが「ホーム画面に追加」のプロンプトを表示
3. ユーザーが「追加」をタップ
4. アプリアイコンがホーム画面に追加される
5. ホーム画面からアイコンをタップして起動
6. フルスクリーンモードで表示される (ブラウザのUIが非表示)

---

## 5. 制約事項

### 技術的制約

1. **ブラウザの制約**
    - モダンブラウザのみ対応 (IE11等のレガシーブラウザは非対応)
    - JavaScriptが有効である必要がある
    - クリップボードAPIが使用可能である必要がある

2. **データサイズ制約**
    - ブラウザのメモリ制限により、大きなデータの処理には限界がある
    - 入力データは10MB以内を推奨

3. **外部サービス依存**
    - 乗り換え案内サービスのフォーマット変更により、パース処理が動作しなくなる可能性
    - 定期的なメンテナンスが必要

### プロジェクト制約

1. **開発リソース**
    - 個人プロジェクトのため、開発速度は限定的
    - 複雑な機能は後回しにする

2. **コスト制約**
    - AWS無料枠の範囲内で運用 (可能な限り)
    - 大規模なトラフィックは想定しない

3. **保守体制**
    - 個人による保守のため、障害対応は迅速でない可能性
    - SLAは提供しない

---

## 6. 前提条件

### 技術的前提

1. **開発環境**
    - Node.js v22以上がインストールされている
    - AWS CLIがインストールされ、適切に設定されている
    - GitHub Actionsでの自動デプロイ環境が整備されている

2. **インフラ**
    - nagiyu-platformの共通基盤 (VPC, IAM, ACM等) が構築済み
    - CloudFrontディストリビューションが作成可能
    - S3バケットが作成可能

3. **ドメイン**
    - 外部DNSサービスでドメインが管理されている
    - CloudFrontへのCNAME設定が可能

---

## 7. 収益化機能

### 7.1 Google AdSense 統合

#### 概要

Toolsアプリに Google AdSense を統合し、広告収益化を実現する。
ルートドメイン (`nagiyu.com`) およびサブドメイン (`tools.nagiyu.com`) の両方で広告を表示する。

#### 背景

- 初期要件では収益化を考慮していなかったが、運用コストを賄うため広告収益化を導入
- ルートドメインで ECS 展開されているため、AdSense の審査要件を満たしている
- プライバシーポリシーと利用規約は既に実装済み

#### 機能ID: F-007

**機能名**: Google AdSense 広告表示

**優先度**: 中

**概要**:
Google AdSense の自動広告をページ内に表示し、広告収益を得る。

#### 要件詳細

##### 7.1.1 ads.txt の配置

**目的**:
IAB Tech Lab の仕様に準拠し、広告在庫の透明性を確保する。

**配置場所**:
- ファイルパス: `services/tools/public/ads.txt`
- アクセスURL: `https://nagiyu.com/ads.txt`

**内容**:
```plaintext
google.com, pub-6784165593921713, DIRECT, f08c47fec0942fa0
```

**仕様**:
- Content-Type: `text/plain`
- ステータスコード: `200 OK`
- ルートドメインの ads.txt がサブドメインにも自動適用される

##### 7.1.2 AdSense スクリプトの統合

**目的**:
Google AdSense の広告スクリプトを読み込み、自動広告を表示する。

**配置場所**:
- ファイルパス: `services/tools/src/app/layout.tsx`
- 配置箇所: `<head>` タグ内

**スクリプト**:
```tsx
<Script
    async
    src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6784165593921713"
    crossOrigin="anonymous"
    strategy="afterInteractive"
/>
```

**表示条件**:
- 本番環境のみ (`NODE_ENV === 'production'`)
- dev 環境では広告を表示しない

**対象ドメイン**:
- ✅ ルートドメイン: `nagiyu.com` (ECS)
- ✅ サブドメイン: `tools.nagiyu.com` (Lambda)

##### 7.1.3 広告タイプ

**採用する広告タイプ**: 自動広告

**理由**:
- 手動配置よりも最適化された広告配置
- メンテナンスコストが低い
- Google の機械学習による最適化

**将来の拡張**:
必要に応じて手動広告ユニットの追加を検討

##### 7.1.4 審査要件

**AdSense 審査申請**:
- ルートドメイン (`nagiyu.com`) を AdSense に登録
- サブドメインは個別登録不要（自動適用）

**審査通過の条件**:
- ads.txt が正しく配置されていること
- AdSense スクリプトが正しく読み込まれていること
- プライバシーポリシーが公開されていること（既に実装済み）
- 利用規約が公開されていること（既に実装済み）
- コンテンツがAdSense ポリシーに準拠していること

**審査期間**:
数日〜2週間程度

##### 7.1.5 パフォーマンス要件

**ページ読み込み速度**:
- 広告スクリプトはページ読み込みをブロックしない (`strategy="afterInteractive"`)
- Lighthouse パフォーマンススコアへの影響を最小限に抑える

**広告表示の遅延読み込み**:
- 必要に応じて遅延読み込みを実装

##### 7.1.6 プライバシー要件

**既存のプライバシーポリシー**:
- ✅ プライバシーポリシーダイアログが実装済み (`libs/ui/src/components/dialogs/PrivacyPolicyDialog.tsx`)
- ✅ Footer に「プライバシーポリシー」リンクが実装済み (`libs/ui/src/components/layout/Footer.tsx`)

**AdSense に関する追記**:
現時点では不要。必要に応じて将来追記を検討。

##### 7.1.7 モニタリング要件

**監視指標**:
- インプレッション数
- クリック数
- クリック率 (CTR)
- 推定収益
- ページ RPM（1000 インプレッションあたりの収益）
- ページ表示速度への影響

**監視ツール**:
- AdSense 管理画面のレポート
- Google Analytics（オプション）
- Lighthouse パフォーマンススコア

#### 制約事項

1. **広告ポリシー準拠**
    - Google AdSense のポリシーに準拠する必要がある
    - ポリシー違反によりアカウント停止のリスクがある

2. **審査の不確実性**
    - 審査に通過しない可能性がある
    - コンテンツ量が不足している場合、審査が不承認になる可能性

3. **パフォーマンス影響**
    - 広告表示によりページ読み込み速度が低下する可能性
    - ユーザー体験への影響を最小限に抑える必要がある

4. **収益の不確実性**
    - トラフィック量に依存するため、収益は保証されない
    - 初期段階では収益は限定的

#### 実装フェーズ

**Phase 1: 基本実装**
- ads.txt ファイルの作成
- AdSense スクリプトの統合
- ビルド & デプロイ

**Phase 2: 検証 & 審査**
- ads.txt のアクセス確認
- AdSense サイト登録 & 審査申請
- 審査通過待ち

**Phase 3: 監視 & 最適化**（オプション）
- 広告表示の確認
- パフォーマンス監視
- 収益レポートの確認

#### 受入基準

- [ ] `https://nagiyu.com/ads.txt` が正しくアクセスできること
- [ ] `https://tools.nagiyu.com/ads.txt` が正しくアクセスできること
- [ ] 本番環境でAdSense スクリプトが読み込まれていること
- [ ] dev 環境ではスクリプトが読み込まれないこと
- [ ] AdSense 審査に通過すること
- [ ] 両方のドメインで広告が表示されること
- [ ] ページの表示速度に大きな影響がないこと

#### 参考資料

- [IAB ads.txt Specification v1.1](https://iabtechlab.com/wp-content/uploads/2022/04/Ads.txt-1.1.pdf)
- [Google AdSense Help: Ads.txt guide](https://support.google.com/adsense/answer/12171612)
- [Ads.txt FAQs - Google AdSense Help](https://support.google.com/adsense/answer/9785052)
- [Next.js Script Component](https://nextjs.org/docs/app/api-reference/components/script)
