# Codec Converter - 要件定義

本ドキュメントは、Codec Converter サービスの要件を定義します。

---

## サービス概要

### 目的

動画ファイルのコーデック変換を簡単に行えるWebサービスを提供する。

### ターゲットユーザー

個人利用の一般ユーザー。動画のコーデック変換が必要だが、専門知識がない、または専門ツールのインストールが面倒なユーザーを想定。

### 提供価値

- ブラウザだけで簡単にコーデック変換ができる
- ソフトウェアのインストール不要
- 匿名で利用可能 (アカウント登録不要)

---

## 機能要件

### 1. 動画アップロード機能

**概要**: ユーザーが動画ファイルをアップロードする

**詳細**:
- **アップロード方法**: S3 Presigned URL を使用してブラウザから直接 S3 へアップロード
    - Lambda でアップロード用の Presigned URL を生成
    - フロントエンドから S3 へ直接アップロード
- **対応ファイル形式**: MP4 のみ (Phase 1)
    - フロントエンドで拡張子とMIMEタイプをチェック
- **ファイルサイズ上限**: 500MB
- **アップロード時の検証**:
    - ファイル形式チェック (拡張子、MIMEタイプ)
    - ファイルサイズチェック
    - ウイルススキャンは実施しない (Phase 1)

### 2. コーデック変換機能

**概要**: アップロードされた動画を指定したコーデックに変換する

**詳細**:
- **対応入力コーデック**: MP4 コンテナ内のすべてのコーデックを受け入れる
    - FFmpeg で処理できないコーデックの場合はエラーを返す
- **対応出力形式** (Phase 1):
    - H.264 (MP4 コンテナ)
    - VP9 (WebM コンテナ)
    - AV1 (WebM コンテナ)
- **変換オプション**: コーデック選択のみ
    - 解像度、ビットレート、フレームレートは自動設定 (元の動画の品質を維持)
    - 音声コーデックも自動選択 (コンテナに応じて AAC または Opus)
- **変換処理**: AWS Batch で実行
    - キューは FIFO (先入れ先出し)
    - タイムアウト: 2時間 (7200秒)
- **処理ツール**: FFmpeg

### 3. ジョブ管理機能

**概要**: 変換ジョブの状態を管理・表示する

**詳細**:
- **ジョブステータス**:
    - `PENDING`: アップロード完了、変換待ち
    - `PROCESSING`: 変換処理中
    - `COMPLETED`: 変換完了
    - `FAILED`: 変換失敗
- **ジョブ一覧表示**: ブラウザのローカルストレージで管理
    - ジョブ ID をローカルストレージに保存
    - ページを開くと保存されているジョブの状態を API で取得して表示
- **ジョブの保持期間**: 24時間
    - 変換完了後24時間でファイルと DynamoDB レコードを削除
- **進捗表示**: ステータスのみ表示 (パーセンテージは Phase 1 では非対応)
- **データ管理**: DynamoDB でジョブ情報を管理
    - ジョブ ID、ステータス、ファイル情報、作成日時など

### 4. ダウンロード機能

**概要**: 変換済み動画をダウンロードする

**詳細**:
- **ダウンロード方法**: S3 Presigned URL を使用
    - Lambda でダウンロード用の Presigned URL を生成
    - フロントエンドから S3 へ直接アクセス
- **ダウンロード有効期限**: Presigned URL の有効期限は24時間
    - ただし、ファイル自体は変換完了後24時間で削除される
- **ダウンロード回数制限**: なし
    - 有効期限内であれば何度でもダウンロード可能

### 5. ユーザー認証機能

**概要**: 認証機能は提供しない (匿名利用)

**詳細**:
- **認証方式**: なし
- **アカウント管理**: なし
- **アクセス制御**: ジョブ ID を知っている人は誰でもアクセス可能
    - ジョブ ID は UUID で推測困難

---

## 非機能要件

### パフォーマンス

- **同時実行可能なジョブ数**: 3ジョブ (Phase 1)
    - AWS Batch の Compute Environment で制御
    - 将来的に需要に応じて拡張可能
- **変換処理時間の目安**:
    - H.264: 実時間の 0.3-0.5倍 (30分動画 → 9-15分)
    - VP9: 実時間の 0.5-1.0倍 (30分動画 → 15-30分)
    - AV1: 実時間の 1.0-2.0倍 (30分動画 → 30-60分)
    - ※ インスタンスタイプや動画の複雑さにより変動
- **アップロード/ダウンロード速度**: ユーザーのネットワーク環境に依存
    - S3 への直接アップロード/ダウンロードのため、CloudFront 経由より高速

### スケーラビリティ

- **想定同時ユーザー数**: Phase 1 では制限なし (小規模想定)
    - フロントエンドは Lambda Web Adapter なので自動スケール
    - 処理キューは AWS Batch で管理
- **ピーク時の処理能力**: 同時3ジョブまで
    - それ以上はキューで待機

### セキュリティ

- **データの暗号化**:
    - S3: サーバー側暗号化 (SSE-S3) を有効化
    - 転送: すべて HTTPS で通信 (CloudFront + API Gateway + Lambda)
- **アクセス制御**:
    - ジョブ ID (UUID) による簡易的な制御
    - S3 バケットは非公開、Presigned URL のみでアクセス
- **ファイルのウイルススキャン**: Phase 1 では実施しない

### 可用性

- **稼働率目標**: 特に設定しない (ベストエフォート)
    - AWS のマネージドサービスに依存
- **バックアップ**: 実施しない
    - ファイルは24時間で削除される一時的なデータ
    - 元ファイルはユーザーが保持

### コスト

- **想定月間処理量**: Phase 1 では制限なし (実験的運用)
- **コスト最適化**:
    - ファイルは24時間で自動削除
    - Spot Instance の活用 (AWS Batch)
    - Lambda Web Adapter で不要時は課金なし

---

## 制約事項

### 技術的制約

- **ファイルサイズ上限**: 500MB
    - これ以上のファイルは Phase 2 以降で検討
- **変換タイムアウト**: 2時間
    - 超長時間の動画や極端に重いエンコードは失敗する可能性
- **Lambda の実行時間制限**: 15分
    - 重い処理は AWS Batch に委譲
    - API は軽量な処理のみ
- **対応コーデック**: FFmpeg で処理可能なもののみ
- **同時処理数**: 3ジョブまで

---

## 今後の拡張性

### Phase 2 以降で検討する機能

- **ファイル形式の拡張**: AVI, MOV, MKV など MP4 以外の入力形式に対応
- **ファイルサイズ上限の拡大**: 500MB 以上のファイルに対応
- **出力コーデックの追加**: H.265/HEVC など
- **変換オプションの拡充**:
    - 解像度変更 (720p, 1080p, 4K など)
    - ビットレート指定
    - フレームレート変更
- **進捗表示の改善**: パーセンテージや推定残り時間の表示
- **バッチ変換**: 複数ファイルを一度に変換
- **追加機能**:
    - サムネイル生成
    - 字幕の追加・編集
    - 動画の切り取り・結合
    - 音声抽出
- **ユーザー認証**: アカウント機能の追加
- **ファイル保持期間の延長**: 有料プランでの長期保存
- **ウイルススキャン**: セキュリティ強化

---

## 関連ドキュメント

- [アーキテクチャ](./architecture.md)
- [インフラ概要](./infra/README.md)
