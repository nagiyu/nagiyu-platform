# Codec Converter - UI 設計

本ドキュメントは、Codec Converter サービスの画面設計を説明します。

---

## 画面一覧

| 画面名 | パス | 説明 |
|-------|------|------|
| **トップページ** | `/` | 動画アップロードとコーデック選択 |
| **ジョブ詳細ページ** | `/jobs/:jobId` | ジョブステータス表示とダウンロード |

---

## 画面遷移図

![画面遷移図](../../images/apps/codec-converter/screen-transitions.drawio.svg)

**遷移フロー**:
1. ユーザーがトップページ (`/`) にアクセス
2. 動画ファイルをアップロード、コーデックを選択
3. ジョブ詳細ページ (`/jobs/:jobId`) へ自動遷移
4. ステータスが COMPLETED になったらダウンロード可能
5. トップページへ戻る (新しい変換ジョブを開始)

---

## トップページ (`/`)

### 概要
動画ファイルのアップロードとコーデック選択を行う画面。

### ワイヤーフレーム

![トップページ](../../images/apps/codec-converter/wireframe-top.drawio.svg)

### UI 要素

#### 1. ヘッダー
- **サービス名**: "Codec Converter"
- **説明**: "動画をアップロードして、コーデックを変換"

#### 2. ファイルアップロードエリア
- **表示**: ドラッグ&ドロップエリア
- **操作**:
    - ファイルをドラッグ&ドロップ
    - "ファイルを選択" ボタンをクリック
- **バリデーション**:
    - ファイル形式: `.mp4` のみ
    - ファイルサイズ: 最大 500MB
    - エラー時は赤文字でメッセージ表示

#### 3. ファイル情報表示
- **表示内容**:
    - ファイル名 (例: `sample.mp4`)
    - ファイルサイズ (例: `250MB`)
- **表示条件**: ファイルが選択されている場合のみ

#### 4. コーデック選択
- **選択肢**:
    - H.264 (MP4) - デフォルト選択
    - VP9 (WebM)
    - AV1 (WebM)
- **UI**: ラジオボタン
- **必須**: いずれか1つを選択

#### 5. 変換開始ボタン
- **ラベル**: "変換を開始"
- **状態**:
    - 有効: ファイルが選択されており、コーデックが選択されている
    - 無効: ファイル未選択またはバリデーションエラー
- **操作**: クリック時にジョブを作成し、ジョブ詳細ページへ遷移

#### 6. 制約表示
- **表示内容**:
    - "MP4 ファイルのみ対応"
    - "最大ファイルサイズ: 500MB"
- **スタイル**: 小さめのグレー文字

### 操作フロー

1. **ファイル選択**:
    - ユーザーがファイルをドラッグ&ドロップまたは選択
    - バリデーション実行 (形式、サイズ)
    - エラー時はメッセージ表示、成功時はファイル情報表示

2. **コーデック選択**:
    - ユーザーがコーデックを選択 (デフォルト: H.264)

3. **変換開始**:
    - "変換を開始" ボタンをクリック
    - フロントエンドが `POST /api/jobs` を呼び出し
    - Presigned URL を取得
    - S3 へファイルをアップロード (進捗表示)
    - HTTP 200 OK レスポンスでアップロード完了を検知
    - アップロード完了後、`POST /api/jobs/:jobId/submit` を呼び出し
    - ジョブ詳細ページ (`/jobs/:jobId`) へ遷移
    - アップロード失敗時（4xx, 5xx）はエラーメッセージを表示し、再試行を促す

### バリデーション

| 項目 | ルール | エラーメッセージ |
|-----|--------|----------------|
| ファイル形式 | `.mp4` のみ | "MP4 ファイルのみアップロードできます" |
| ファイルサイズ | 最大 500MB | "ファイルサイズは 500MB 以下にしてください" |
| ファイル選択 | 必須 | "ファイルを選択してください" |

---

## ジョブ詳細ページ (`/jobs/:jobId`)

### 概要
変換ジョブのステータスを表示し、完了後にダウンロードを行う画面。

### ワイヤーフレーム

**処理中**:

![ジョブ詳細ページ (処理中)](../../images/apps/codec-converter/wireframe-job-processing.drawio.svg)

**完了**:

![ジョブ詳細ページ (完了)](../../images/apps/codec-converter/wireframe-job-completed.drawio.svg)

### UI 要素

#### 1. ヘッダー
- **サービス名**: "Codec Converter"
- **ページタイトル**: "ジョブ詳細"

#### 2. ジョブ ID 表示
- **表示**: `ジョブ ID: {jobId}`
- **スタイル**: 小さめのグレー文字、コピー可能

#### 3. ステータス表示

**PENDING (待機中)**:
- アイコン: ⏸️
- メッセージ: "待機中..."
- 説明: "他のジョブが完了するまでお待ちください"

**PROCESSING (処理中)**:
- アイコン: ⏳
- メッセージ: "処理中..."
- プログレスバー: アニメーション付き (不確定)
- 説明: "動画を変換しています"

**COMPLETED (完了)**:
- アイコン: ✓
- メッセージ: "変換完了"
- ダウンロードボタン: "ダウンロード" (大きめ、目立つ色)

**FAILED (失敗)**:
- アイコン: ✗
- メッセージ: "変換に失敗しました"
- エラーメッセージ: 詳細を表示 (例: "サポートされていないコーデックです")

#### 4. ジョブ情報表示

**共通情報**:
- 入力ファイル名
- 出力コーデック
- 作成日時

**完了時に追加**:
- 出力ファイル名
- 完了日時

#### 5. ダウンロードボタン
- **表示条件**: status が COMPLETED の場合のみ
- **操作**: クリック時に `GET /api/jobs/:jobId/download` を呼び出し、Presigned URL を取得してダウンロード

#### 6. 注意事項
- **表示**: "⚠ 注意: ファイルは 24時間後に削除されます"
- **スタイル**: 小さめの赤文字

#### 7. トップページに戻るボタン
- **ラベル**: "トップページに戻る"
- **操作**: `/` へ遷移

### 操作フロー

1. **ページ表示**:
    - URL から `jobId` を取得
    - ローカルストレージに `jobId` を保存
    - `GET /api/jobs/:jobId` を呼び出し、ジョブ情報を取得

2. **ステータスポーリング**:
    - 5秒ごとに `GET /api/jobs/:jobId` を呼び出し
    - ステータスが COMPLETED または FAILED になるまで継続
    - ステータスに応じて UI を更新

3. **ダウンロード**:
    - ユーザーが "ダウンロード" ボタンをクリック
    - `GET /api/jobs/:jobId/download` を呼び出し
    - Presigned URL を取得
    - ブラウザで自動ダウンロード

4. **トップページへ戻る**:
    - ユーザーが "トップページに戻る" ボタンをクリック
    - `/` へ遷移

### ステータス別の表示

| ステータス | アイコン | メッセージ | プログレスバー | ダウンロードボタン |
|----------|---------|----------|--------------|-----------------|
| PENDING | ⏸️ | "待機中..." | なし | なし |
| PROCESSING | ⏳ | "処理中..." | あり (アニメーション) | なし |
| COMPLETED | ✓ | "変換完了" | なし | あり |
| FAILED | ✗ | "変換に失敗しました" | なし | なし |

---

## UI コンポーネント

### 1. ファイルアップロードコンポーネント
- ドラッグ&ドロップエリア
- ファイル選択ボタン
- ファイル情報表示
- バリデーションメッセージ

### 2. コーデック選択コンポーネント
- ラジオボタングループ
- コーデック名と拡張子表示

### 3. ジョブステータスコンポーネント
- ステータスアイコン
- メッセージ
- プログレスバー (PROCESSING 時)

### 4. ダウンロードボタンコンポーネント
- ボタン (COMPLETED 時のみ表示)
- Presigned URL 取得とダウンロード処理

---

## レスポンシブデザイン

### モバイル (< 768px)
- 1カラムレイアウト
- ファイルアップロードエリアを縦長に調整
- ボタンを全幅表示

### タブレット (768px - 1024px)
- 1カラムレイアウト
- ファイルアップロードエリアを横長に調整

### デスクトップ (> 1024px)
- 中央寄せレイアウト (最大幅 800px)
- ファイルアップロードエリアを横長に調整

---

## アクセシビリティ

### キーボード操作
- Tab キーでフォーカス移動
- Enter キーでボタン操作

### スクリーンリーダー
- 適切な `aria-label` を設定
- ステータス変更時に `aria-live` で通知

### カラーコントラスト
- WCAG 2.1 AA 基準を満たす

---

## エラーハンドリング

### 1. アップロード失敗（S3 への PUT 失敗）
- **検知**: HTTP 4xx, 5xx レスポンス
- **メッセージ**: "アップロードに失敗しました。もう一度お試しください。"
- **UI**: トップページでエラーメッセージ表示
- **アクション**: 「再試行」ボタンで最初からやり直し

### 2. Batch ジョブ投入失敗
- **検知**: `POST /api/jobs/:jobId/submit` が失敗（HTTP 4xx, 5xx）
- **メッセージ**: "ジョブの投入に失敗しました。もう一度お試しください。"
- **UI**: エラーメッセージと「再試行」ボタンを表示
- **アクション**: 再度 `POST /api/jobs/:jobId/submit` を呼び出し
- **特殊ケース**: 409 Conflict（既に投入済み）の場合は、ジョブ詳細ページへ遷移

### 3. Batch ジョブ実行失敗（FFmpeg エラーなど）
- **検知**: ポーリングで status: FAILED を検知
- **メッセージ**: "変換に失敗しました"
- **UI**: ジョブ詳細ページでエラーメッセージ表示（DynamoDB の errorMessage を表示）
- **アクション**: トップページへ戻って最初からやり直し

### 4. ネットワークエラー
- **検知**: fetch/XHR がネットワークエラーを返す
- **メッセージ**: "ネットワークエラーが発生しました。もう一度お試しください。"
- **UI**: エラーメッセージと再試行ボタンを表示

### 5. ジョブが見つからない
- **検知**: `GET /api/jobs/:jobId` が 404 を返す
- **メッセージ**: "ジョブが見つかりませんでした。ジョブ ID を確認してください。"
- **UI**: エラーメッセージとトップページへ戻るボタンを表示

### 6. ダウンロードエラー
- **検知**: `GET /api/jobs/:jobId/download` が失敗
- **メッセージ**: "ダウンロードに失敗しました。もう一度お試しください。"
- **UI**: エラーメッセージと再試行ボタンを表示

---

## ローカルストレージ

### 保存データ

```json
{
  "codecConverter": {
    "jobs": [
      {
        "jobId": "uuid",
        "createdAt": 1234567890
      }
    ]
  }
}
```

### 使用目的
- ジョブ ID を保存し、ユーザーが過去のジョブを確認できるようにする
- ページをリロードしてもジョブ詳細ページに戻れるようにする

### データ管理
- サーバー側（S3, DynamoDB）のデータは24時間後に自動削除される
- localStorage のジョブ ID は自動削除せず、ブラウザに保持される
- 古いジョブ ID が残っていても、サーバー側のデータが削除されるため実害なし（API は 404 を返す）
- ユーザーがブラウザキャッシュをクリアすれば自然に削除される

---

## 関連ドキュメント

- [要件定義](./requirements.md)
- [アーキテクチャ](./architecture.md)