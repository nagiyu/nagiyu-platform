# アーキテクチャ方針

## 目的

本ドキュメントは、サービス設計における基本的なアーキテクチャ方針と推奨パターンを定義する。

## レイヤー分離の原則

### サービス固有パッケージの分離

サービスは以下のパッケージに分離することで、責務を明確化する：

- **core**: ビジネスロジック層
  - フレームワーク非依存のビジネスロジック
  - 純粋関数として実装
  - Unit Test 必須
  - 相対パスで import（path alias 使用不可）
- **web**: プレゼンテーション層
  - Next.js + React による UI 実装
  - E2E Test 主体
  - path alias（`@/`）使用可能
- **batch**: バッチ処理層
  - 定期実行やイベント駆動の処理
  - Lambda などでの実行を想定
  - Unit Test 必須

### 基本方針

- **UI層とビジネスロジックの分離**: プレゼンテーション（`web/`）とビジネスロジック（`core/`）を明確に分離
- **core/ 配下の構成は自由**: サービスの特性に応じて最適な構成を選択

### 依存関係の原則

```
web   → core → libs/common
      → libs/ui → libs/browser → libs/common

batch → core → libs/common
```

- **web** と **batch** は **core** に依存可能
- **core** は UI に依存しない（web, libs/ui への依存禁止）
- **core** は相対パスで import（path alias 不使用）

### 分離の利点

- ユニットテストの容易性（ビジネスロジックを独立してテスト可能）
- コンポーネントの再利用性向上
- 責務の明確化
- バッチ処理の追加が容易

## 推奨アーキテクチャパターン

### Parser/Formatter パターン

入力データの変換処理を行うサービスに適用。

#### 構成

- **Parser**: 入力データのバリデーション＋構造化
- **Formatter**: 構造化データ＋設定 → 出力データ

#### 適用ケース

- テキスト変換ツール
- データフォーマット変換
- 入力の正規化が必要な処理

#### 設計のポイント

- エラーメッセージは定数化して管理
- Parser と Formatter は純粋関数として実装
- 中間データ構造を型定義

### その他のパターン

サービスの特性に応じて、以下のようなパターンも検討：

- **Repository パターン**: データアクセス層の抽象化
- **Service パターン**: 複雑なビジネスロジックのカプセル化
- **Hook パターン**: React固有のロジックの再利用

## State Management

### 基本方針

- **React Hooks**: useStateやuseReducerで管理
- **localStorage**: 永続化が必要な設定値
- **外部ライブラリは慎重に**: 必要性を十分検討してから導入

### localStorage の扱い

- SSR対応: useEffect内でアクセス
- エラーハンドリング: プライベートモードやクォータ超過に対応
- 共通ライブラリのラッパーを利用

## コーディング規約

### TypeScript

- **strict mode 必須**: 厳格な型チェックを有効化
- **型定義の配置**: `types/` ディレクトリに集約
- **デフォルト値とセット**: 型定義と一緒にデフォルト値を定義

### エラーハンドリング

- **日本語メッセージ**: ユーザー向けエラーは日本語で
- **定数化**: エラーメッセージは定数オブジェクトで管理
- **ユーザーフレンドリー**: 技術的な詳細より対処方法を優先

#### エラーハンドリング戦略

プラットフォームでは、統一されたエラーハンドリング戦略を採用しています。

##### 3層エラー処理モデル

APIエラーを3つの層で処理します：

1. **リトライ層（Retry Layer）**
   - 一時的なエラー（ネットワークエラー、サーバーエラー、タイムアウト、429 Too Many Requests）に対する自動リトライ
   - エクスポネンシャルバックオフ戦略を使用
   - リトライ可能性の判定ロジックによる制御

2. **変換層（Transform Layer）**
   - 技術的なエラーコードをユーザーフレンドリーな日本語メッセージに変換
   - 2段階マッピング: サービス固有メッセージ → 共通メッセージ
   - フォールバック機構による確実なメッセージ提供

3. **表示層（Display Layer）**
   - エラーメッセージをUIに表示（トースト通知、エラーダイアログなど）
   - React統合によるシームレスな表示
   - エラータイプ（error/warning/info）に応じた適切な表示

##### エクスポネンシャルバックオフ戦略

リトライ時の遅延時間を指数関数的に増加させることで、サーバーへの負荷を分散：

- **初回遅延**: 1秒
- **増加率**: 2倍（カスタマイズ可能）
- **最大遅延**: 10秒（カスタマイズ可能）
- **ジッター**: 遅延時間の±25%のランダム値を追加（複数クライアントの同時リトライを分散）

計算式: `delay = min(initialDelay × backoffMultiplier^attempt, maxDelay) ± jitter`

##### リトライ可能性の判定ロジック

以下のエラーはリトライ可能と判定されます：

- ネットワークエラー（`status === 0`）
- タイムアウト（`status === 408`）
- サーバーエラー（`status >= 500`）
- Too Many Requests（`status === 429`）

クライアントエラー（4xx、401/408/429を除く）はリトライされません。

詳細は [api-client-guide.md](./api-client-guide.md) を参照。

### コードフォーマット

- **Prettier**: モノレポ全体で統一設定を使用
- **ESLint**: Next.js公式設定をベースに拡張

## ブラウザ API の扱い

### ラッパー化の推奨

以下のAPIは共通ライブラリのラッパーを使用：

- Clipboard API
- localStorage / sessionStorage
- その他ブラウザ固有API

### 理由

- エラーハンドリングの統一
- テストの容易性
- ブラウザ互換性の吸収

## 共通ライブラリの活用

### 依存関係の原則

- `libs/ui/`: Next.js + Material-UI 依存
- `libs/browser/`: ブラウザAPI依存
- `libs/common/`: 完全フレームワーク非依存
- `libs/react/`: React依存、`@nagiyu/common`に依存

### パッケージ構成

プラットフォームは以下のパッケージで構成されています：

#### 共通パッケージ (libs/\*)

| パッケージ        | 責務                                        | 依存              | 主な機能                         |
| ----------------- | ------------------------------------------- | ----------------- | -------------------------------- |
| `@nagiyu/common`  | フレームワーク非依存の汎用ユーティリティ    | なし              | APIクライアント、認証、型定義    |
| `@nagiyu/browser` | ブラウザAPI依存のユーティリティ             | `@nagiyu/common`  | Clipboard、localStorage ラッパー |
| `@nagiyu/ui`      | Next.js + Material-UI依存のUIコンポーネント | `@nagiyu/browser` | Header、Footer、ThemeRegistry    |
| `@nagiyu/react`   | React統合のユーティリティとフック           | `@nagiyu/common`  | useAPIRequest、React用ヘルパー   |

#### APIクライアントパッケージ

APIリクエスト処理は以下のパッケージで提供されます：

- **@nagiyu/common**:
  - `apiRequest<T>()` 関数（リトライ、エラーハンドリング）
  - `get()`, `post()`, `put()`, `del()` ラッパー関数
  - `APIError` クラスと型定義
  - エラーメッセージ定数（`COMMON_ERROR_MESSAGES`）

- **@nagiyu/react**:
  - `useAPIRequest<T>()` フック（状態管理、React統合）
  - `onSuccess`/`onError` コールバック機能
  - リトライ・リセット機能

詳細は [shared-libraries.md](./shared-libraries.md) および [api-client-guide.md](./api-client-guide.md) を参照。

## パフォーマンス

### 基本方針

- **過度な最適化は避ける**: 必要になってから対応
- **測定してから最適化**: 推測ではなく計測に基づく
- **スマホファースト**: モバイル環境での動作を優先

### 推奨事項

- 画像の最適化（Next.js Image コンポーネント）
- 不要な再レンダリングの削減（React.memo、useMemo）
- バンドルサイズの監視

## セキュリティ

### 基本原則

- **入力のバリデーション**: すべての外部入力を検証
- **XSS対策**: Reactのデフォルト挙動を信頼、dangerouslySetInnerHTMLは避ける
- **環境変数の管理**: 秘密情報はビルド時変数に含めない

## 参考

- [rules.md](./rules.md): コーディング規約・べからず集
- [service-template.md](./service-template.md): サービステンプレート
- [testing.md](./testing.md): テスト戦略
- [shared-libraries.md](./shared-libraries.md): 共通ライブラリ設計
