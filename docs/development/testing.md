# テスト戦略

## 目的

本ドキュメントは、プラットフォームにおけるテスト方針と戦略を定義する。

## 基本方針

- **スマホファースト**: モバイル環境でのテストを優先
- **品質とスピードのバランス**: 必要十分なテストカバレッジを目指す
- **自動化**: CI/CDで継続的にテストを実行

## テストディレクトリ構成

### 標準構成

```
services/{service-name}/
├── tests/
│   ├── unit/           # ユニットテスト（Jest）
│   └── e2e/            # E2Eテスト（Playwright）
```

### 設計思想

- テストコードを `tests/` 配下に集約
- テストの種類ごとにディレクトリを分離
- 実装コード（`src/`）とテストコードを明確に区分

## ユニットテスト

### フレームワーク

- **Jest**: テストランナー
- **Testing Library**: Reactコンポーネントテスト

### テスト対象

- **ビジネスロジック（lib/）を重点的に**: 純粋関数、データ変換処理
- **重要なユーティリティ関数**: エラーハンドリング、バリデーション
- **複雑なコンポーネントロジック**: 状態管理、条件分岐

### カバレッジ目標

- **ビジネスロジック: 80%以上**
- UI層は必要に応じて（E2Eでカバーされる部分は省略可）

### 共通設定

`configs/jest.config.base.ts` を extends して使用。詳細は [configs.md](./configs.md) を参照。

### モック対象

- ブラウザAPI（navigator.clipboard、localStorage等）
- 外部API呼び出し
- Next.jsルーティング

## E2Eテスト

### フレームワーク

- **Playwright**: クロスブラウザE2Eテスト

### テスト対象

- **主要な機能フロー**: ユーザーが実行する典型的な操作
- **クリティカルパス**: 必ず動作すべき重要機能
- **PWA機能**: オフライン動作、インストール（PWA対応サービスのみ）

### テストデバイス

#### 標準構成

- **chromium-desktop**: Desktop Chrome（1920x1080）
- **chromium-mobile**: モバイルChrome（Pixel 5想定）
- **webkit-mobile**: モバイルSafari（iPhone想定）

#### スマホファーストの実践

モバイル環境を優先してテスト。デスクトップは補助的に確認。

### アクセシビリティテスト

#### 対象サービス

一般公開されるサービスでは実施を推奨。

#### ツール

- **axe-core**: 自動アクセシビリティチェック
- Playwrightと統合して実行

#### チェック項目

- WCAG 2.1 Level AA準拠
- キーボード操作
- スクリーンリーダー対応

## CI戦略

### 2段階CI

#### ci-fast（高速フィードバック）

- **トリガー**: integration/** ブランチへのPR
- **対象**: chromium-mobile のみ
- **目的**: 開発中の素早いフィードバック

#### ci-full（完全テスト）

- **トリガー**: develop/master ブランチへのPR・マージ
- **対象**: 全3種デバイス
- **カバレッジチェック**: 80%未満で失敗

### CI最適化

- 並列実行数の調整
- 失敗時のスクリーンショット・動画記録
- リトライ設定（不安定なテストへの対処）

## テスト作成ガイドライン

### ユニットテスト

#### 原則

- **純粋関数を優先**: 副作用のないテストしやすいコード
- **一つのテストで一つの検証**: テストケースを小さく保つ
- **AAA パターン**: Arrange（準備）、Act（実行）、Assert（検証）

#### 命名規則

```typescript
describe('機能名', () => {
  describe('関数名', () => {
    it('正常系: 説明', () => { /* ... */ });
    it('異常系: 説明', () => { /* ... */ });
    it('エッジケース: 説明', () => { /* ... */ });
  });
});
```

### E2Eテスト

#### 原則

- **ユーザー視点**: 実際の利用シナリオに沿って記述
- **安定性優先**: 不安定なテストは修正するか削除
- **独立性**: テスト間で状態を共有しない

#### テスト粒度

- 主要フローは細かくテスト
- 枝葉の機能は重要度に応じて判断
- 過度に細かいテストは避ける（メンテナンスコスト増）

## テストの実行

### ローカル環境

```bash
# ユニットテスト
npm test
npm run test:watch
npm run test:coverage

# E2Eテスト
npm run test:e2e
npm run test:e2e:ui       # UIモード（デバッグ用）
npm run test:e2e:headed   # ブラウザ表示モード
```

### CI環境

GitHub Actionsで自動実行。

## 参考

- [service-template.md](./service-template.md): サービステンプレート
- [architecture.md](./architecture.md): アーキテクチャ方針
- [configs.md](./configs.md): 共通設定ファイル
