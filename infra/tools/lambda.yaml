AWSTemplateFormatVersion: '2010-09-09'
Description: 'Lambda Function for Tools Application'

Parameters:
  Environment:
    Type: String
    AllowedValues: [dev, prod]
    Default: dev

  ImageUri:
    Type: String
    Description: ECR Image URI

Resources:
  ToolsLambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'tools-lambda-execution-role-${Environment}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole'

  ToolsLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub 'tools-app-${Environment}'
      PackageType: Image
      Code:
        ImageUri: !Ref ImageUri
      Role: !GetAtt ToolsLambdaExecutionRole.Arn
      Timeout: 30
      MemorySize: 1024
      Environment:
        Variables:
          NODE_ENV: production
          APP_VERSION: '1.0.0'

  ToolsLambdaFunctionUrl:
    Type: AWS::Lambda::Url
    Properties:
      AuthType: NONE
      TargetFunctionArn: !Ref ToolsLambdaFunction

  ToolsLambdaFunctionUrlPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ToolsLambdaFunction
      Action: 'lambda:InvokeFunctionUrl'
      Principal: '*'
      FunctionUrlAuthType: NONE

Outputs:
  LambdaFunctionArn:
    Description: Lambda Function ARN
    Value: !GetAtt ToolsLambdaFunction.Arn
    Export:
      Name: !Sub '${AWS::StackName}-FunctionArn'

  LambdaFunctionUrl:
    Description: Lambda Function URL
    Value: !GetAtt ToolsLambdaFunctionUrl.FunctionUrl
    Export:
      Name: !Sub '${AWS::StackName}-FunctionUrl'
