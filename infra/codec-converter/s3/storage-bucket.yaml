AWSTemplateFormatVersion: '2010-09-09'
Description: |
  S3 storage bucket for Codec Converter service.
  This bucket stores uploaded input files and converted output files using prefixes:
  - uploads/{jobId}/ - Original uploaded MP4 files
  - outputs/{jobId}/ - Converted video files
  All objects are automatically deleted after 24 hours via lifecycle policy.

Parameters:
  Environment:
    Type: String
    Description: Environment name (dev or prod)
    AllowedValues:
      - dev
      - prod
    Default: dev

Conditions:
  IsDevEnvironment: !Equals [!Ref Environment, dev]

Resources:
  StorageBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      BucketName: !Sub 'codec-converter-${Environment}-${AWS::AccountId}'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Suspended
      LifecycleConfiguration:
        Rules:
          - Id: DeleteAfter24Hours
            Status: Enabled
            ExpirationInDays: 1
            Prefix: ''
      CorsConfiguration:
        CorsRules:
          - AllowedOrigins:
              - !If
                - IsDevEnvironment
                - 'http://localhost:3000'
                - 'https://codec-converter.example.com'
            AllowedMethods:
              - GET
              - PUT
              - POST
              - DELETE
              - HEAD
            AllowedHeaders:
              - '*'
            MaxAge: 3600
      Tags:
        - Key: Name
          Value: !Sub 'codec-converter-storage-${Environment}'
        - Key: Environment
          Value: !Ref Environment
        - Key: Purpose
          Value: 'Temporary storage for video conversion uploads and outputs'

  # Bucket policy to enforce security best practices
  StorageBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref StorageBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          # Deny all non-SSL requests (enforce HTTPS)
          - Sid: DenyInsecureTransport
            Effect: Deny
            Principal: '*'
            Action: 's3:*'
            Resource:
              - !GetAtt StorageBucket.Arn
              - !Sub '${StorageBucket.Arn}/*'
            Condition:
              Bool:
                'aws:SecureTransport': 'false'
          # Deny requests without proper encryption
          - Sid: DenyUnencryptedObjectUploads
            Effect: Deny
            Principal: '*'
            Action: 's3:PutObject'
            Resource: !Sub '${StorageBucket.Arn}/*'
            Condition:
              StringNotEquals:
                's3:x-amz-server-side-encryption': 'AES256'

Outputs:
  StorageBucketName:
    Description: Name of the S3 storage bucket
    Value: !Ref StorageBucket
    Export:
      Name: !Sub 'codec-converter-s3-bucket-name-${Environment}'

  StorageBucketArn:
    Description: ARN of the S3 storage bucket
    Value: !GetAtt StorageBucket.Arn
    Export:
      Name: !Sub 'codec-converter-s3-bucket-arn-${Environment}'

  StorageBucketDomainName:
    Description: Domain name of the S3 storage bucket
    Value: !GetAtt StorageBucket.RegionalDomainName
    Export:
      Name: !Sub 'codec-converter-s3-bucket-domain-${Environment}'
