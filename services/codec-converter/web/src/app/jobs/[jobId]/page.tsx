'use client';

import React, { useState, useEffect, useCallback } from 'react';
import { useRouter } from 'next/navigation';
import {
  type Job,
  type JobStatus,
  type CodecType,
  formatFileSize,
  formatDateTime,
  formatJobId,
} from 'codec-converter-core';
import {
  Container,
  Typography,
  Card,
  CardContent,
  Chip,
  Button,
  Alert,
  Stack,
  Box,
} from '@mui/material';
import RefreshIcon from '@mui/icons-material/Refresh';
import DownloadIcon from '@mui/icons-material/Download';
import AddIcon from '@mui/icons-material/Add';

// ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å®šæ•°
const ERROR_MESSAGES = {
  FETCH_FAILED: 'ã‚¸ãƒ§ãƒ–æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ',
  JOB_NOT_FOUND: 'æŒ‡å®šã•ã‚ŒãŸã‚¸ãƒ§ãƒ–ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
} as const;

// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ã®è‰²è¨­å®šï¼ˆWCAG AAæº–æ‹ ï¼‰
const STATUS_COLORS: Record<JobStatus, 'warning' | 'info' | 'success' | 'error'> = {
  PENDING: 'warning',
  PROCESSING: 'info',
  COMPLETED: 'success',
  FAILED: 'error',
};

// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆ
const STATUS_TEXT: Record<JobStatus, string> = {
  PENDING: 'ğŸŸ¡ å¾…æ©Ÿä¸­',
  PROCESSING: 'ğŸ”µ å‡¦ç†ä¸­',
  COMPLETED: 'ğŸŸ¢ å®Œäº†',
  FAILED: 'ğŸ”´ å¤±æ•—',
};

// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹èª¬æ˜ãƒ†ã‚­ã‚¹ãƒˆ
const STATUS_DESCRIPTION: Record<JobStatus, string> = {
  PENDING: 'å¤‰æ›å‡¦ç†ã‚’å¾…ã£ã¦ã„ã¾ã™',
  PROCESSING: 'å‹•ç”»ã‚’å¤‰æ›ã—ã¦ã„ã¾ã™...',
  COMPLETED: 'å¤‰æ›ãŒå®Œäº†ã—ã¾ã—ãŸ',
  FAILED: 'å¤‰æ›å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ',
};

/**
 * ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯åã®è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆ
 */
const CODEC_DISPLAY_NAME: Record<CodecType, string> = {
  h264: 'H.264',
  vp9: 'VP9',
  av1: 'AV1',
};

/**
 * API response type with optional downloadUrl
 */
interface GetJobResponse extends Job {
  downloadUrl?: string;
}

// Valid values for validation
const VALID_JOB_STATUSES: ReadonlyArray<JobStatus> = [
  'PENDING',
  'PROCESSING',
  'COMPLETED',
  'FAILED',
];
const VALID_CODEC_TYPES: ReadonlyArray<CodecType> = ['h264', 'vp9', 'av1'];

/**
 * Type guard to validate GetJobResponse
 */
function isGetJobResponse(data: unknown): data is GetJobResponse {
  if (typeof data !== 'object' || data === null) {
    return false;
  }

  const job = data as Record<string, unknown>;

  return (
    typeof job.jobId === 'string' &&
    typeof job.status === 'string' &&
    VALID_JOB_STATUSES.includes(job.status as JobStatus) &&
    typeof job.inputFile === 'string' &&
    typeof job.outputCodec === 'string' &&
    VALID_CODEC_TYPES.includes(job.outputCodec as CodecType) &&
    typeof job.fileName === 'string' &&
    typeof job.fileSize === 'number' &&
    typeof job.createdAt === 'number' &&
    typeof job.updatedAt === 'number' &&
    typeof job.expiresAt === 'number' &&
    (job.downloadUrl === undefined || typeof job.downloadUrl === 'string')
  );
}

interface JobDetailsPageProps {
  params: Promise<{ jobId: string }>;
}

export default function JobDetailsPage({ params }: JobDetailsPageProps) {
  const router = useRouter();
  const [jobId, setJobId] = useState<string>('');
  const [job, setJob] = useState<Job | null>(null);
  const [downloadUrl, setDownloadUrl] = useState<string | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [isRefreshing, setIsRefreshing] = useState(false);

  // paramsã®éåŒæœŸè§£æ±º
  useEffect(() => {
    params.then((resolvedParams) => {
      setJobId(resolvedParams.jobId);
    });
  }, [params]);

  // ã‚¸ãƒ§ãƒ–æƒ…å ±ã®å–å¾—
  const fetchJobDetails = useCallback(
    async (showRefreshingState = false) => {
      if (!jobId) return;

      if (showRefreshingState) {
        setIsRefreshing(true);
      }
      setError(null);

      try {
        const response = await fetch(`/api/jobs/${jobId}`);

        if (!response.ok) {
          if (response.status === 404) {
            setError(ERROR_MESSAGES.JOB_NOT_FOUND);
          } else {
            setError(ERROR_MESSAGES.FETCH_FAILED);
          }
          return;
        }

        const data = await response.json();

        // Validate response structure
        if (!isGetJobResponse(data)) {
          console.error('Invalid job response structure:', data);
          setError(ERROR_MESSAGES.FETCH_FAILED);
          return;
        }

        setJob(data);
        setDownloadUrl(data.downloadUrl || null);
      } catch (err) {
        console.error('Failed to fetch job details:', err);
        setError(ERROR_MESSAGES.FETCH_FAILED);
      } finally {
        setIsLoading(false);
        setIsRefreshing(false);
      }
    },
    [jobId]
  );

  // åˆå›èª­ã¿è¾¼ã¿
  useEffect(() => {
    if (jobId) {
      fetchJobDetails();
    }
  }, [jobId, fetchJobDetails]);

  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªãƒœã‚¿ãƒ³ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  const handleRefresh = () => {
    fetchJobDetails(true);
  };

  // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  const handleDownload = () => {
    if (downloadUrl) {
      // downloadUrl is a Presigned URL generated by our own API
      // It's safe to open as it's server-controlled and time-limited
      window.open(downloadUrl, '_blank');
    }
  };

  // æ–°è¦å¤‰æ›ãƒœã‚¿ãƒ³ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  const handleNewConversion = () => {
    router.push('/');
  };

  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã®è¡¨ç¤º
  if (isLoading) {
    return (
      <Container maxWidth="md" sx={{ py: 4 }}>
        <Typography variant="h4" component="h1" gutterBottom>
          å¤‰æ›ã‚¸ãƒ§ãƒ–è©³ç´°
        </Typography>
        <Box sx={{ textAlign: 'center', py: 4 }}>
          <Typography>èª­ã¿è¾¼ã¿ä¸­...</Typography>
        </Box>
      </Container>
    );
  }

  // ã‚¨ãƒ©ãƒ¼æ™‚ã®è¡¨ç¤º
  if (error && !job) {
    return (
      <Container maxWidth="md" sx={{ py: 4 }}>
        <Typography variant="h4" component="h1" gutterBottom>
          å¤‰æ›ã‚¸ãƒ§ãƒ–è©³ç´°
        </Typography>
        <Alert severity="error" sx={{ mb: 3 }}>
          {error}
        </Alert>
        <Button variant="contained" startIcon={<AddIcon />} onClick={handleNewConversion}>
          æ–°ã—ã„å‹•ç”»ã‚’å¤‰æ›
        </Button>
      </Container>
    );
  }

  if (!job) {
    return null;
  }

  const showRefreshButton = job.status === 'PENDING' || job.status === 'PROCESSING';
  const showDownloadButton = job.status === 'COMPLETED';

  return (
    <Container maxWidth="md" sx={{ py: 4 }}>
      <Typography variant="h4" component="h1" gutterBottom sx={{ mb: 3 }}>
        å¤‰æ›ã‚¸ãƒ§ãƒ–è©³ç´°
      </Typography>

      {/* ã‚¸ãƒ§ãƒ–æƒ…å ±è¡¨ç¤º */}
      <Card sx={{ mb: 3 }} aria-labelledby="job-info-heading">
        <CardContent>
          <Typography
            id="job-info-heading"
            variant="h6"
            component="h2"
            gutterBottom
            sx={{ fontWeight: 'bold' }}
          >
            ã‚¸ãƒ§ãƒ–æƒ…å ±
          </Typography>

          <Stack spacing={1.5}>
            <Box>
              <Typography component="span" fontWeight="bold" sx={{ mr: 1 }}>
                ã‚¸ãƒ§ãƒ–ID:
              </Typography>
              <Typography component="span" sx={{ fontFamily: 'monospace' }}>
                {formatJobId(job.jobId)}
              </Typography>
            </Box>

            <Box>
              <Typography component="span" fontWeight="bold" sx={{ mr: 1 }}>
                ãƒ•ã‚¡ã‚¤ãƒ«å:
              </Typography>
              <Typography component="span">{job.fileName}</Typography>
            </Box>

            <Box>
              <Typography component="span" fontWeight="bold" sx={{ mr: 1 }}>
                ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º:
              </Typography>
              <Typography component="span">{formatFileSize(job.fileSize)}</Typography>
            </Box>

            <Box>
              <Typography component="span" fontWeight="bold" sx={{ mr: 1 }}>
                å‡ºåŠ›ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯:
              </Typography>
              <Typography component="span">{CODEC_DISPLAY_NAME[job.outputCodec]}</Typography>
            </Box>

            <Box>
              <Typography component="span" fontWeight="bold" sx={{ mr: 1 }}>
                ä½œæˆæ—¥æ™‚:
              </Typography>
              <Typography component="span">{formatDateTime(job.createdAt)}</Typography>
            </Box>
          </Stack>
        </CardContent>
      </Card>

      {/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */}
      <Card sx={{ mb: 3 }} aria-labelledby="status-heading">
        <CardContent>
          <Typography
            id="status-heading"
            variant="h6"
            component="h2"
            gutterBottom
            sx={{ fontWeight: 'bold' }}
          >
            ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
          </Typography>

          <Chip
            label={STATUS_TEXT[job.status]}
            color={STATUS_COLORS[job.status]}
            sx={{ mb: 1, fontWeight: 'bold' }}
          />

          <Typography variant="body2" color="text.secondary" sx={{ mt: 1 }}>
            {STATUS_DESCRIPTION[job.status]}
          </Typography>

          {/* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆFAILEDæ™‚ï¼‰ */}
          {job.status === 'FAILED' && job.errorMessage && (
            <Alert severity="error" sx={{ mt: 2 }}>
              <Typography variant="body2" fontWeight="bold" gutterBottom>
                ã‚¨ãƒ©ãƒ¼è©³ç´°:
              </Typography>
              <Typography variant="body2">{job.errorMessage}</Typography>
            </Alert>
          )}
        </CardContent>
      </Card>

      {/* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */}
      <Stack spacing={2}>
        {/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªãƒœã‚¿ãƒ³ */}
        {showRefreshButton && (
          <Button
            variant="contained"
            size="large"
            startIcon={<RefreshIcon />}
            onClick={handleRefresh}
            disabled={isRefreshing}
            fullWidth
            aria-label="ã‚¸ãƒ§ãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª"
          >
            {isRefreshing ? 'ç¢ºèªä¸­...' : 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª'}
          </Button>
        )}

        {/* ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ */}
        {showDownloadButton && (
          <Button
            variant="contained"
            size="large"
            color="success"
            startIcon={<DownloadIcon />}
            onClick={handleDownload}
            fullWidth
            aria-label="å¤‰æ›æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"
          >
            ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          </Button>
        )}

        {/* æ–°è¦å¤‰æ›ãƒœã‚¿ãƒ³ */}
        <Button
          variant="outlined"
          size="large"
          startIcon={<AddIcon />}
          onClick={handleNewConversion}
          fullWidth
          aria-label="æ–°ã—ã„å‹•ç”»ã‚’å¤‰æ›ã™ã‚‹"
        >
          æ–°ã—ã„å‹•ç”»ã‚’å¤‰æ›
        </Button>
      </Stack>
    </Container>
  );
}
