/**
 * @jest-environment jsdom
 */

import { render, screen, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { useRouter } from 'next/navigation';
import JobDetailsPage from '@/app/jobs/[jobId]/page';

// Next.js useRouter„ÅÆ„É¢„ÉÉ„ÇØ
jest.mock('next/navigation', () => ({
  useRouter: jest.fn(),
}));

// global fetch„ÅÆ„É¢„ÉÉ„ÇØ
const mockFetch = jest.fn();
global.fetch = mockFetch;

// window.open„ÅÆ„É¢„ÉÉ„ÇØ
const mockWindowOpen = jest.fn();
Object.defineProperty(window, 'open', {
  writable: true,
  value: mockWindowOpen,
});

describe('JobDetailsPage', () => {
  const mockPush = jest.fn();
  const mockJobId = '550e8400-e29b-41d4-a716-446655440000';

  beforeEach(() => {
    jest.clearAllMocks();
    (useRouter as jest.Mock).mockReturnValue({
      push: mockPush,
    });
    mockFetch.mockClear();
    mockWindowOpen.mockClear();
  });

  const createParams = (jobId: string) => Promise.resolve({ jobId });

  describe('ÂàùÊúüË°®Á§∫', () => {
    it('„É≠„Éº„Éá„Ç£„É≥„Ç∞‰∏≠„ÅÆË°®Á§∫„Åå„Åï„Çå„Çã', async () => {
      // fetch„ÇíÈÅÖÂª∂„Åï„Åõ„Çã
      mockFetch.mockImplementation(
        () => new Promise((resolve) => setTimeout(() => resolve({ ok: true }), 1000))
      );

      render(<JobDetailsPage params={createParams(mockJobId)} />);

      expect(screen.getByText('Â§âÊèõ„Ç∏„Éß„ÉñË©≥Á¥∞')).toBeInTheDocument();
      expect(screen.getByText('Ë™≠„ÅøËæº„Åø‰∏≠...')).toBeInTheDocument();
    });
  });

  describe('PENDINGÁä∂ÊÖã', () => {
    const mockPendingJob = {
      jobId: mockJobId,
      status: 'PENDING',
      inputFile: `uploads/${mockJobId}/input.mp4`,
      outputCodec: 'h264',
      fileName: 'test-video.mp4',
      fileSize: 100 * 1024 * 1024, // 100MB
      createdAt: 1704067200,
      updatedAt: 1704067200,
      expiresAt: 1704153600,
    };

    beforeEach(() => {
      mockFetch.mockResolvedValue({
        ok: true,
        status: 200,
        json: async () => mockPendingJob,
      });
    });

    it('„Ç∏„Éß„ÉñÊÉÖÂ†±„ÅåÊ≠£„Åó„ÅèË°®Á§∫„Åï„Çå„Çã', async () => {
      render(<JobDetailsPage params={createParams(mockJobId)} />);

      await waitFor(() => {
        expect(screen.getByText(/„Ç∏„Éß„ÉñID:/)).toBeInTheDocument();
      });

      // „Ç∏„Éß„ÉñIDÔºàÁü≠Á∏ÆË°®Á§∫Ôºâ
      expect(screen.getByText(/550e8400\.\.\.0000/)).toBeInTheDocument();

      // „Éï„Ç°„Ç§„É´Âêç
      expect(screen.getByText(/test-video\.mp4/)).toBeInTheDocument();

      // „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫
      expect(screen.getByText(/100\.0 MB/)).toBeInTheDocument();

      // „Ç≥„Éº„Éá„ÉÉ„ÇØ
      expect(screen.getByText(/H\.264/)).toBeInTheDocument();

      // ‰ΩúÊàêÊó•ÊôÇ
      expect(screen.getByText(/2024/)).toBeInTheDocument();
    });

    it('PENDING„Çπ„ÉÜ„Éº„Çø„Çπ„Éê„ÉÉ„Ç∏„ÅåË°®Á§∫„Åï„Çå„Çã', async () => {
      render(<JobDetailsPage params={createParams(mockJobId)} />);

      await waitFor(() => {
        expect(screen.getByText('üü° ÂæÖÊ©ü‰∏≠')).toBeInTheDocument();
      });

      expect(screen.getByText('Â§âÊèõÂá¶ÁêÜ„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô')).toBeInTheDocument();
    });

    it('„Çπ„ÉÜ„Éº„Çø„ÇπÁ¢∫Ë™ç„Éú„Çø„É≥„ÅåË°®Á§∫„Åï„Çå„Çã', async () => {
      render(<JobDetailsPage params={createParams(mockJobId)} />);

      await waitFor(() => {
        expect(screen.getByText('„Çπ„ÉÜ„Éº„Çø„ÇπÁ¢∫Ë™ç')).toBeInTheDocument();
      });
    });

    it('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Éú„Çø„É≥„ÅåË°®Á§∫„Åï„Çå„Å™„ÅÑ', async () => {
      render(<JobDetailsPage params={createParams(mockJobId)} />);

      await waitFor(() => {
        expect(screen.getByText('„Çπ„ÉÜ„Éº„Çø„ÇπÁ¢∫Ë™ç')).toBeInTheDocument();
      });

      expect(screen.queryByText('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ')).not.toBeInTheDocument();
    });

    it('„Çπ„ÉÜ„Éº„Çø„ÇπÁ¢∫Ë™ç„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®API„ÅåÂÜçÂ∫¶Âëº„Å∞„Çå„Çã', async () => {
      const user = userEvent.setup();
      render(<JobDetailsPage params={createParams(mockJobId)} />);

      await waitFor(() => {
        expect(screen.getByText('„Çπ„ÉÜ„Éº„Çø„ÇπÁ¢∫Ë™ç')).toBeInTheDocument();
      });

      // ÂàùÂõû„ÅÆfetchÂëº„Å≥Âá∫„Åó„ÇíÁ¢∫Ë™ç
      expect(mockFetch).toHaveBeenCalledTimes(1);

      // „Çπ„ÉÜ„Éº„Çø„ÇπÁ¢∫Ë™ç„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ
      const refreshButton = screen.getByText('„Çπ„ÉÜ„Éº„Çø„ÇπÁ¢∫Ë™ç');
      await user.click(refreshButton);

      // 2ÂõûÁõÆ„ÅÆfetchÂëº„Å≥Âá∫„Åó„ÇíÁ¢∫Ë™ç
      await waitFor(() => {
        expect(mockFetch).toHaveBeenCalledTimes(2);
      });
    });
  });

  describe('PROCESSINGÁä∂ÊÖã', () => {
    const mockProcessingJob = {
      jobId: mockJobId,
      status: 'PROCESSING',
      inputFile: `uploads/${mockJobId}/input.mp4`,
      outputCodec: 'vp9',
      fileName: 'test-video.mp4',
      fileSize: 50 * 1024 * 1024,
      createdAt: 1704067200,
      updatedAt: 1704067300,
      expiresAt: 1704153600,
    };

    beforeEach(() => {
      mockFetch.mockResolvedValue({
        ok: true,
        status: 200,
        json: async () => mockProcessingJob,
      });
    });

    it('PROCESSING„Çπ„ÉÜ„Éº„Çø„Çπ„Éê„ÉÉ„Ç∏„ÅåË°®Á§∫„Åï„Çå„Çã', async () => {
      render(<JobDetailsPage params={createParams(mockJobId)} />);

      await waitFor(() => {
        expect(screen.getByText('üîµ Âá¶ÁêÜ‰∏≠')).toBeInTheDocument();
      });

      expect(screen.getByText('ÂãïÁîª„ÇíÂ§âÊèõ„Åó„Å¶„ÅÑ„Åæ„Åô...')).toBeInTheDocument();
    });

    it('„Çπ„ÉÜ„Éº„Çø„ÇπÁ¢∫Ë™ç„Éú„Çø„É≥„ÅåË°®Á§∫„Åï„Çå„Çã', async () => {
      render(<JobDetailsPage params={createParams(mockJobId)} />);

      await waitFor(() => {
        expect(screen.getByText('„Çπ„ÉÜ„Éº„Çø„ÇπÁ¢∫Ë™ç')).toBeInTheDocument();
      });
    });

    it('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Éú„Çø„É≥„ÅåË°®Á§∫„Åï„Çå„Å™„ÅÑ', async () => {
      render(<JobDetailsPage params={createParams(mockJobId)} />);

      await waitFor(() => {
        expect(screen.getByText('„Çπ„ÉÜ„Éº„Çø„ÇπÁ¢∫Ë™ç')).toBeInTheDocument();
      });

      expect(screen.queryByText('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ')).not.toBeInTheDocument();
    });
  });

  describe('COMPLETEDÁä∂ÊÖã', () => {
    const mockCompletedJob = {
      jobId: mockJobId,
      status: 'COMPLETED',
      inputFile: `uploads/${mockJobId}/input.mp4`,
      outputFile: `outputs/${mockJobId}/output.webm`,
      outputCodec: 'av1',
      fileName: 'test-video.mp4',
      fileSize: 50 * 1024 * 1024,
      createdAt: 1704067200,
      updatedAt: 1704067500,
      expiresAt: 1704153600,
      downloadUrl: 'https://example.com/presigned-url',
    };

    beforeEach(() => {
      mockFetch.mockResolvedValue({
        ok: true,
        status: 200,
        json: async () => mockCompletedJob,
      });
    });

    it('COMPLETED„Çπ„ÉÜ„Éº„Çø„Çπ„Éê„ÉÉ„Ç∏„ÅåË°®Á§∫„Åï„Çå„Çã', async () => {
      render(<JobDetailsPage params={createParams(mockJobId)} />);

      await waitFor(() => {
        expect(screen.getByText('üü¢ ÂÆå‰∫Ü')).toBeInTheDocument();
      });

      expect(screen.getByText('Â§âÊèõ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü')).toBeInTheDocument();
    });

    it('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Éú„Çø„É≥„ÅåË°®Á§∫„Åï„Çå„Çã', async () => {
      render(<JobDetailsPage params={createParams(mockJobId)} />);

      await waitFor(() => {
        expect(screen.getByText('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ')).toBeInTheDocument();
      });
    });

    it('„Çπ„ÉÜ„Éº„Çø„ÇπÁ¢∫Ë™ç„Éú„Çø„É≥„ÅåË°®Á§∫„Åï„Çå„Å™„ÅÑ', async () => {
      render(<JobDetailsPage params={createParams(mockJobId)} />);

      await waitFor(() => {
        expect(screen.getByText('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ')).toBeInTheDocument();
      });

      expect(screen.queryByText('„Çπ„ÉÜ„Éº„Çø„ÇπÁ¢∫Ë™ç')).not.toBeInTheDocument();
    });

    it('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®Presigned URL„Å´„Ç¢„ÇØ„Çª„Çπ„Åô„Çã', async () => {
      const user = userEvent.setup();
      render(<JobDetailsPage params={createParams(mockJobId)} />);

      await waitFor(() => {
        expect(screen.getByText('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ')).toBeInTheDocument();
      });

      const downloadButton = screen.getByText('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ');
      await user.click(downloadButton);

      expect(mockWindowOpen).toHaveBeenCalledWith(
        'https://example.com/presigned-url',
        '_blank'
      );
    });
  });

  describe('FAILEDÁä∂ÊÖã', () => {
    const mockFailedJob = {
      jobId: mockJobId,
      status: 'FAILED',
      inputFile: `uploads/${mockJobId}/input.mp4`,
      outputCodec: 'h264',
      fileName: 'test-video.mp4',
      fileSize: 50 * 1024 * 1024,
      createdAt: 1704067200,
      updatedAt: 1704067300,
      expiresAt: 1704153600,
      errorMessage: 'FFmpeg conversion failed: Invalid codec parameters',
    };

    beforeEach(() => {
      mockFetch.mockResolvedValue({
        ok: true,
        status: 200,
        json: async () => mockFailedJob,
      });
    });

    it('FAILED„Çπ„ÉÜ„Éº„Çø„Çπ„Éê„ÉÉ„Ç∏„ÅåË°®Á§∫„Åï„Çå„Çã', async () => {
      render(<JobDetailsPage params={createParams(mockJobId)} />);

      await waitFor(() => {
        expect(screen.getByText('üî¥ Â§±Êïó')).toBeInTheDocument();
      });

      expect(screen.getByText('Â§âÊèõÂá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü')).toBeInTheDocument();
    });

    it('„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÅåË°®Á§∫„Åï„Çå„Çã', async () => {
      render(<JobDetailsPage params={createParams(mockJobId)} />);

      await waitFor(() => {
        expect(screen.getByText('„Ç®„É©„ÉºË©≥Á¥∞:')).toBeInTheDocument();
      });

      expect(
        screen.getByText('FFmpeg conversion failed: Invalid codec parameters')
      ).toBeInTheDocument();
    });

    it('„Çπ„ÉÜ„Éº„Çø„ÇπÁ¢∫Ë™ç„Éú„Çø„É≥„ÅåË°®Á§∫„Åï„Çå„Å™„ÅÑ', async () => {
      render(<JobDetailsPage params={createParams(mockJobId)} />);

      await waitFor(() => {
        expect(screen.getByText('üî¥ Â§±Êïó')).toBeInTheDocument();
      });

      expect(screen.queryByText('„Çπ„ÉÜ„Éº„Çø„ÇπÁ¢∫Ë™ç')).not.toBeInTheDocument();
    });

    it('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Éú„Çø„É≥„ÅåË°®Á§∫„Åï„Çå„Å™„ÅÑ', async () => {
      render(<JobDetailsPage params={createParams(mockJobId)} />);

      await waitFor(() => {
        expect(screen.getByText('üî¥ Â§±Êïó')).toBeInTheDocument();
      });

      expect(screen.queryByText('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ')).not.toBeInTheDocument();
    });
  });

  describe('„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞', () => {
    it('„Ç∏„Éß„Éñ„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥ÂêàÔºà404Ôºâ„ÅÆ„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÅåË°®Á§∫„Åï„Çå„Çã', async () => {
      mockFetch.mockResolvedValue({
        ok: false,
        status: 404,
        json: async () => ({ error: 'JOB_NOT_FOUND' }),
      });

      render(<JobDetailsPage params={createParams(mockJobId)} />);

      await waitFor(() => {
        expect(screen.getByText('ÊåáÂÆö„Åï„Çå„Åü„Ç∏„Éß„Éñ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì')).toBeInTheDocument();
      });
    });

    it('„Çµ„Éº„Éê„Éº„Ç®„É©„ÉºÔºà500Ôºâ„ÅÆ„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÅåË°®Á§∫„Åï„Çå„Çã', async () => {
      mockFetch.mockResolvedValue({
        ok: false,
        status: 500,
        json: async () => ({ error: 'INTERNAL_SERVER_ERROR' }),
      });

      render(<JobDetailsPage params={createParams(mockJobId)} />);

      await waitFor(() => {
        expect(screen.getByText('„Ç∏„Éß„ÉñÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü')).toBeInTheDocument();
      });
    });

    it('„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÅÆ„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÅåË°®Á§∫„Åï„Çå„Çã', async () => {
      mockFetch.mockRejectedValue(new Error('Network error'));

      render(<JobDetailsPage params={createParams(mockJobId)} />);

      await waitFor(() => {
        expect(screen.getByText('„Ç∏„Éß„ÉñÊÉÖÂ†±„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü')).toBeInTheDocument();
      });
    });
  });

  describe('„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥', () => {
    it('Êñ∞„Åó„ÅÑÂãïÁîª„ÇíÂ§âÊèõ„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®„Éà„ÉÉ„Éó„Éö„Éº„Ç∏„Å´ÈÅ∑Áßª„Åô„Çã', async () => {
      const user = userEvent.setup();
      mockFetch.mockResolvedValue({
        ok: true,
        status: 200,
        json: async () => ({
          jobId: mockJobId,
          status: 'COMPLETED',
          inputFile: `uploads/${mockJobId}/input.mp4`,
          outputFile: `outputs/${mockJobId}/output.mp4`,
          outputCodec: 'h264',
          fileName: 'test-video.mp4',
          fileSize: 50 * 1024 * 1024,
          createdAt: 1704067200,
          updatedAt: 1704067500,
          expiresAt: 1704153600,
          downloadUrl: 'https://example.com/presigned-url',
        }),
      });

      render(<JobDetailsPage params={createParams(mockJobId)} />);

      await waitFor(() => {
        expect(screen.getByText('Êñ∞„Åó„ÅÑÂãïÁîª„ÇíÂ§âÊèõ')).toBeInTheDocument();
      });

      const newConversionButton = screen.getByText('Êñ∞„Åó„ÅÑÂãïÁîª„ÇíÂ§âÊèõ');
      await user.click(newConversionButton);

      expect(mockPush).toHaveBeenCalledWith('/');
    });

    it('„Ç®„É©„ÉºÁîªÈù¢„Åã„ÇâÊñ∞„Åó„ÅÑÂãïÁîª„ÇíÂ§âÊèõ„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®„Éà„ÉÉ„Éó„Éö„Éº„Ç∏„Å´ÈÅ∑Áßª„Åô„Çã', async () => {
      const user = userEvent.setup();
      mockFetch.mockResolvedValue({
        ok: false,
        status: 404,
        json: async () => ({ error: 'JOB_NOT_FOUND' }),
      });

      render(<JobDetailsPage params={createParams(mockJobId)} />);

      await waitFor(() => {
        expect(screen.getByText('Êñ∞„Åó„ÅÑÂãïÁîª„ÇíÂ§âÊèõ')).toBeInTheDocument();
      });

      const newConversionButton = screen.getByText('Êñ∞„Åó„ÅÑÂãïÁîª„ÇíÂ§âÊèõ');
      await user.click(newConversionButton);

      expect(mockPush).toHaveBeenCalledWith('/');
    });
  });

  describe('„Ç¢„ÇØ„Çª„Ç∑„Éì„É™„ÉÜ„Ç£', () => {
    it('„Çπ„ÉÜ„Éº„Çø„ÇπÊÉÖÂ†±„Å´role="status"„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã', async () => {
      mockFetch.mockResolvedValue({
        ok: true,
        status: 200,
        json: async () => ({
          jobId: mockJobId,
          status: 'PENDING',
          inputFile: `uploads/${mockJobId}/input.mp4`,
          outputCodec: 'h264',
          fileName: 'test-video.mp4',
          fileSize: 50 * 1024 * 1024,
          createdAt: 1704067200,
          updatedAt: 1704067200,
          expiresAt: 1704153600,
        }),
      });

      render(<JobDetailsPage params={createParams(mockJobId)} />);

      await waitFor(() => {
        const statusBadge = screen.getByRole('status');
        expect(statusBadge).toBeInTheDocument();
      });
    });

    it('„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„Å´role="alert"„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã', async () => {
      mockFetch.mockResolvedValue({
        ok: false,
        status: 404,
        json: async () => ({ error: 'JOB_NOT_FOUND' }),
      });

      render(<JobDetailsPage params={createParams(mockJobId)} />);

      await waitFor(() => {
        const alert = screen.getByRole('alert');
        expect(alert).toBeInTheDocument();
      });
    });

    it('„Éú„Çø„É≥„Å´aria-label„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã', async () => {
      mockFetch.mockResolvedValue({
        ok: true,
        status: 200,
        json: async () => ({
          jobId: mockJobId,
          status: 'PENDING',
          inputFile: `uploads/${mockJobId}/input.mp4`,
          outputCodec: 'h264',
          fileName: 'test-video.mp4',
          fileSize: 50 * 1024 * 1024,
          createdAt: 1704067200,
          updatedAt: 1704067200,
          expiresAt: 1704153600,
        }),
      });

      render(<JobDetailsPage params={createParams(mockJobId)} />);

      await waitFor(() => {
        expect(screen.getByLabelText('„Ç∏„Éß„Éñ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÁ¢∫Ë™ç')).toBeInTheDocument();
        expect(screen.getByLabelText('Êñ∞„Åó„ÅÑÂãïÁîª„ÇíÂ§âÊèõ„Åô„Çã')).toBeInTheDocument();
      });
    });
  });
});
