name: Codec Converter - Deploy Infrastructure

on:
  push:
    branches:
      - develop
      - integration/**
      - master
    paths:
      - "services/codec-converter/**"
      - "infra/codec-converter/**"
      - "libs/**"
      - "package.json"
      - "package-lock.json"
      - ".github/workflows/codec-converter-deploy.yml"
  workflow_dispatch:

env:
  AWS_REGION: us-east-1

jobs:
  build-nextjs:
    name: Build Next.js Application
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: "./package-lock.json"

      - name: Install dependencies
        run: npm ci

      - name: Build codec-converter-core library
        run: npm run build --workspace=codec-converter-core

      - name: Build Next.js application
        run: npm run build --workspace=codec-converter-web

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: codec-converter-build
          path: services/codec-converter/web/.next
          retention-days: 7

  deploy:
    name: Deploy CDK Infrastructure
    runs-on: ubuntu-latest

    permissions:
      contents: read

    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      stack-name: ${{ steps.set-env.outputs.stack-name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment
        id: set-env
        run: |
          if [[ "$GITHUB_REF" == 'refs/heads/master' ]]; then
            echo "environment=prod" >> "$GITHUB_OUTPUT"
            echo "stack-name=CodecConverterStack-prod" >> "$GITHUB_OUTPUT"
          else
            echo "environment=dev" >> "$GITHUB_OUTPUT"
            echo "stack-name=CodecConverterStack-dev" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: "./package-lock.json"

      - name: Install dependencies
        run: npm ci

      - name: Build CDK project
        working-directory: ./infra/codec-converter
        run: |
          npm ci
          npm run build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get AWS Account ID
        id: get-account-id
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account-id=$ACCOUNT_ID" >> "$GITHUB_OUTPUT"
          echo "AWS Account ID: $ACCOUNT_ID"

      - name: CDK Bootstrap (if needed)
        env:
          ACCOUNT_ID: ${{ steps.get-account-id.outputs.account-id }}
        run: |
          # Bootstrap is idempotent - safe to run on every deployment
          npm run bootstrap --workspace=codec-converter -- aws://$ACCOUNT_ID/${{ env.AWS_REGION }} \
            --context env=${{ steps.set-env.outputs.environment }}

      - name: Check if ECR repository exists
        id: check-ecr
        env:
          ENVIRONMENT: ${{ steps.set-env.outputs.environment }}
        run: |
          if aws ecr describe-repositories --repository-names codec-converter-$ENVIRONMENT --region ${{ env.AWS_REGION }} 2>/dev/null; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: CDK Deploy (Create ECR Repository)
        if: steps.check-ecr.outputs.exists == 'false'
        env:
          ENVIRONMENT: ${{ steps.set-env.outputs.environment }}
        run: |
          echo "Creating ECR repository..."
          npm run deploy --workspace=codec-converter -- ${{ steps.set-env.outputs.stack-name }} \
            --context env=$ENVIRONMENT \
            --context deploymentPhase=ecr-only \
            --verbose

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push Docker image to ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: codec-converter-${{ steps.set-env.outputs.environment }}
          IMAGE_TAG: latest
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f services/codec-converter/Dockerfile .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

      - name: CDK Deploy (Full Stack)
        env:
          ENVIRONMENT: ${{ steps.set-env.outputs.environment }}
        run: |
          echo "Deploying full stack..."
          npm run deploy --workspace=codec-converter -- ${{ steps.set-env.outputs.stack-name }} \
            --context env=$ENVIRONMENT \
            --context deploymentPhase=full \
            --verbose

      - name: Display stack outputs
        env:
          STACK_NAME: ${{ steps.set-env.outputs.stack-name }}
        run: |
          echo "=== CDK Stack Outputs ==="
          aws cloudformation describe-stacks \
            --stack-name "$STACK_NAME" \
            --query "Stacks[0].Outputs" \
            --region ${{ env.AWS_REGION }} \
            --output table
