name: Weekly Documentation Review

on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ 9:00 JST (0:00 UTC)
    - cron: '0 0 * * 1'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

permissions:
  issues: write
  contents: read

jobs:
  create-review-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get current week info
        id: week_info
        run: |
          YEAR=$(date +%Y)
          WEEK=$(date +%U)
          DATE=$(date +%Y-%m-%d)

          echo "year=$YEAR" >> $GITHUB_OUTPUT
          echo "week=$WEEK" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "title=[Docs Review] ${YEAR}å¹´ç¬¬${WEEK}é€± ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ¬ãƒ“ãƒ¥ãƒ¼ (${DATE})" >> $GITHUB_OUTPUT

      - name: Calculate next review date
        id: next_review
        run: |
          # æ¬¡é€±æœˆæ›œæ—¥ã‚’è¨ˆç®—
          NEXT_MONDAY=$(date -d "next monday" +%Y-%m-%d)
          echo "next_date=$NEXT_MONDAY" >> $GITHUB_OUTPUT

      - name: Find previous review issue
        id: prev_issue
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # éå»ã® Docs Review Issue ã‚’æ¤œç´¢
          PREV_ISSUE=$(gh issue list \
            --label "weekly-review" \
            --state all \
            --limit 1 \
            --json number \
            --jq '.[0].number // ""')

          if [ -n "$PREV_ISSUE" ]; then
            echo "prev_issue_number=#$PREV_ISSUE" >> $GITHUB_OUTPUT
          else
            echo "prev_issue_number=ãªã—ï¼ˆåˆå›ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰" >> $GITHUB_OUTPUT
          fi

      - name: Count updated docs in last week
        id: metrics
        run: |
          # éå»1é€±é–“ã§æ›´æ–°ã•ã‚ŒãŸ .md ãƒ•ã‚¡ã‚¤ãƒ«æ•°
          UPDATED_DOCS=$(git log --since="1 week ago" --name-only --pretty=format: -- docs/ .github/ | grep "\.md$" | sort -u | wc -l)
          echo "updated_docs=$UPDATED_DOCS" >> $GITHUB_OUTPUT

      - name: Detect policy changes in development docs
        id: policy_changes
        run: |
          # éå»1é€±é–“ã® docs/development/ ã®å¤‰æ›´ã‚’æ¤œå‡º
          POLICY_CHANGES=$(git log --since="1 week ago" --oneline --no-merges -- docs/development/ | head -10)

          # è¤‡æ•°è¡Œã‚’ä¿æŒã™ã‚‹ãŸã‚ã«æ”¹è¡Œã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
          if [ -n "$POLICY_CHANGES" ]; then
            {
              echo 'policy_changes<<EOF'
              echo "$POLICY_CHANGES"
              echo EOF
            } >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "policy_changes=å¤‰æ›´ãªã—" >> $GITHUB_OUTPUT
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Prepare issue body from template
        id: issue_body
        env:
          UPDATED_DOCS: ${{ steps.metrics.outputs.updated_docs }}
          PREV_ISSUE: ${{ steps.prev_issue.outputs.prev_issue_number }}
          NEXT_DATE: ${{ steps.next_review.outputs.next_date }}
          HAS_POLICY_CHANGES: ${{ steps.policy_changes.outputs.has_changes }}
          POLICY_CHANGES: ${{ steps.policy_changes.outputs.policy_changes }}
        run: |
          # ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦ Issue æœ¬æ–‡ã‚’ç”Ÿæˆ
          BODY=$(.github/workflows/scripts/prepare-review-issue.sh)

          # å‡ºåŠ›ã‚’ä¿å­˜
          {
            echo 'issue_body<<EOF'
            echo "$BODY"
            echo EOF
          } >> $GITHUB_OUTPUT

      - name: Create weekly review issue
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue create \
            --title "${{ steps.week_info.outputs.title }}" \
            --label "documentation,weekly-review" \
            --body "${{ steps.issue_body.outputs.issue_body }}"

      - name: Summary
        run: |
          echo "âœ… é€±æ¬¡ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ¬ãƒ“ãƒ¥ãƒ¼ Issue ã‚’ä½œæˆã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ã‚¿ã‚¤ãƒˆãƒ«**: ${{ steps.week_info.outputs.title }}" >> $GITHUB_STEP_SUMMARY
          echo "**æ¬¡å›ãƒ¬ãƒ“ãƒ¥ãƒ¼äºˆå®š**: ${{ steps.next_review.outputs.next_date }}" >> $GITHUB_STEP_SUMMARY
          echo "**éå»1é€±é–“ã®æ›´æ–°ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•°**: ${{ steps.metrics.outputs.updated_docs }} ãƒ•ã‚¡ã‚¤ãƒ«" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.policy_changes.outputs.has_changes }}" == "true" ]; then
            echo "âš ï¸ **é–‹ç™ºæ–¹é‡ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«å¤‰æ›´ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ**" >> $GITHUB_STEP_SUMMARY
            echo "Priority 4 ã®ã€Œ14. æ–¹é‡å¤‰æ›´ã®è¿½å¾“æ¼ã‚Œãƒã‚§ãƒƒã‚¯ã€ã‚’å¿…ãšå®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "ğŸ“ é–‹ç™ºæ–¹é‡ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«å¤‰æ›´ãªã—" >> $GITHUB_STEP_SUMMARY
          fi
