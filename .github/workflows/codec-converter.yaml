name: Codec Converter - CI/CD

on:
  pull_request:
    branches:
      - develop
      - integration/**
    paths:
      - 'services/codec-converter/**'
      - 'services/codec-converter-worker/**'
      - 'libs/**'
      - 'infra/codec-converter/**'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/codec-converter.yaml'
  push:
    branches:
      - develop
      - master
    paths:
      - 'services/codec-converter/**'
      - 'services/codec-converter-worker/**'
      - 'infra/codec-converter/**'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/codec-converter.yaml'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1

jobs:
  # ============================================================================
  # Fast Verification Jobs (Run on Pull Requests)
  # ============================================================================
  
  lint:
    name: Lint Code
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: './package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Run lint on codec-converter
        run: npm run lint --workspace codec-converter --if-present

      - name: Run lint on codec-converter-worker
        run: npm run lint --workspace codec-converter-worker --if-present

  format-check:
    name: Format Check
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: './package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Check formatting on codec-converter
        run: npm run format:check --workspace codec-converter --if-present

      - name: Check formatting on codec-converter-worker
        run: npm run format:check --workspace codec-converter-worker --if-present

  type-check:
    name: Type Check
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: './package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Build shared libraries
        run: |
          npm run build --workspace @nagiyu/common --if-present
          npm run build --workspace @nagiyu/browser --if-present
          npm run build --workspace @nagiyu/ui --if-present

      - name: Type check codec-converter
        run: npx tsc --noEmit
        working-directory: ./services/codec-converter
        if: hashFiles('services/codec-converter/tsconfig.json') != ''

      - name: Type check codec-converter-worker
        run: npx tsc --noEmit
        working-directory: ./services/codec-converter-worker
        if: hashFiles('services/codec-converter-worker/tsconfig.json') != ''

  build:
    name: Build Verification
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: './package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Build shared libraries
        run: |
          npm run build --workspace @nagiyu/common --if-present
          npm run build --workspace @nagiyu/browser --if-present
          npm run build --workspace @nagiyu/ui --if-present

      - name: Build codec-converter
        run: npm run build --workspace codec-converter --if-present

      - name: Build codec-converter-worker
        run: npm run build --workspace codec-converter-worker --if-present

  test:
    name: Run Unit Tests
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: './package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Build shared libraries
        run: |
          npm run build --workspace @nagiyu/common --if-present
          npm run build --workspace @nagiyu/browser --if-present
          npm run build --workspace @nagiyu/ui --if-present

      - name: Run tests on codec-converter
        run: npm run test --workspace codec-converter --if-present

      - name: Run tests on codec-converter-worker
        run: npm run test --workspace codec-converter-worker --if-present

  docker-build:
    name: Docker Build Verification
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build codec-converter Docker image
        uses: docker/build-push-action@v5
        if: hashFiles('services/codec-converter/Dockerfile') != ''
        with:
          context: .
          file: services/codec-converter/Dockerfile
          push: false
          tags: codec-converter:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build codec-converter-worker Docker image
        uses: docker/build-push-action@v5
        if: hashFiles('services/codec-converter-worker/Dockerfile') != ''
        with:
          context: .
          file: services/codec-converter-worker/Dockerfile
          push: false
          tags: codec-converter-worker:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  report:
    name: Report Results to PR
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && always()
    needs: [lint, format-check, type-check, build, test, docker-build]

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Create PR Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const results = {
              'Lint': '${{ needs.lint.result }}',
              'Format Check': '${{ needs.format-check.result }}',
              'Type Check': '${{ needs.type-check.result }}',
              'Build': '${{ needs.build.result }}',
              'Unit Tests': '${{ needs.test.result }}',
              'Docker Build': '${{ needs.docker-build.result }}'
            };

            const statusEmoji = {
              'success': '✅',
              'failure': '❌',
              'cancelled': '⚠️',
              'skipped': '⏭️'
            };

            const allSuccess = Object.values(results).every(r => r === 'success');
            const header = allSuccess
              ? '## ✅ Codec Converter - All Checks Passed'
              : '## ❌ Codec Converter - Some Checks Failed';

            let body = `${header}\n\n`;
            body += '**Fast Verification Results**\n\n';
            body += '| Job | Status |\n';
            body += '|-----|--------|\n';

            for (const [job, result] of Object.entries(results)) {
              const emoji = statusEmoji[result] || '❓';
              body += `| ${job} | ${emoji} ${result} |\n`;
            }

            body += `\n[View workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId})`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # ============================================================================
  # Deployment Jobs (Run on Push to develop/master)
  # ============================================================================

  set-environment:
    name: Set Deployment Environment
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      stack-prefix: ${{ steps.set-env.outputs.stack-prefix }}

    steps:
      - name: Determine environment
        id: set-env
        run: |
          if [[ "$GITHUB_REF" == 'refs/heads/master' ]]; then
            echo "environment=prod" >> "$GITHUB_OUTPUT"
            echo "stack-prefix=nagiyu-codec-converter-prod" >> "$GITHUB_OUTPUT"
          else
            echo "environment=dev" >> "$GITHUB_OUTPUT"
            echo "stack-prefix=nagiyu-codec-converter-dev" >> "$GITHUB_OUTPUT"
          fi
          echo "Deploying to environment: $(cat $GITHUB_OUTPUT | grep environment | cut -d= -f2)"

  deploy-infrastructure:
    name: Deploy Infrastructure
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    needs: set-environment

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy CloudFormation stack
        env:
          STACK_NAME: ${{ needs.set-environment.outputs.stack-prefix }}
          ENVIRONMENT: ${{ needs.set-environment.outputs.environment }}
        run: |
          if [ -f "infra/codec-converter/template.yaml" ]; then
            echo "Deploying infrastructure stack: $STACK_NAME"
            
            aws cloudformation deploy \
              --template-file infra/codec-converter/template.yaml \
              --stack-name "$STACK_NAME" \
              --parameter-overrides Environment="$ENVIRONMENT" \
              --capabilities CAPABILITY_NAMED_IAM \
              --region "${{ env.AWS_REGION }}" \
              --no-fail-on-empty-changeset
            
            echo "Infrastructure deployment completed"
          else
            echo "No CloudFormation template found at infra/codec-converter/template.yaml"
            echo "Skipping infrastructure deployment"
          fi

      - name: Verify stack outputs
        env:
          STACK_NAME: ${{ needs.set-environment.outputs.stack-prefix }}
        run: |
          if aws cloudformation describe-stacks --stack-name "$STACK_NAME" --region "${{ env.AWS_REGION }}" > /dev/null 2>&1; then
            echo "Stack outputs:"
            aws cloudformation describe-stacks \
              --stack-name "$STACK_NAME" \
              --query "Stacks[0].Outputs" \
              --region "${{ env.AWS_REGION }}" \
              --output table
          else
            echo "Stack not found or not deployed yet"
          fi

  build-and-push-images:
    name: Build and Push Docker Images
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    needs: [set-environment, deploy-infrastructure]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Get ECR repository URIs from CloudFormation
        id: get-ecr
        env:
          STACK_NAME: ${{ needs.set-environment.outputs.stack-prefix }}
        run: |
          # Try to get ECR repository URIs from CloudFormation outputs
          if aws cloudformation describe-stacks --stack-name "$STACK_NAME" --region "${{ env.AWS_REGION }}" > /dev/null 2>&1; then
            API_REPO=$(aws cloudformation describe-stacks \
              --stack-name "$STACK_NAME" \
              --query "Stacks[0].Outputs[?OutputKey=='ApiRepositoryUri'].OutputValue" \
              --output text \
              --region "${{ env.AWS_REGION }}")
            
            WORKER_REPO=$(aws cloudformation describe-stacks \
              --stack-name "$STACK_NAME" \
              --query "Stacks[0].Outputs[?OutputKey=='WorkerRepositoryUri'].OutputValue" \
              --output text \
              --region "${{ env.AWS_REGION }}")
            
            if [ -n "$API_REPO" ]; then
              echo "api-repository=$API_REPO" >> "$GITHUB_OUTPUT"
              echo "API ECR Repository: $API_REPO"
            fi
            
            if [ -n "$WORKER_REPO" ]; then
              echo "worker-repository=$WORKER_REPO" >> "$GITHUB_OUTPUT"
              echo "Worker ECR Repository: $WORKER_REPO"
            fi
          else
            echo "CloudFormation stack not found, skipping ECR repository lookup"
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push codec-converter API image
        if: steps.get-ecr.outputs.api-repository != '' && hashFiles('services/codec-converter/Dockerfile') != ''
        uses: docker/build-push-action@v5
        with:
          context: .
          file: services/codec-converter/Dockerfile
          push: true
          tags: |
            ${{ steps.get-ecr.outputs.api-repository }}:${{ github.sha }}
            ${{ steps.get-ecr.outputs.api-repository }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push codec-converter worker image
        if: steps.get-ecr.outputs.worker-repository != '' && hashFiles('services/codec-converter-worker/Dockerfile') != ''
        uses: docker/build-push-action@v5
        with:
          context: .
          file: services/codec-converter-worker/Dockerfile
          push: true
          tags: |
            ${{ steps.get-ecr.outputs.worker-repository }}:${{ github.sha }}
            ${{ steps.get-ecr.outputs.worker-repository }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-services:
    name: Deploy Services
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    needs: [set-environment, deploy-infrastructure, build-and-push-images]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update Lambda function
        env:
          STACK_NAME: ${{ needs.set-environment.outputs.stack-prefix }}
        run: |
          if aws cloudformation describe-stacks --stack-name "$STACK_NAME" --region "${{ env.AWS_REGION }}" > /dev/null 2>&1; then
            # Get Lambda function name from CloudFormation
            FUNCTION_NAME=$(aws cloudformation describe-stacks \
              --stack-name "$STACK_NAME" \
              --query "Stacks[0].Outputs[?OutputKey=='ApiFunctionName'].OutputValue" \
              --output text \
              --region "${{ env.AWS_REGION }}")
            
            if [ -n "$FUNCTION_NAME" ]; then
              echo "Updating Lambda function: $FUNCTION_NAME"
              
              # Get ECR repository URI
              API_REPO=$(aws cloudformation describe-stacks \
                --stack-name "$STACK_NAME" \
                --query "Stacks[0].Outputs[?OutputKey=='ApiRepositoryUri'].OutputValue" \
                --output text \
                --region "${{ env.AWS_REGION }}")
              
              if [ -n "$API_REPO" ]; then
                aws lambda update-function-code \
                  --function-name "$FUNCTION_NAME" \
                  --image-uri "$API_REPO:${{ github.sha }}" \
                  --region "${{ env.AWS_REGION }}"
                
                # Wait for update to complete
                aws lambda wait function-updated \
                  --function-name "$FUNCTION_NAME" \
                  --region "${{ env.AWS_REGION }}"
                
                echo "Lambda function updated successfully"
              fi
            else
              echo "No Lambda function found in stack outputs"
            fi
          else
            echo "CloudFormation stack not found, skipping Lambda update"
          fi

      - name: Update Batch job definition
        env:
          STACK_NAME: ${{ needs.set-environment.outputs.stack-prefix }}
        run: |
          if aws cloudformation describe-stacks --stack-name "$STACK_NAME" --region "${{ env.AWS_REGION }}" > /dev/null 2>&1; then
            # Get Batch job definition ARN from CloudFormation
            JOB_DEF_ARN=$(aws cloudformation describe-stacks \
              --stack-name "$STACK_NAME" \
              --query "Stacks[0].Outputs[?OutputKey=='BatchJobDefinitionArn'].OutputValue" \
              --output text \
              --region "${{ env.AWS_REGION }}")
            
            if [ -n "$JOB_DEF_ARN" ]; then
              echo "Batch job definition is managed by CloudFormation: $JOB_DEF_ARN"
              echo "Job definition will be updated on next stack deployment"
            else
              echo "No Batch job definition found in stack outputs"
            fi
          else
            echo "CloudFormation stack not found, skipping Batch job definition update"
          fi

      - name: Deployment summary
        env:
          STACK_NAME: ${{ needs.set-environment.outputs.stack-prefix }}
          ENVIRONMENT: ${{ needs.set-environment.outputs.environment }}
        run: |
          echo "=== Deployment Summary ==="
          echo "Environment: $ENVIRONMENT"
          echo "Stack Name: $STACK_NAME"
          echo "Commit SHA: ${{ github.sha }}"
          echo ""
          
          if aws cloudformation describe-stacks --stack-name "$STACK_NAME" --region "${{ env.AWS_REGION }}" > /dev/null 2>&1; then
            echo "Stack Status:"
            aws cloudformation describe-stacks \
              --stack-name "$STACK_NAME" \
              --query "Stacks[0].{Status:StackStatus,Updated:LastUpdatedTime}" \
              --region "${{ env.AWS_REGION }}" \
              --output table
            
            echo ""
            echo "Key Outputs:"
            aws cloudformation describe-stacks \
              --stack-name "$STACK_NAME" \
              --query "Stacks[0].Outputs[?contains(OutputKey, 'Url') || contains(OutputKey, 'Uri')]" \
              --region "${{ env.AWS_REGION }}" \
              --output table
          else
            echo "CloudFormation stack not found"
          fi
